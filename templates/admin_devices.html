<!-- templates/admin_devices.html - Admin Devices Management -->
{% extends "admin_base.html" %}

{% block title %}Devices{% endblock %}
{% block page_title %}Device Management{% endblock %}

{% block header_actions %}
<button class="admin-header-btn admin-header-btn-secondary" onclick="refreshDevices()">
    Refresh
</button>
{% endblock %}

{% block extra_styles %}
<style>
    .device-type-icon {
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: rgba(16, 185, 129, 0.1);
    }

    .device-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .device-name {
        font-weight: 500;
    }

    .device-id {
        color: #64748b;
        font-size: 0.8rem;
        font-family: monospace;
    }

    .owner-cell {
        display: flex;
        flex-direction: column;
    }

    .owner-email {
        font-size: 0.85rem;
    }

    .action-buttons {
        display: flex;
        gap: 0.35rem;
        flex-wrap: wrap;
    }

    /* Live data section */
    .live-data-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    .live-data-title {
        color: #10b981;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .live-data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 0.75rem;
    }

    .live-data-item {
        background: #0f172a;
        padding: 0.75rem;
        border-radius: 6px;
        text-align: center;
    }

    .live-data-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: #10b981;
    }

    .live-data-label {
        font-size: 0.7rem;
        color: #64748b;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<!-- Stats Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-card-value" id="total-devices">-</div>
        <div class="stat-card-label">Total Devices</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-value" id="online-devices" style="color: #10b981;">-</div>
        <div class="stat-card-label">Online</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-value" id="offline-devices" style="color: #ef4444;">-</div>
        <div class="stat-card-label">Offline</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-value" id="device-types">-</div>
        <div class="stat-card-label">Device Types</div>
    </div>
</div>

<!-- Devices Table -->
<div class="data-table-container">
    <div class="data-table-header">
        <div class="data-table-title">All Devices</div>
        <div class="data-table-filters">
            <input type="text" class="data-table-search" id="device-search" placeholder="Search devices or owners...">
            <select class="data-table-select" id="type-filter">
                <option value="">All Types</option>
                <option value="doser">Doser</option>
                <option value="environmental">Environmental</option>
                <option value="valve_controller">Valve Controller</option>
            </select>
            <select class="data-table-select" id="status-filter">
                <option value="">All Status</option>
                <option value="online">Online</option>
                <option value="offline">Offline</option>
            </select>
        </div>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>Device</th>
                <th>Owner</th>
                <th>Type</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th>Plant</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="devices-table-body">
            <tr>
                <td colspan="7" class="loading">
                    <div class="loading-spinner"></div>
                    <div style="margin-top: 0.5rem;">Loading devices...</div>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="data-table-footer">
        <span id="table-info">Loading...</span>
        <div class="pagination" id="pagination"></div>
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Device Details Modal -->
<div class="modal" id="device-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-device-name">Device Details</h2>
            <button class="modal-close" onclick="closeModal('device-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="detail-grid" id="device-details">
                <!-- Populated by JS -->
            </div>

            <div class="live-data-section" id="live-data-section" style="display: none;">
                <div class="live-data-title">Live Data</div>
                <div class="live-data-grid" id="live-data-grid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('device-modal')">Close</button>
            <button class="btn btn-primary" onclick="openSettingsModal()">Settings</button>
        </div>
    </div>
</div>

<!-- Device Settings Modal -->
<div class="modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Device Settings</h2>
            <button class="modal-close" onclick="closeModal('settings-modal')">&times;</button>
        </div>
        <form id="settings-form">
            <div class="modal-body">
                <input type="hidden" id="settings-device-id">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Heartbeat Interval (seconds)</label>
                        <input type="number" class="form-input" id="settings-update-interval" min="5" max="3600" value="30">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Log Interval (seconds)</label>
                        <input type="number" class="form-input" id="settings-log-interval" min="60" max="86400" value="3600">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="settings-fahrenheit" style="margin-right: 0.5rem;">
                        Use Fahrenheit
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('settings-modal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </div>
        </form>
    </div>
</div>

<!-- Debug Logs Modal -->
<div class="modal" id="logs-modal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h2 class="modal-title">Debug Logs - <span id="logs-device-name"></span></h2>
            <button class="modal-close" onclick="closeModal('logs-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="logs-device-id">

            <!-- Request New Log Section -->
            <div style="background: #1e293b; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h3 style="color: #10b981; margin-bottom: 1rem; font-size: 1rem;">Request New Log Capture</h3>
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label" style="margin-bottom: 0.25rem;">Duration (seconds)</label>
                        <input type="number" class="form-input" id="log-duration" min="1" max="600" value="60" style="width: 120px;">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="requestLog()" id="request-log-btn">
                        Request Log
                    </button>
                    <span id="log-request-status" style="color: #64748b; font-size: 0.9rem;"></span>
                </div>
                <p style="color: #64748b; font-size: 0.8rem; margin-top: 0.5rem; margin-bottom: 0;">
                    Device must be online. Max duration: 600 seconds (10 minutes).
                </p>
            </div>

            <!-- Previous Logs Section -->
            <h3 style="color: #e2e8f0; margin-bottom: 1rem; font-size: 1rem;">Previous Logs</h3>
            <div id="logs-list" style="max-height: 400px; overflow-y: auto;">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Loading logs...
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('logs-modal')">Close</button>
            <button type="button" class="btn btn-primary" onclick="refreshLogs()">Refresh</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
let allDevices = [];
let currentPage = 1;
const pageSize = 20;
let currentDeviceId = null;

// Load devices
async function loadDevices() {
    try {
        const response = await fetch('/admin/all-devices');
        if (response.ok) {
            allDevices = await response.json();
            updateStats();
            renderDevices();
        }
    } catch (error) {
        console.error('Error loading devices:', error);
        document.getElementById('devices-table-body').innerHTML = `
            <tr><td colspan="7" class="empty-state">Error loading devices</td></tr>
        `;
    }
}

function updateStats() {
    const online = allDevices.filter(d => d.is_online).length;
    const types = new Set(allDevices.map(d => d.device_type)).size;

    document.getElementById('total-devices').textContent = allDevices.length;
    document.getElementById('online-devices').textContent = online;
    document.getElementById('offline-devices').textContent = allDevices.length - online;
    document.getElementById('device-types').textContent = types;
}

function getDeviceIcon(type) {
    const icons = {
        'doser': 'üíß',
        'environmental': 'üå°Ô∏è',
        'valve_controller': 'üö∞',
        'unknown': 'üì±'
    };
    return icons[type] || icons['unknown'];
}

function renderDevices() {
    const searchTerm = document.getElementById('device-search').value.toLowerCase();
    const typeFilter = document.getElementById('type-filter').value;
    const statusFilter = document.getElementById('status-filter').value;

    let filtered = allDevices.filter(device => {
        const matchesSearch = !searchTerm ||
            (device.name || '').toLowerCase().includes(searchTerm) ||
            device.device_id.toLowerCase().includes(searchTerm) ||
            device.owner_email.toLowerCase().includes(searchTerm);

        const matchesType = !typeFilter || device.device_type === typeFilter;
        const matchesStatus = !statusFilter ||
            (statusFilter === 'online' && device.is_online) ||
            (statusFilter === 'offline' && !device.is_online);

        return matchesSearch && matchesType && matchesStatus;
    });

    // Pagination
    const totalPages = Math.ceil(filtered.length / pageSize);
    const start = (currentPage - 1) * pageSize;
    const pageDevices = filtered.slice(start, start + pageSize);

    const tbody = document.getElementById('devices-table-body');

    if (pageDevices.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="7" class="empty-state">
                <div class="empty-state-icon">üì±</div>
                No devices found
            </td></tr>
        `;
    } else {
        tbody.innerHTML = pageDevices.map(device => `
            <tr data-device-id="${device.device_id}">
                <td>
                    <div class="device-info">
                        <div class="device-type-icon">${getDeviceIcon(device.device_type)}</div>
                        <div>
                            <div class="device-name">${device.name || 'Unnamed'}</div>
                            <div class="device-id">${device.device_id.substring(0, 8)}...</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="owner-cell">
                        <span class="owner-email">${device.owner_email}</span>
                    </div>
                </td>
                <td>
                    <span class="badge badge-info">${device.device_type || 'unknown'}</span>
                </td>
                <td>
                    ${device.is_online
                        ? '<span class="badge badge-success">Online</span>'
                        : '<span class="badge badge-danger">Offline</span>'}
                </td>
                <td>
                    ${device.last_seen ? formatDateTime(device.last_seen) : '-'}
                </td>
                <td>
                    ${device.active_plant_name
                        ? `<span title="${device.active_phase || ''}">${device.active_plant_name}</span>`
                        : '<span style="color: #64748b;">-</span>'}
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn action-btn-primary" onclick="viewDevice('${device.device_id}')" title="View details">
                            üëÅÔ∏è
                        </button>
                        <button class="action-btn action-btn-warning" onclick="viewDeviceSettings('${device.device_id}')" title="Settings">
                            ‚öôÔ∏è
                        </button>
                        <button class="action-btn action-btn-info" onclick="viewDeviceData('${device.device_id}')" title="View data">
                            üìä
                        </button>
                        <button class="action-btn action-btn-secondary" onclick="viewDeviceLogs('${device.device_id}')" title="Debug logs">
                            üìã
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Update info
    document.getElementById('table-info').textContent =
        `Showing ${start + 1}-${Math.min(start + pageSize, filtered.length)} of ${filtered.length} devices`;

    // Render pagination
    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    const pagination = document.getElementById('pagination');
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '';
    html += `<button class="pagination-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&lt;</button>`;

    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
            html += `<span style="padding: 0.5rem;">...</span>`;
        }
    }

    html += `<button class="pagination-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&gt;</button>`;
    pagination.innerHTML = html;
}

function goToPage(page) {
    const totalPages = Math.ceil(allDevices.length / pageSize);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderDevices();
    }
}

// Filter event listeners
document.getElementById('device-search').addEventListener('input', debounce(() => {
    currentPage = 1;
    renderDevices();
}, 300));

document.getElementById('type-filter').addEventListener('change', () => {
    currentPage = 1;
    renderDevices();
});

document.getElementById('status-filter').addEventListener('change', () => {
    currentPage = 1;
    renderDevices();
});

// Modal functions
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'block';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

async function viewDevice(deviceId) {
    currentDeviceId = deviceId;
    const device = allDevices.find(d => d.device_id === deviceId);
    if (!device) return;

    document.getElementById('modal-device-name').textContent = device.name || 'Unnamed Device';

    // Hide live data section by default
    document.getElementById('live-data-section').style.display = 'none';

    // Set basic device info immediately
    let logCount = '-';
    let envLogCount = '-';

    // Try to load additional details
    try {
        const response = await fetch(`/admin/devices/${deviceId}/data/summary`);
        if (response.ok) {
            const data = await response.json();
            logCount = formatNumber(data.log_entries?.total_count || 0);
            envLogCount = formatNumber(data.environment_logs?.total_count || 0);

            // Load live data for environmental sensors
            if (device.device_type === 'environmental' && device.is_online) {
                loadLiveData(deviceId);
            }
        }
    } catch (error) {
        console.error('Error loading device details:', error);
    }

    // Always populate the modal with available info
    document.getElementById('device-details').innerHTML = `
        <div class="detail-item">
            <div class="detail-label">Device ID</div>
            <div class="detail-value mono">${deviceId}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Type</div>
            <div class="detail-value">${device.device_type || 'Unknown'}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Owner</div>
            <div class="detail-value">${device.owner_email}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Status</div>
            <div class="detail-value">${device.is_online ? 'üü¢ Online' : 'üî¥ Offline'}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Log Entries</div>
            <div class="detail-value">${logCount}</div>
        </div>
        <div class="detail-item">
            <div class="detail-label">Environment Logs</div>
            <div class="detail-value">${envLogCount}</div>
        </div>
    `;

    openModal('device-modal');
}

async function loadLiveData(deviceId) {
    try {
        const response = await fetch(`/api/devices/${deviceId}/environment/latest`);
        if (response.ok) {
            const data = await response.json();
            const section = document.getElementById('live-data-section');
            const grid = document.getElementById('live-data-grid');

            section.style.display = 'block';
            grid.innerHTML = `
                ${data.temperature !== undefined ? `
                <div class="live-data-item">
                    <div class="live-data-value">${data.temperature?.toFixed(1) || '-'}¬∞</div>
                    <div class="live-data-label">Temp</div>
                </div>` : ''}
                ${data.humidity !== undefined ? `
                <div class="live-data-item">
                    <div class="live-data-value">${data.humidity?.toFixed(1) || '-'}%</div>
                    <div class="live-data-label">Humidity</div>
                </div>` : ''}
                ${data.co2 !== undefined ? `
                <div class="live-data-item">
                    <div class="live-data-value">${data.co2 || '-'}</div>
                    <div class="live-data-label">CO2</div>
                </div>` : ''}
                ${data.vpd !== undefined ? `
                <div class="live-data-item">
                    <div class="live-data-value">${data.vpd?.toFixed(2) || '-'}</div>
                    <div class="live-data-label">VPD</div>
                </div>` : ''}
            `;
        }
    } catch (error) {
        console.error('Error loading live data:', error);
    }
}

async function viewDeviceSettings(deviceId) {
    currentDeviceId = deviceId;
    document.getElementById('settings-device-id').value = deviceId;

    try {
        const response = await fetch(`/admin/devices/${deviceId}/heartbeat-settings`);
        if (response.ok) {
            const settings = await response.json();
            document.getElementById('settings-update-interval').value = settings.update_interval || 30;
            document.getElementById('settings-log-interval').value = settings.log_interval || 3600;
            document.getElementById('settings-fahrenheit').checked = settings.use_fahrenheit || false;
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }

    openModal('settings-modal');
}

function openSettingsModal() {
    closeModal('device-modal');
    viewDeviceSettings(currentDeviceId);
}

document.getElementById('settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const deviceId = document.getElementById('settings-device-id').value;

    const params = new URLSearchParams({
        update_interval: document.getElementById('settings-update-interval').value,
        log_interval: document.getElementById('settings-log-interval').value,
        use_fahrenheit: document.getElementById('settings-fahrenheit').checked
    });

    try {
        const response = await fetch(`/admin/devices/${deviceId}/heartbeat-settings?${params}`, {
            method: 'PUT'
        });

        if (response.ok) {
            closeModal('settings-modal');
            alert('Settings saved. Changes will apply on next device heartbeat.');
        } else {
            const error = await response.json();
            alert('Failed to save settings: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error saving settings:', error);
        alert('Failed to save settings');
    }
});

function viewDeviceData(deviceId) {
    // Open device data in new tab or modal
    window.open(`/admin/overview?device=${deviceId}`, '_blank');
}

function refreshDevices() {
    loadDevices();
}

// ==============================
// Debug Logs Modal Functions
// ==============================

let currentLogsDeviceId = null;

async function viewDeviceLogs(deviceId) {
    currentLogsDeviceId = deviceId;
    const device = allDevices.find(d => d.device_id === deviceId);

    document.getElementById('logs-device-id').value = deviceId;
    document.getElementById('logs-device-name').textContent = device?.name || deviceId.substring(0, 8) + '...';
    document.getElementById('log-request-status').textContent = '';

    // Enable/disable request button based on device status
    const requestBtn = document.getElementById('request-log-btn');
    if (device?.is_online) {
        requestBtn.disabled = false;
        requestBtn.title = '';
    } else {
        requestBtn.disabled = true;
        requestBtn.title = 'Device is offline';
    }

    openModal('logs-modal');
    await loadLogs(deviceId);
}

async function loadLogs(deviceId) {
    const listEl = document.getElementById('logs-list');
    listEl.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading logs...</div>';

    try {
        const response = await fetch(`/admin/devices/${deviceId}/logs`);
        if (!response.ok) throw new Error('Failed to load logs');

        const data = await response.json();
        renderLogs(data.logs);
    } catch (error) {
        console.error('Error loading logs:', error);
        listEl.innerHTML = '<div class="empty-state">Error loading logs</div>';
    }
}

function renderLogs(logs) {
    const listEl = document.getElementById('logs-list');

    if (!logs || logs.length === 0) {
        listEl.innerHTML = '<div class="empty-state" style="padding: 2rem; text-align: center; color: #64748b;">No debug logs captured yet</div>';
        return;
    }

    listEl.innerHTML = `
        <table class="data-table" style="margin: 0;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Duration</th>
                    <th>Size</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${logs.map(log => `
                    <tr>
                        <td>
                            <div style="font-size: 0.85rem;">${formatDateTime(log.requested_at)}</div>
                            ${log.early_cutoff_reason ? `<div style="font-size: 0.75rem; color: #f59e0b;">${log.early_cutoff_reason}</div>` : ''}
                        </td>
                        <td>
                            ${log.actual_duration !== null ? log.actual_duration + 's' : '-'}
                            ${log.actual_duration !== null && log.actual_duration < log.requested_duration ? `<span style="color: #64748b;">/${log.requested_duration}s</span>` : ''}
                        </td>
                        <td>${log.file_size ? formatFileSize(log.file_size) : '-'}</td>
                        <td>
                            ${getLogStatusBadge(log.status)}
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${log.status === 'completed' ? `
                                    <button class="action-btn action-btn-primary" onclick="downloadLog(${log.id})" title="Download">
                                        ‚¨áÔ∏è
                                    </button>
                                ` : ''}
                                <button class="action-btn action-btn-danger" onclick="deleteLog(${log.id})" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

function getLogStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge badge-warning">Pending</span>',
        'capturing': '<span class="badge badge-info">Capturing...</span>',
        'completed': '<span class="badge badge-success">Completed</span>',
        'failed': '<span class="badge badge-danger">Failed</span>'
    };
    return badges[status] || `<span class="badge">${status}</span>`;
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

async function requestLog() {
    const deviceId = document.getElementById('logs-device-id').value;
    const duration = parseInt(document.getElementById('log-duration').value) || 60;
    const statusEl = document.getElementById('log-request-status');
    const btn = document.getElementById('request-log-btn');

    if (duration < 1 || duration > 600) {
        statusEl.textContent = 'Duration must be between 1 and 600 seconds';
        statusEl.style.color = '#ef4444';
        return;
    }

    btn.disabled = true;
    statusEl.textContent = 'Requesting log capture...';
    statusEl.style.color = '#64748b';

    try {
        const response = await fetch(`/admin/devices/${deviceId}/logs/request?duration=${duration}`, {
            method: 'POST'
        });

        if (response.ok) {
            statusEl.textContent = 'Log capture started! Refresh to see status.';
            statusEl.style.color = '#10b981';
            // Reload logs list after a short delay
            setTimeout(() => loadLogs(deviceId), 1000);
        } else {
            const error = await response.json();
            statusEl.textContent = error.detail || 'Failed to request log';
            statusEl.style.color = '#ef4444';
        }
    } catch (error) {
        console.error('Error requesting log:', error);
        statusEl.textContent = 'Error requesting log';
        statusEl.style.color = '#ef4444';
    }

    // Re-enable button after a delay
    setTimeout(() => {
        btn.disabled = false;
        const device = allDevices.find(d => d.device_id === deviceId);
        if (!device?.is_online) btn.disabled = true;
    }, 2000);
}

async function downloadLog(logId) {
    const deviceId = document.getElementById('logs-device-id').value;
    window.open(`/admin/devices/${deviceId}/logs/${logId}/download`, '_blank');
}

async function deleteLog(logId) {
    if (!confirm('Are you sure you want to delete this log?')) return;

    const deviceId = document.getElementById('logs-device-id').value;

    try {
        const response = await fetch(`/admin/devices/${deviceId}/logs/${logId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            loadLogs(deviceId);
        } else {
            const error = await response.json();
            alert('Failed to delete log: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting log:', error);
        alert('Error deleting log');
    }
}

function refreshLogs() {
    if (currentLogsDeviceId) {
        loadLogs(currentLogsDeviceId);
    }
}

// Close modals on backdrop click
// Close modal when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
});

// Initial load
loadDevices();
{% endblock %}
