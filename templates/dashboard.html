<!-- templates/dashboard.html - Placeholder for non-admin user dashboard -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Basic styling for data display */
        .data-item {
            margin-bottom: 10px;
        }
        .data-label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Welcome, {{ user.email }}</h1>
    <p>Your DWC system data will be shown here soon.</p>
    <a href="/auth/logout">Logout</a>

    <!-- Added: Add Device form -->
    <h2>Add Device</h2>
    <form id="add-device-form">
        <label for="device_id">Device ID (from Pi):</label>
        <input type="text" id="device_id" required>
        <br>
        <label for="name">Device Name (optional):</label>
        <input type="text" id="name">
        <br>
        <button type="submit">Add Device</button>
    </form>
    <div id="add-result"></div>

    <!-- Added: Devices list -->
    <h2>My Devices</h2>
    <div id="devices-list"></div>

    <script>
        // Fetch and display devices list
        async function fetchDevices() {
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const listDiv = document.getElementById('devices-list');
                listDiv.innerHTML = '';
                devices.forEach(device => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.innerHTML = `
                        <p>${device.name || device.device_id} - Online: ${device.is_online ? 'Yes' : 'No'}</p>
                        <button onclick="connectToDevice('${device.device_id}')">Connect</button>
                        <div id="control-${device.device_id}" style="display:none;">
                            <h3>Controls</h3>
                            <div class="data-item"><span class="data-label">System Name:</span> <span id="system-name-${device.device_id}">Loading...</span></div>
                            <div class="data-item"><span class="data-label">pH:</span> <span id="ph-${device.device_id}">Loading...</span></div>
                            <div class="data-item"><span class="data-label">EC:</span> <span id="ec-${device.device_id}">Loading...</span></div>
                            <div class="data-item"><span class="data-label">Sensor 1:</span> <span id="sensor1-${device.device_id}">Loading...</span></div>
                            <div class="data-item"><span class="data-label">Sensor 2:</span> <span id="sensor2-${device.device_id}">Loading...</span></div>
                            <div class="data-item"><span class="data-label">Sensor 3:</span> <span id="sensor3-${device.device_id}">Loading...</span></div>
                            <div class="data-item"><span class="data-label">Fill Valve:</span> <span id="fill-valve-${device.device_id}">Loading...</span></div>
                            <div class="data-item"><span class="data-label">Drain Valve:</span> <span id="drain-valve-${device.device_id}">Loading...</span></div>
                            <button onclick="sendDose('${device.device_id}', 'up', 10)">Dose pH Up (10ml)</button>
                            <button onclick="sendDose('${device.device_id}', 'down', 10)">Dose pH Down (10ml)</button>
                            <!-- Add more index controls here, e.g., <button onclick="sendCommand('${device.device_id}', 'toggle_pump')">Toggle Pump</button> -->
                        </div>
                    `;
                    listDiv.appendChild(deviceDiv);
                });
            }
        }

        // Connect to WS for a device
        let wsMap = {};  // Store WS per device_id
        function connectToDevice(device_id) {
            if (wsMap[device_id]) return;  // Already connected
            const ws = new WebSocket(`wss://${window.location.host}/ws/user/devices/${device_id}`);
            ws.onopen = () => {
                console.log(`Connected to ${device_id}`);
                document.getElementById(`control-${device.device_id}`).style.display = 'block';
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log(`Received from server for ${device_id}:`, data);  // Log to browser console
                if (data.type === 'ph_update') {
                    document.getElementById(`ph-${device.device_id}`).innerHTML = data.ph;
                } else if (data.type === 'status_update' && data.data) {
                    // Handle full status data
                    const statusData = data.data;
                    document.getElementById(`system-name-${device.device_id}`).innerHTML = statusData.settings.system_name || 'N/A';
                    document.getElementById(`ph-${device.device_id}`).innerHTML = statusData.current_ph || 'N/A';
                    document.getElementById(`ec-${device.device_id}`).innerHTML = statusData.current_ec || 'N/A';
                    // Sensors (assuming water_level has sensor1, sensor2, sensor3 with status like "on/off")
                    const water = statusData.water_level || {};
                    document.getElementById(`sensor1-${device.device_id}`).innerHTML = water.sensor1?.status || 'N/A';
                    document.getElementById(`sensor2-${device.device_id}`).innerHTML = water.sensor2?.status || 'N/A';
                    document.getElementById(`sensor3-${device.device_id}`).innerHTML = water.sensor3?.status || 'N/A';
                    // Valves (fill and drain statuses)
                    const valves = statusData.valve_info?.valve_relays || {};
                    document.getElementById(`fill-valve-${device.device_id}`).innerHTML = valves['Fill Valve']?.status || 'N/A';  // Adjust label if different
                    document.getElementById(`drain-valve-${device.device_id}`).innerHTML = valves['Drain Valve']?.status || 'N/A';  // Adjust label if different
                }
                // Add handlers for other updates
            };
            ws.onclose = () => {
                console.log(`Disconnected from ${device_id}`);
                delete wsMap[device_id];
            };
            wsMap[device_id] = ws;
        }

        // Send dose command
        function sendDose(device_id, dispense_type, amount) {
            const ws = wsMap[device_id];
            if (ws) {
                ws.send(JSON.stringify({
                    command: 'manual_dose',
                    params: { dispense_type: dispense_type, amount: amount }
                }));
            }
        }

        // Send other commands (example)
        function sendCommand(device_id, command) {
            const ws = wsMap[device_id];
            if (ws) {
                ws.send(JSON.stringify({ command: command }));
            }
        }

        // Add form submit
        document.getElementById('add-device-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const device_id = document.getElementById('device_id').value;
            const name = document.getElementById('name').value;
            const response = await fetch('/user/devices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_id: device_id, name: name })
            });
            const resultDiv = document.getElementById('add-result');
            if (response.ok) {
                const data = await response.json();
                resultDiv.innerHTML = `Device added! API Key: ${data.api_key} (copy to Pi settings.json as "api_key")`;
                fetchDevices();  // Reload list
            } else {
                const error = await response.json();
                resultDiv.innerHTML = `Error: ${error.detail}`;
            }
        });

        // Load devices on page load
        window.onload = fetchDevices;

        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };
    </script>
</body>
</html>