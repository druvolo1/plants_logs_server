<!-- templates/dashboard.html - Show statuses for all devices -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Simple styling for data sections */
        .device-section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .valve-controls {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .valve-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .valve-buttons {
            display: flex;
            gap: 5px;
        }
        .valve-buttons button, .dose-button {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background: #333;
            color: #fff;
        }
        .dose-button {
            background: #007bff;
            border-color: #007bff;
            margin-top: 5px;
        }
        .dose-button:hover {
            background: #0056b3;
        }
        .dose-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-on-active {
            background: #28a745 !important;
            border-color: #28a745 !important;
        }
        .btn-off-active {
            background: #dc3545 !important;
            border-color: #dc3545 !important;
        }
        .btn-inactive {
            opacity: 0.5;
        }
        .dosing-controls {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .dose-container {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #2a2a2a;
            border-radius: 5px;
            flex-wrap: wrap;
        }
        .dose-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 200px;
        }
        .dose-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        .manual-input {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-top: 5px;
        }
        .manual-input input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #1a1a1a;
            color: #fff;
        }
        .manual-input button {
            padding: 4px 12px;
            font-size: 0.9em;
        }
        /* Water bucket visualization */
        .water-bucket {
            width: 80px;
            height: 120px;
            border: 3px solid #666;
            border-top: none;
            border-radius: 0 0 10px 10px;
            position: relative;
            background: linear-gradient(to top, #1a1a1a 0%, #2a2a2a 100%);
            display: inline-block;
            margin: 10px 20px;
        }
        .water-level {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #1e90ff 0%, #4da6ff 100%);
            transition: height 0.3s ease;
            border-radius: 0 0 7px 7px;
        }
        .sensor-marker {
            position: absolute;
            left: -15px;
            right: -15px;
            height: 2px;
            background: #fff;
        }
        .sensor-label {
            position: absolute;
            right: -60px;
            font-size: 0.75em;
            white-space: nowrap;
        }
        .sensor-full { top: 10%; }
        .sensor-low { top: 50%; }
        .sensor-empty { bottom: 5%; }
        .bucket-container {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Welcome, {{ user.email }}</h1>
    <a href="/auth/logout">Logout</a>
    <a href="/devices">Manage Devices</a>

    <h2>My Devices Statuses</h2>
    <div id="devices-status"></div>

    <script>
        let wsMap = {};  // Store WS per device_id

        // Fetch devices and auto-connect WS for each
        async function fetchAndConnectDevices() {
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const statusDiv = document.getElementById('devices-status');
                statusDiv.innerHTML = '';
                devices.forEach(device => {
                    const deviceSection = document.createElement('div');
                    deviceSection.classList.add('device-section');
                    deviceSection.innerHTML = `
                        <h3>${device.name || device.device_id} - Online: ${device.is_online ? 'Yes' : 'No'}</h3>
                        <div class="data-row"><span>System Name:</span> <span id="system-name-${device.device_id}">Loading...</span></div>
                        <div class="data-row"><span>pH:</span> <span id="ph-${device.device_id}">Loading...</span></div>
                        <div class="data-row"><span>EC:</span> <span id="ec-${device.device_id}">Loading...</span></div>
                        <div class="bucket-container">
                            <div class="water-bucket" id="bucket-${device.device_id}">
                                <div class="water-level" id="water-level-${device.device_id}"></div>
                                <div class="sensor-marker sensor-full">
                                    <span class="sensor-label" id="sensor1-label-${device.device_id}">Full</span>
                                </div>
                                <div class="sensor-marker sensor-low">
                                    <span class="sensor-label" id="sensor2-label-${device.device_id}">Low</span>
                                </div>
                                <div class="sensor-marker sensor-empty">
                                    <span class="sensor-label" id="sensor3-label-${device.device_id}">Empty</span>
                                </div>
                            </div>
                        </div>
                        <div class="valve-controls" id="valve-controls-${device.device_id}"></div>
                        <div class="dosing-controls" id="dosing-controls-${device.device_id}"></div>
                        <button id="refresh-${device.device_id}">Refresh</button>
                    `;
                    statusDiv.appendChild(deviceSection);

                    // Wire up the refresh button click
                    document.getElementById(`refresh-${device.device_id}`).addEventListener('click', () => {
                        const ws = wsMap[device.device_id];
                        if (ws) {
                            console.log(`[Refresh] Requesting refresh for ${device.device_id}`);
                            ws.send(JSON.stringify({ type: 'request_refresh' }));
                        } else {
                            console.warn(`[Refresh] No WS connection for ${device.device_id}`);
                        }
                    });

                    // Auto-connect WS
                    connectToDevice(device.device_id);
                });
            }
        }

        // Connect to WS for a device
        function connectToDevice(device_id) {
            if (wsMap[device_id]) return;
            const ws = new WebSocket(`wss://${window.location.host}/ws/user/devices/${device_id}`);
            ws.onopen = () => {
                console.log(`Connected to ${device_id}`);
                // Request refresh immediately on connect
                ws.send(JSON.stringify({ type: 'request_refresh' }));
                console.log(`[Auto-Refresh] Sent initial refresh request for ${device_id}`);
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log(`Received from server for ${device_id}:`, data);
                if (data.type === 'ph_update') {
                    document.getElementById(`ph-${device_id}`).innerHTML = data.ph || 'N/A';
                } else if (data.type === 'status_update' && data.data) {
                    const statusData = data.data;
                    document.getElementById(`system-name-${device_id}`).innerHTML = statusData.settings?.system_name || 'N/A';
                    document.getElementById(`ph-${device_id}`).innerHTML = statusData.current_ph || 'N/A';
                    document.getElementById(`ec-${device_id}`).innerHTML = statusData.current_ec || 'N/A';
                    
                    // Update water bucket visualization
                    updateWaterBucket(device_id, statusData);
                    
                    // Update valve controls
                    updateValveControls(device_id, statusData);
                    
                    // Update dosing controls
                    updateDosingControls(device_id, statusData);
                }
            };
            ws.onclose = () => {
                console.log(`Disconnected from ${device_id}`);
                delete wsMap[device_id];
            };
            wsMap[device_id] = ws;
        }

        // Update water bucket visualization
        function updateWaterBucket(device_id, statusData) {
            const water = statusData.water_level || {};
            const sensor1 = water.sensor1?.triggered || false;  // Full
            const sensor2 = water.sensor2?.triggered || false;  // Low
            const sensor3 = water.sensor3?.triggered || false;  // Empty
            
            // Update labels with sensor names
            const sensor1Label = water.sensor1?.label || 'Full';
            const sensor2Label = water.sensor2?.label || 'Low';
            const sensor3Label = water.sensor3?.label || 'Empty';
            
            document.getElementById(`sensor1-label-${device_id}`).textContent = `${sensor1Label} ${sensor1 ? '✓' : '✗'}`;
            document.getElementById(`sensor2-label-${device_id}`).textContent = `${sensor2Label} ${sensor2 ? '✓' : '✗'}`;
            document.getElementById(`sensor3-label-${device_id}`).textContent = `${sensor3Label} ${sensor3 ? '✓' : '✗'}`;
            
            // Calculate water level height based on sensors
            let waterHeight = 0;
            if (sensor1) {
                waterHeight = 90;  // Full (90% of bucket)
            } else if (sensor2) {
                waterHeight = 50;  // Low (50% of bucket)
            } else if (sensor3) {
                waterHeight = 5;   // Empty (5% of bucket)
            } else {
                waterHeight = 30;  // Unknown state (30% as default)
            }
            
            const waterLevelDiv = document.getElementById(`water-level-${device_id}`);
            waterLevelDiv.style.height = `${waterHeight}%`;
        }

        // Update valve controls based on status data
        function updateValveControls(device_id, statusData) {
            const valveControlsDiv = document.getElementById(`valve-controls-${device_id}`);
            const fillLabel = statusData.settings?.fill_valve_label;
            const drainLabel = statusData.settings?.drain_valve_label;
            const valveRelays = statusData.valve_info?.valve_relays || {};

            // Clear existing controls
            valveControlsDiv.innerHTML = '';

            // Add fill valve controls if configured
            if (fillLabel) {
                const fillStatus = valveRelays[fillLabel]?.status || 'off';
                const fillGroup = document.createElement('div');
                fillGroup.classList.add('valve-group');
                fillGroup.innerHTML = `
                    <label>${fillLabel}: <span id="fill-status-${device_id}">${fillStatus === 'on' ? 'On' : 'Off'}</span></label>
                    <div class="valve-buttons">
                        <button id="fill-on-${device_id}" class="${fillStatus === 'on' ? 'btn-on-active' : 'btn-inactive'}">On</button>
                        <button id="fill-off-${device_id}" class="${fillStatus === 'off' ? 'btn-off-active' : 'btn-inactive'}">Off</button>
                    </div>
                `;
                valveControlsDiv.appendChild(fillGroup);

                // Wire up fill valve buttons
                document.getElementById(`fill-on-${device_id}`).onclick = () => sendValveCommand(device_id, fillLabel, 'on');
                document.getElementById(`fill-off-${device_id}`).onclick = () => sendValveCommand(device_id, fillLabel, 'off');
            }

            // Add drain valve controls if configured
            if (drainLabel) {
                const drainStatus = valveRelays[drainLabel]?.status || 'off';
                const drainGroup = document.createElement('div');
                drainGroup.classList.add('valve-group');
                drainGroup.innerHTML = `
                    <label>${drainLabel}: <span id="drain-status-${device_id}">${drainStatus === 'on' ? 'On' : 'Off'}</span></label>
                    <div class="valve-buttons">
                        <button id="drain-on-${device_id}" class="${drainStatus === 'on' ? 'btn-on-active' : 'btn-inactive'}">On</button>
                        <button id="drain-off-${device_id}" class="${drainStatus === 'off' ? 'btn-off-active' : 'btn-inactive'}">Off</button>
                    </div>
                `;
                valveControlsDiv.appendChild(drainGroup);

                // Wire up drain valve buttons
                document.getElementById(`drain-on-${device_id}`).onclick = () => sendValveCommand(device_id, drainLabel, 'on');
                document.getElementById(`drain-off-${device_id}`).onclick = () => sendValveCommand(device_id, drainLabel, 'off');
            }
        }

        // Update dosing controls based on status data
        function updateDosingControls(device_id, statusData) {
            const dosingControlsDiv = document.getElementById(`dosing-controls-${device_id}`);
            const dosageInfo = statusData.dosage_info;

            // Clear existing controls
            dosingControlsDiv.innerHTML = '';

            if (!dosageInfo) return;

            const phUpAmount = dosageInfo.ph_up_amount || 0;
            const phDownAmount = dosageInfo.ph_down_amount || 0;
            const phTarget = dosageInfo.ph_target || 'N/A';
            const currentPh = dosageInfo.current_ph || 'N/A';

            // Create single container for both pH Up and Down
            const doseContainer = document.createElement('div');
            doseContainer.classList.add('dose-container');
            doseContainer.innerHTML = `
                <div style="width: 100%;">
                    <div class="dose-header">
                        <span><strong>pH Dosing</strong></span>
                        <span>Current: ${currentPh} | Target: ${phTarget}</span>
                    </div>
                </div>
                <div class="dose-section">
                    <label><strong>pH Up</strong></label>
                    <span>Calculated: ${phUpAmount.toFixed(2)} ml</span>
                    <button id="dose-up-calc-${device_id}" class="dose-button" ${phUpAmount === 0 ? 'disabled' : ''}>Dose Calculated</button>
                    <hr style="border: 0; border-top: 1px solid #444; margin: 8px 0;">
                    <label style="font-size: 0.9em;">Manual Amount:</label>
                    <div class="manual-input">
                        <input type="number" id="manual-up-${device_id}" placeholder="ml" step="0.1" min="0" value="5">
                        <button id="dose-up-manual-${device_id}" class="dose-button">Dose</button>
                    </div>
                </div>
                <div class="dose-section">
                    <label><strong>pH Down</strong></label>
                    <span>Calculated: ${phDownAmount.toFixed(2)} ml</span>
                    <button id="dose-down-calc-${device_id}" class="dose-button" ${phDownAmount === 0 ? 'disabled' : ''}>Dose Calculated</button>
                    <hr style="border: 0; border-top: 1px solid #444; margin: 8px 0;">
                    <label style="font-size: 0.9em;">Manual Amount:</label>
                    <div class="manual-input">
                        <input type="number" id="manual-down-${device_id}" placeholder="ml" step="0.1" min="0" value="5">
                        <button id="dose-down-manual-${device_id}" class="dose-button">Dose</button>
                    </div>
                </div>
            `;
            dosingControlsDiv.appendChild(doseContainer);

            // Wire up pH Up buttons
            document.getElementById(`dose-up-calc-${device_id}`).onclick = () => {
                if (phUpAmount > 0) sendDoseCommand(device_id, 'up', phUpAmount);
            };
            document.getElementById(`dose-up-manual-${device_id}`).onclick = () => {
                const amount = parseFloat(document.getElementById(`manual-up-${device_id}`).value) || 0;
                if (amount > 0) sendDoseCommand(device_id, 'up', amount);
                else alert('Please enter a valid amount greater than 0');
            };

            // Wire up pH Down buttons
            document.getElementById(`dose-down-calc-${device_id}`).onclick = () => {
                if (phDownAmount > 0) sendDoseCommand(device_id, 'down', phDownAmount);
            };
            document.getElementById(`dose-down-manual-${device_id}`).onclick = () => {
                const amount = parseFloat(document.getElementById(`manual-down-${device_id}`).value) || 0;
                if (amount > 0) sendDoseCommand(device_id, 'down', amount);
                else alert('Please enter a valid amount greater than 0');
            };
        }

        // Send valve command via WebSocket
        function sendValveCommand(device_id, valve_label, action) {
            const ws = wsMap[device_id];
            if (ws) {
                console.log(`[Valve] Sending command to ${device_id}: ${valve_label} ${action}`);
                ws.send(JSON.stringify({
                    command: 'valve_control',
                    params: { valve_label: valve_label, action: action }
                }));
            } else {
                console.warn(`[Valve] No WS connection for ${device_id}`);
            }
        }

        // Send dose command via WebSocket
        function sendDoseCommand(device_id, dispense_type, amount) {
            const ws = wsMap[device_id];
            if (ws) {
                console.log(`[Dose] Sending command to ${device_id}: pH ${dispense_type} ${amount}ml`);
                ws.send(JSON.stringify({
                    command: 'manual_dose',
                    params: { dispense_type: dispense_type, amount: amount }
                }));
                alert(`Dosing ${amount.toFixed(2)}ml of pH ${dispense_type.toUpperCase()} on ${device_id}`);
            } else {
                console.warn(`[Dose] No WS connection for ${device_id}`);
            }
        }

        // Load devices and auto-connect on page load
        window.onload = fetchAndConnectDevices;

        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };
    </script>
</body>
</html>