<!-- templates/dashboard.html - Show statuses for all devices -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Modern Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #10b981;
        }
        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
            text-decoration: none;
        }
        .navbar-brand:hover {
            color: #34d399;
        }
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar-link {
            padding: 1rem 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .navbar-link:hover {
            background: rgba(16, 185, 129, 0.1);
            border-bottom-color: #10b981;
        }
        .navbar-link.active {
            background: rgba(16, 185, 129, 0.15);
            border-bottom-color: #10b981;
            color: #10b981;
        }
        .navbar-user {
            padding: 1rem 1.25rem;
            color: rgba(148, 163, 184, 0.9);
            font-size: 0.9rem;
            border-left: 1px solid rgba(148, 163, 184, 0.2);
        }
        .navbar-logout {
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .navbar-logout:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }
        
        /* Device section layout */
        .device-section {
            margin-bottom: 10px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #1a1a1a;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* Collapsible header - always visible */
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #2a2a2a;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        .device-header:hover {
            background: #333;
        }
        .device-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        .device-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #4da6ff;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .status-online {
            background: #28a745;
            color: #fff;
        }
        .status-offline {
            background: #dc3545;
            color: #fff;
        }
        .header-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .info-item {
            display: flex;
            align-items: baseline;
            gap: 6px;
            font-size: 0.95em;
        }
        .info-item label {
            color: #999;
        }
        .info-item span {
            color: #fff;
            font-weight: 500;
        }
        .expand-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
            color: #4da6ff;
        }
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        /* Expandable content */
        .device-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .device-content.expanded {
            max-height: 2000px;
        }
        .device-content-inner {
            padding: 15px;
        }
        
        /* Card grid layout */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* Card styling */
        .card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 10px;
        }
        .card-title {
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #4da6ff;
            border-bottom: 1px solid #444;
            padding-bottom: 6px;
        }
        
        /* Water bucket - Styles are in style.css */
        .sensor-full { top: 10%; }
        .sensor-low { top: 50%; }
        .sensor-empty { bottom: 5%; }
        
        /* Valve controls - These styles are overridden by style.css */
        
        /* pH Dosing - Compact Modern Style */
        .ph-header {
            display: flex;
            justify-content: center;
            margin-bottom: 0.5rem;
            padding: 0.35rem 0.5rem;
            background: rgba(51, 65, 85, 0.4);
            border-radius: 6px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            font-size: 0.7rem;
        }
        .ph-header span {
            color: rgba(148, 163, 184, 0.9);
        }
        .ph-header strong {
            color: #10b981;
            margin-left: 0.25rem;
        }
        .dose-sections {
            display: flex;
            gap: 0.5rem;
            flex-direction: row;
        }
        .dose-section {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 6px;
            padding: 0.5rem;
            flex: 1;
            min-width: 0;
        }
        .dose-section h4 {
            font-size: 0.7rem;
            font-weight: 700;
            margin-bottom: 0.4rem;
            color: #10b981;
            text-transform: uppercase;
            text-align: center;
        }
        .dose-info {
            color: rgba(148, 163, 184, 0.9);
            margin-bottom: 0.4rem;
            font-size: 0.65rem;
            padding: 0.25rem 0.35rem;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 3px;
            border-left: 2px solid #10b981;
            text-align: center;
        }
        .dose-button {
            width: 100%;
            padding: 0.4rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.65rem;
            transition: all 0.2s;
            text-transform: uppercase;
            margin-bottom: 0.4rem;
        }
        .dose-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }
        .dose-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: linear-gradient(135deg, rgba(148, 163, 184, 0.3) 0%, rgba(100, 116, 139, 0.3) 100%);
        }
        .manual-section {
            margin-top: 0.4rem;
            padding-top: 0.4rem;
            border-top: 1px solid rgba(148, 163, 184, 0.2);
        }
        .manual-section label {
            display: block;
            margin-bottom: 0.3rem;
            color: rgba(148, 163, 184, 0.7);
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            text-align: center;
        }
        .manual-input {
            display: flex;
            gap: 0.3rem;
        }
        .manual-input input {
            flex: 1;
            padding: 0.3rem 0.4rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 3px;
            color: #fff;
            font-size: 0.7rem;
            min-width: 0;
            text-align: center;
        }
        .manual-input button {
            padding: 0.3rem 0.5rem;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.6rem;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        /* Refresh button */
        .refresh-btn {
            width: 100%;
            padding: 12px;
            background: #28a745;
            border: 1px solid #28a745;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.2s;
        }
        .refresh-btn:hover {
            background: #218838;
            transform: scale(1.02);
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Navbar mobile adjustments */
            .navbar-container {
                padding: 0 0.75rem;
                flex-wrap: wrap;
            }
            .navbar-brand {
                font-size: 1rem;
                padding: 0.75rem 0;
            }
            .navbar-menu {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 0;
                display: none;
            }
            .navbar-menu.mobile-open {
                display: flex;
            }
            .navbar-link {
                padding: 0.75rem 1rem;
                border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            }
            .navbar-user {
                padding: 0.75rem 1rem;
                border-left: none;
                border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            }
            .navbar-logout {
                margin: 0.75rem 1rem;
            }

            /* Hamburger menu button */
            .navbar-toggle {
                display: block;
                background: none;
                border: none;
                color: #10b981;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0.5rem;
            }

            /* Device header mobile */
            .device-header {
                flex-direction: column;
                align-items: stretch;
                gap: 2px;
                padding: 6px 10px;
                position: relative;
            }
            .device-header-left {
                flex-direction: row;
                align-items: center;
                gap: 6px;
                flex-wrap: wrap;
            }
            .device-name {
                font-size: 0.95em;
            }
            .status-badge {
                padding: 2px 6px;
                font-size: 0.65em;
            }

            /* Hide pH and EC from header-info on mobile, will show next to badge */
            .header-info [data-key="ph"],
            .header-info [data-key="ec"] {
                display: none !important;
            }

            /* Show pH/EC next to badge on mobile - 50% larger */
            .header-ph-ec {
                display: flex !important;
                flex-wrap: wrap;
                font-size: 1.05em !important;
            }

            .header-info {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 6px;
                width: 100%;
                font-size: 0.7em;
            }
            .info-item {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                gap: 4px !important;
                background: rgba(51, 65, 85, 0.5) !important;
                border: 1px solid rgba(148, 163, 184, 0.2) !important;
                padding: 6px 10px !important;
                border-radius: 8px !important;
                min-width: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            .info-item label {
                display: inline !important;
                font-size: 1em !important;
                color: #888 !important;
                text-transform: uppercase !important;
                letter-spacing: 0.3px !important;
                font-weight: 600 !important;
                flex-shrink: 0 !important;
                white-space: nowrap !important;
            }
            .info-item label::after {
                content: ':';
            }
            .info-item span {
                display: inline !important;
                font-size: 1em !important;
                font-weight: 500 !important;
                color: #10b981 !important;
                white-space: nowrap !important;
                flex: 1 !important;
                overflow: visible !important;
            }

            /* Force positioning in grid */
            .header-info > .info-item[id^="system-item"] {
                grid-column: 1 !important;
                grid-row: 1 !important;
            }
            .header-info > .info-item[id^="plant-item"] {
                grid-column: 2 !important;
                grid-row: 1 !important;
            }
            .header-info > .info-item[id^="start-date-item"] {
                grid-column: 1 !important;
                grid-row: 2 !important;
            }
            .header-info > .info-item[id^="weeks-item"] {
                grid-column: 2 !important;
                grid-row: 2 !important;
            }

            /* Force span visibility inside each info item */
            .info-item span[id^="system-name-"],
            .info-item span[id^="plant-name-"],
            .info-item span[id^="start-date-"],
            .info-item span[id^="weeks-"] {
                display: inline !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            /* Reposition wrapper to top-right corner and make it span full height */
            .header-icons-wrapper {
                position: absolute !important;
                top: 0 !important;
                right: 10px !important;
                height: 100% !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: space-between !important;
                align-items: flex-end !important;
                gap: 0 !important;
                padding: 6px 0 !important;
            }

            /* Position icons within wrapper */
            .device-header .refresh-icon {
                position: static !important;
                font-size: 1.2rem !important;
            }

            .device-header .expand-icon {
                position: static !important;
                font-size: 1rem !important;
            }

            /* Add padding to header-left to avoid overlap with icons */
            .device-header-left {
                padding-right: 30px;
            }

            /* Cards grid mobile */
            .cards-grid {
                grid-template-columns: 1fr !important;
                gap: 10px;
            }

            /* Card adjustments */
            .card {
                padding: 8px;
            }
            .card-title {
                font-size: 0.9em;
            }

            /* Dose sections mobile */
            .dose-sections {
                flex-direction: column;
                gap: 0.75rem;
            }
            .dose-section {
                padding: 0.75rem;
            }

            /* Water bucket mobile */
            .water-bucket-container {
                justify-content: center;
            }

            /* Water level sensors mobile - smaller circles and text */
            .sensor-label {
                font-size: 1rem !important;
            }

            .sensor-label span {
                font-size: 20px !important;
                width: 20px !important;
                height: 20px !important;
            }

            /* Adjust card title for water level */
            [id^="water-level-card"] .card-title {
                font-size: 0.8rem !important;
            }

            /* Valve controls mobile */
            .valve-controls {
                flex-direction: column;
                gap: 8px;
            }
            .valve-controls button {
                width: 100% !important;
                min-width: unset !important;
            }

            /* pH dosing mobile */
            .ph-header {
                font-size: 0.85rem;
                flex-direction: column;
                text-align: center;
            }

            /* Buttons mobile */
            button {
                padding: 0.75rem 1rem !important;
                font-size: 0.9rem !important;
                min-height: 44px; /* Touch-friendly size */
            }

            /* Input fields mobile */
            input[type="number"] {
                font-size: 1rem !important;
                padding: 0.75rem !important;
                min-height: 44px;
            }

            /* Dose info mobile */
            .dose-info {
                font-size: 0.85rem;
                padding: 0.5rem;
            }

            /* Main container mobile */
            .main-container {
                padding: 1rem 0.75rem !important;
            }

            /* Device section spacing mobile */
            .device-section {
                margin-bottom: 15px;
            }

            /* All valves table mobile */
            [id^="all-valves-controls-"] table {
                font-size: 0.75rem !important;
                table-layout: fixed;
                width: 100%;
            }

            [id^="all-valves-controls-"] table th:nth-child(1),
            [id^="all-valves-controls-"] table td:nth-child(1) {
                width: 10%;
            }

            [id^="all-valves-controls-"] table th:nth-child(2),
            [id^="all-valves-controls-"] table td:nth-child(2) {
                width: 35%;
            }

            [id^="all-valves-controls-"] table th:nth-child(3),
            [id^="all-valves-controls-"] table td:nth-child(3) {
                width: 20%;
            }

            [id^="all-valves-controls-"] table th:nth-child(4),
            [id^="all-valves-controls-"] table td:nth-child(4) {
                width: 35%;
            }

            [id^="all-valves-controls-"] table th,
            [id^="all-valves-controls-"] table td {
                padding: 0.35rem 0.25rem !important;
            }

            [id^="all-valves-controls-"] .valve-buttons {
                gap: 0.25rem !important;
                flex-wrap: nowrap;
            }

            [id^="all-valves-controls-"] .valve-buttons button {
                width: 38px !important;
                min-width: 38px !important;
                max-width: 38px !important;
                padding: 0.3rem 0.1rem !important;
                font-size: 0.7rem !important;
            }
        }

        /* Extra small devices */
        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 0.9rem;
            }
            .device-name {
                font-size: 0.85em;
            }
            .status-badge {
                padding: 2px 5px;
                font-size: 0.6em;
            }
            .header-ph-ec {
                font-size: 0.975em !important;
                gap: 6px !important;
            }
            .header-info {
                font-size: 0.65em;
                gap: 5px;
            }
            .info-item {
                gap: 3px !important;
                padding: 5px 8px !important;
            }
            .info-item label {
                font-size: 1em !important;
                letter-spacing: 0.2px !important;
            }
            .info-item span {
                font-size: 1em !important;
                display: inline !important;
            }

            /* Even smaller water level on phones */
            .sensor-label {
                font-size: 0.85rem !important;
            }

            .sensor-label span {
                font-size: 16px !important;
                width: 16px !important;
                height: 16px !important;
            }

            [id^="water-level-card"] .card-title {
                font-size: 0.75rem !important;
            }

            .card-title {
                font-size: 0.85em;
            }
            button {
                padding: 0.6rem 0.8rem !important;
                font-size: 0.85rem !important;
            }

            /* Even smaller valve buttons on phones */
            [id^="all-valves-controls-"] .valve-buttons button {
                width: 35px !important;
                min-width: 35px !important;
                max-width: 35px !important;
                padding: 0.25rem 0.1rem !important;
                font-size: 0.65rem !important;
            }

            [id^="all-valves-controls-"] table {
                font-size: 0.7rem !important;
            }
        }

        /* Hide hamburger on desktop */
        @media (min-width: 769px) {
            .navbar-toggle {
                display: none;
            }
            .navbar-menu {
                display: flex !important;
            }
            /* Hide mobile pH/EC on desktop */
            .header-ph-ec {
                display: none !important;
            }
            /* Show wrapper on desktop - reset to default flex row */
            .header-icons-wrapper {
                position: static !important;
                display: flex !important;
                flex-direction: row !important;
                height: auto !important;
                padding: 0 !important;
                gap: 1rem !important;
            }
            /* Reset icon positioning on desktop */
            .device-header .refresh-icon,
            .device-header .expand-icon {
                position: static !important;
                font-size: 1.5rem !important;
            }
            .device-header .expand-icon {
                font-size: 1.2em !important;
            }
            .device-header-left {
                padding-right: 0 !important;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard" class="navbar-brand">
                üå± Plant Monitor
            </a>
            <button class="navbar-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                ‚ò∞
            </button>
            <div class="navbar-menu" id="navbar-menu">
                <a href="/dashboard" class="navbar-link active">Dashboard</a>
                <a href="/devices" class="navbar-link">Devices</a>
                {% if user.is_superuser %}
                <a href="/admin/users" class="navbar-link">Users</a>
                {% endif %}
                <span class="navbar-user">{{ user.email }}</span>
                <a href="/auth/logout" class="navbar-logout">Logout</a>
            </div>
        </div>
    </nav>

    <script>
        // Toggle mobile menu
        function toggleMobileMenu() {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('mobile-open');
        }

        // Close mobile menu when clicking a link
        document.querySelectorAll('.navbar-link, .navbar-logout').forEach(link => {
            link.addEventListener('click', () => {
                const menu = document.getElementById('navbar-menu');
                if (menu.classList.contains('mobile-open')) {
                    menu.classList.remove('mobile-open');
                }
            });
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('navbar-menu');
            const toggle = document.querySelector('.navbar-toggle');
            const navbar = document.querySelector('.navbar-container');

            if (menu.classList.contains('mobile-open') &&
                !navbar.contains(e.target)) {
                menu.classList.remove('mobile-open');
            }
        });
    </script>

    <div class="main-container" style="padding: 2rem 1.5rem; max-width: 1400px; margin: 0 auto;">
        <h2 style="color: #10b981; margin-bottom: 1.5rem;">My Devices</h2>
    <div id="devices-status"></div>

    <script>
        let wsMap = {};

        async function fetchAndConnectDevices() {
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const statusDiv = document.getElementById('devices-status');
                statusDiv.innerHTML = '';
                devices.forEach(device => {
                    const deviceSection = document.createElement('div');
                    deviceSection.classList.add('device-section');
                    deviceSection.innerHTML = `
                        <div class="device-header" onclick="toggleDevice('${device.device_id}')" style="cursor: ${device.is_online ? 'pointer' : 'not-allowed'}; opacity: ${device.is_online ? '1' : '0.6'};">
                            <div class="device-header-left">
                                <div class="status-badge ${device.is_online ? 'status-online' : 'status-offline'}" id="status-badge-${device.device_id}">
                                    ‚óè ${device.is_online ? 'Online' : 'Offline'}
                                </div>
                                <div class="header-ph-ec" id="header-ph-ec-${device.device_id}" style="display:none; font-size: 0.7em; color: #10b981; gap: 8px;">
                                    <span id="header-ph-${device.device_id}" style="display:none;"></span>
                                    <span id="header-ec-${device.device_id}" style="display:none;"></span>
                                </div>
                                <div class="header-info">
                                    <div class="info-item" id="system-item-${device.device_id}">
                                        <label>System:</label>
                                        <span id="system-name-${device.device_id}">Loading...</span>
                                    </div>
                                    <div class="info-item" id="plant-item-${device.device_id}" style="display:none;">
                                        <label>Plant:</label>
                                        <span id="plant-name-${device.device_id}">-</span>
                                    </div>
                                    <div class="info-item" id="start-date-item-${device.device_id}" style="display:none;">
                                        <label>Started:</label>
                                        <span id="start-date-${device.device_id}">-</span>
                                    </div>
                                    <div class="info-item" id="weeks-item-${device.device_id}" style="display:none;">
                                        <label>Week:</label>
                                        <span id="weeks-${device.device_id}">-</span>
                                    </div>
                                    <div class="info-item" id="ph-item-${device.device_id}" data-key="ph" style="display:none;">
                                        <label>pH:</label>
                                        <span id="ph-${device.device_id}">-</span>
                                    </div>
                                    <div class="info-item" id="ec-item-${device.device_id}" data-key="ec" style="display:none;">
                                        <label>EC:</label>
                                        <span id="ec-${device.device_id}">-</span>
                                    </div>
                                </div>
                            </div>
                            <div class="header-icons-wrapper" style="display: flex; align-items: center; gap: 1rem;">
                                <div class="refresh-icon" id="refresh-icon-${device.device_id}" style="cursor: pointer; font-size: 1.5rem; color: #4da6ff; transition: transform 0.3s;" title="Refresh">üîÑ</div>
                                <div class="expand-icon" id="expand-icon-${device.device_id}">‚ñº</div>
                            </div>
                        </div>
                        
                        <div class="device-content" id="device-content-${device.device_id}">
                            <div class="device-content-inner">
                                <div class="cards-grid">
                                    <!-- Water Level Card -->
                                    <div class="card" id="water-level-card-${device.device_id}">
                                        <div class="card-title">üíß Water Level</div>
                                        <div class="bucket-container">
                                            <div class="water-bucket">
                                                <div class="water-level" id="water-level-${device.device_id}"></div>
                                                <div class="sensor-marker sensor-full">
                                                    <span class="sensor-label" id="sensor1-label-${device.device_id}">Full</span>
                                                </div>
                                                <div class="sensor-marker sensor-low">
                                                    <span class="sensor-label" id="sensor2-label-${device.device_id}">Low</span>
                                                </div>
                                                <div class="sensor-marker sensor-empty">
                                                    <span class="sensor-label" id="sensor3-label-${device.device_id}">Empty</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Valves Card -->
                                    <div class="card" id="valves-card-${device.device_id}" style="display:none;">
                                        <div class="card-title">üö∞ Valve Controls</div>
                                        <div id="valve-controls-${device.device_id}"></div>
                                    </div>

                                    <!-- pH Dosing Card (inline with others) -->
                                    <div class="card" id="dosing-card-${device.device_id}" style="display:none;">
                                        <div class="card-title">
                                            <span>‚öóÔ∏è pH Dosing</span>
                                            <span id="ph-title-${device.device_id}" style="float: right; font-size: 0.8rem; color: var(--text-secondary);"></span>
                                        </div>
                                        <div id="dosing-controls-${device.device_id}"></div>
                                    </div>

                                    <!-- All Valves Card -->
                                    <div class="card" id="all-valves-card-${device.device_id}" style="display:none;">
                                        <div class="card-title">üéõÔ∏è All Valves</div>
                                        <div id="all-valves-controls-${device.device_id}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    statusDiv.appendChild(deviceSection);

                    document.getElementById(`refresh-icon-${device.device_id}`).addEventListener('click', (e) => {
                        e.stopPropagation();
                        const icon = e.target;
                        icon.style.transform = 'rotate(360deg)';
                        setTimeout(() => { icon.style.transform = 'rotate(0deg)'; }, 300);
                        const ws = wsMap[device.device_id];
                        if (ws) {
                            ws.send(JSON.stringify({ type: 'request_refresh' }));
                        }
                    });

                    connectToDevice(device.device_id);
                });
            }
        }

        function toggleDevice(device_id) {
            // Check if device is online
            const statusBadge = document.getElementById(`status-badge-${device_id}`);
            const isOnline = statusBadge && statusBadge.classList.contains('status-online');
            
            if (!isOnline) {
                // Don't allow expanding offline devices
                return;
            }
            
            const content = document.getElementById(`device-content-${device_id}`);
            const icon = document.getElementById(`expand-icon-${device_id}`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        function connectToDevice(device_id) {
            if (wsMap[device_id]) return;
            const ws = new WebSocket(`wss://${window.location.host}/ws/user/devices/${device_id}`);
            ws.onopen = () => {
                console.log(`Connected to ${device_id}`);
                // Don't automatically set online - wait for actual device status
                ws.send(JSON.stringify({ type: 'request_refresh' }));
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                // Handle device status messages
                if (data.error === 'Device offline') {
                    updateOnlineStatus(device_id, false);
                } else if (data.type === 'device_status') {
                    updateOnlineStatus(device_id, data.online);
                }
                // Handle full sync (on connect or refresh)
                else if (data.type === 'full_sync' && data.data) {
                    updateOnlineStatus(device_id, true);
                    updateDeviceStatus(device_id, data.data);
                }
                // Handle granular pH update
                else if (data.type === 'ph_update') {
                    updateOnlineStatus(device_id, true);
                    const probeStatus = window.deviceProbeStatus?.[device_id];
                    if (probeStatus?.hasPhProbe && data.value !== null && data.value !== undefined) {
                        const phItem = document.getElementById(`ph-item-${device_id}`);
                        phItem.style.display = 'flex';
                        document.getElementById(`ph-${device_id}`).innerHTML = data.value;
                    }
                }
                // Handle granular EC update
                else if (data.type === 'ec_update') {
                    updateOnlineStatus(device_id, true);
                    const probeStatus = window.deviceProbeStatus?.[device_id];
                    if (probeStatus?.hasEcProbe && data.value !== null && data.value !== undefined) {
                        const ecItem = document.getElementById(`ec-item-${device_id}`);
                        ecItem.style.display = 'flex';
                        document.getElementById(`ec-${device_id}`).innerHTML = data.value;
                    }
                }
                // Handle granular water level update
                else if (data.type === 'water_level_update') {
                    updateOnlineStatus(device_id, true);
                    updateWaterBucketGranular(device_id, data);
                }
                // Handle granular valve update
                else if (data.type === 'valve_update') {
                    updateOnlineStatus(device_id, true);
                    updateSingleValve(device_id, data.label, data.status);
                }
                // Handle granular settings update
                else if (data.type === 'settings_update') {
                    updateOnlineStatus(device_id, true);
                    if (data.system_name) {
                        document.getElementById(`system-name-${device_id}`).innerHTML = data.system_name;
                    }
                }
                // Handle granular plant info update
                else if (data.type === 'plant_info_update') {
                    updateOnlineStatus(device_id, true);
                    updatePlantInfo(device_id, data);
                }
                // Handle granular dosage update
                else if (data.type === 'dosage_update') {
                    updateOnlineStatus(device_id, true);
                    updateDosingControlsGranular(device_id, data);
                }
                // Legacy: Handle old status_update format for backwards compatibility
                else if (data.type === 'status_update' && data.data) {
                    updateOnlineStatus(device_id, true);
                    updateDeviceStatus(device_id, data.data);
                }
            };
            ws.onclose = () => {
                console.log(`Disconnected from ${device_id}`);
                updateOnlineStatus(device_id, false);
                delete wsMap[device_id];
            };
            ws.onerror = (error) => {
                console.error(`WebSocket error for ${device_id}:`, error);
                updateOnlineStatus(device_id, false);
            };
            wsMap[device_id] = ws;
        }

        function updateOnlineStatus(device_id, isOnline) {
            const statusBadge = document.getElementById(`status-badge-${device_id}`);
            if (statusBadge) {
                statusBadge.className = `status-badge ${isOnline ? 'status-online' : 'status-offline'}`;
                statusBadge.textContent = isOnline ? '‚óè Online' : '‚óè Offline';
            }
            
            // If going offline, collapse the device section
            if (!isOnline) {
                const content = document.getElementById(`device-content-${device_id}`);
                const icon = document.getElementById(`expand-icon-${device_id}`);
                if (content && content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    icon.classList.remove('expanded');
                }
            }
            
            // Update header clickability visual indication
            const header = document.querySelector(`[onclick="toggleDevice('${device_id}')"]`);
            if (header) {
                header.style.cursor = isOnline ? 'pointer' : 'not-allowed';
                header.style.opacity = isOnline ? '1' : '0.6';
            }
        }

        function updateDeviceStatus(device_id, statusData) {
            // Store probe status for granular updates
            if (!window.deviceProbeStatus) window.deviceProbeStatus = {};
            window.deviceProbeStatus[device_id] = {
                hasPhProbe: !!statusData.settings?.usb_roles?.ph_probe,
                hasEcProbe: !!statusData.settings?.usb_roles?.ec_meter
            };
            
            document.getElementById(`system-name-${device_id}`).innerHTML = statusData.settings?.system_name || 'N/A';
            
            // Plant info
            const plantInfo = statusData.settings?.plant_info || {};
            const plantName = plantInfo.name;
            const startDate = plantInfo.start_date;

            const plantItem = document.getElementById(`plant-item-${device_id}`);
            const startDateItem = document.getElementById(`start-date-item-${device_id}`);
            const weeksItem = document.getElementById(`weeks-item-${device_id}`);

            if (plantName && plantName !== '-') {
                plantItem.style.setProperty('display', 'flex', 'important');
                document.getElementById(`plant-name-${device_id}`).innerHTML = plantName;
            } else {
                plantItem.style.setProperty('display', 'none', 'important');
            }

            if (startDate && startDate !== '-') {
                startDateItem.style.setProperty('display', 'flex', 'important');
                document.getElementById(`start-date-${device_id}`).innerHTML = startDate;

                // Calculate weeks
                try {
                    const start = new Date(startDate);
                    if (!isNaN(start.getTime())) {
                        const now = new Date();
                        const diffMs = now - start;
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        const weeks = Math.floor(diffDays / 7);
                        weeksItem.style.setProperty('display', 'flex', 'important');
                        document.getElementById(`weeks-${device_id}`).innerHTML = weeks;
                    }
                } catch (e) {
                    console.error('Error calculating weeks:', e);
                }
            } else {
                startDateItem.style.setProperty('display', 'none', 'important');
                weeksItem.style.setProperty('display', 'none', 'important');
            }
            
            // pH/EC
            const phProbe = statusData.settings?.usb_roles?.ph_probe;
            const phItem = document.getElementById(`ph-item-${device_id}`);
            const headerPhEl = document.getElementById(`header-ph-${device_id}`);
            if (phProbe) {
                phItem.style.display = 'flex';
                const phValue = statusData.current_ph || '-';
                document.getElementById(`ph-${device_id}`).innerHTML = phValue;
                // Update header pH for mobile
                if (headerPhEl) {
                    headerPhEl.innerHTML = `pH: ${phValue}`;
                    headerPhEl.style.display = 'inline';
                }
            } else {
                phItem.style.setProperty('display', 'none', 'important');
                if (headerPhEl) headerPhEl.style.display = 'none';
            }

            const ecMeter = statusData.settings?.usb_roles?.ec_meter;
            const ecItem = document.getElementById(`ec-item-${device_id}`);
            const headerEcEl = document.getElementById(`header-ec-${device_id}`);
            console.log('EC Meter check:', device_id, 'ecMeter:', ecMeter, 'ecItem:', ecItem);
            if (ecMeter) {
                console.log('Showing EC for device', device_id);
                ecItem.style.display = 'flex';
                const ecValue = statusData.current_ec || '-';
                document.getElementById(`ec-${device_id}`).innerHTML = ecValue;
                // Update header EC for mobile
                if (headerEcEl) {
                    headerEcEl.innerHTML = `EC: ${ecValue}`;
                    headerEcEl.style.display = 'inline';
                }
            } else {
                console.log('Hiding EC for device', device_id);
                ecItem.style.setProperty('display', 'none', 'important');
                if (headerEcEl) headerEcEl.style.display = 'none';
            }
            
            updateWaterBucket(device_id, statusData);
            updateValveControls(device_id, statusData);
            updateDosingControls(device_id, statusData);
            updateAllValvesControls(device_id, statusData);
        }

        function updateWaterBucket(device_id, statusData) {
            const waterLevelCard = document.getElementById(`water-level-card-${device_id}`);
            const waterSensorsEnabled = statusData.settings?.water_sensors_enabled;

            // Hide water level card if sensors are disabled
            if (!waterSensorsEnabled) {
                waterLevelCard.style.display = 'none';
                return;
            }

            waterLevelCard.style.display = 'block';

            const water = statusData.water_level || {};
            const sensor1 = water.sensor1?.triggered || false;
            const sensor2 = water.sensor2?.triggered || false;
            const sensor3 = water.sensor3?.triggered || false;

            document.getElementById(`sensor1-label-${device_id}`).innerHTML = `<span style="color: ${sensor1 ? '#10b981' : '#ef4444'}; font-size: 2em;">‚óè</span> ${water.sensor1?.label || 'Full'}`;
            document.getElementById(`sensor2-label-${device_id}`).innerHTML = `<span style="color: ${sensor2 ? '#10b981' : '#ef4444'}; font-size: 2em;">‚óè</span> ${water.sensor2?.label || 'Low'}`;
            document.getElementById(`sensor3-label-${device_id}`).innerHTML = `<span style="color: ${sensor3 ? '#10b981' : '#ef4444'}; font-size: 2em;">‚óè</span> ${water.sensor3?.label || 'Empty'}`;

            let waterHeight = 0;
            if (sensor1) waterHeight = 90;
            else if (sensor2) waterHeight = 33;
            else if (sensor3) waterHeight = 10;

            document.getElementById(`water-level-${device_id}`).style.height = `${waterHeight}%`;
        }

        function updateWaterBucketGranular(device_id, data) {
            // Granular water level update
            const sensor1 = data.sensor1?.triggered || false;
            const sensor2 = data.sensor2?.triggered || false;
            const sensor3 = data.sensor3?.triggered || false;

            document.getElementById(`sensor1-label-${device_id}`).innerHTML = `<span style="color: ${sensor1 ? '#10b981' : '#ef4444'}; font-size: 2em;">‚óè</span> ${data.sensor1?.label || 'Full'}`;
            document.getElementById(`sensor2-label-${device_id}`).innerHTML = `<span style="color: ${sensor2 ? '#10b981' : '#ef4444'}; font-size: 2em;">‚óè</span> ${data.sensor2?.label || 'Low'}`;
            document.getElementById(`sensor3-label-${device_id}`).innerHTML = `<span style="color: ${sensor3 ? '#10b981' : '#ef4444'}; font-size: 2em;">‚óè</span> ${data.sensor3?.label || 'Empty'}`;

            let waterHeight = 0;
            if (sensor1) waterHeight = 90;
            else if (sensor2) waterHeight = 33;
            else if (sensor3) waterHeight = 10;

            document.getElementById(`water-level-${device_id}`).style.height = `${waterHeight}%`;
        }

        function updateSingleValve(device_id, label, status) {
            // Update a single valve status
            const fillStatusEl = document.getElementById(`fill-status-${device_id}`);
            const drainStatusEl = document.getElementById(`drain-status-${device_id}`);

            // Update the appropriate valve in fill/drain controls
            const settings = {}; // We don't have full settings here, so we check by element existence

            if (fillStatusEl) {
                const fillOnBtn = document.getElementById(`fill-on-${device_id}`);
                const fillOffBtn = document.getElementById(`fill-off-${device_id}`);
                if (fillOnBtn && fillOnBtn.parentElement.parentElement.querySelector('.valve-label').textContent.includes(label)) {
                    fillStatusEl.textContent = status === 'on' ? 'On' : 'Off';
                    fillOnBtn.className = status === 'on' ? 'btn-on-active' : 'btn-inactive';
                    fillOffBtn.className = status === 'off' ? 'btn-off-active' : 'btn-inactive';
                }
            }

            if (drainStatusEl) {
                const drainOnBtn = document.getElementById(`drain-on-${device_id}`);
                const drainOffBtn = document.getElementById(`drain-off-${device_id}`);
                if (drainOnBtn && drainOnBtn.parentElement.parentElement.querySelector('.valve-label').textContent.includes(label)) {
                    drainStatusEl.textContent = status === 'on' ? 'On' : 'Off';
                    drainOnBtn.className = status === 'on' ? 'btn-on-active' : 'btn-inactive';
                    drainOffBtn.className = status === 'off' ? 'btn-off-active' : 'btn-inactive';
                }
            }

            // Also update the all valves table if it exists
            // Try to find the valve by label in the all valves table
            for (let i = 1; i <= 8; i++) {
                const statusEl = document.getElementById(`all-valve-status-${device_id}-${i}`);
                if (statusEl && statusEl.parentElement.parentElement.querySelector('td:nth-child(2)').textContent === label) {
                    statusEl.textContent = status;
                    const onBtn = document.getElementById(`all-valve-${device_id}-${i}-on`);
                    const offBtn = document.getElementById(`all-valve-${device_id}-${i}-off`);
                    if (onBtn && offBtn) {
                        onBtn.className = status === 'on' ? 'btn-on-active' : 'btn-inactive';
                        offBtn.className = status === 'off' ? 'btn-off-active' : 'btn-inactive';
                    }
                    break;
                }
            }
        }

        function updatePlantInfo(device_id, data) {
            // Update plant info granularly
            const plantItem = document.getElementById(`plant-item-${device_id}`);
            const startDateItem = document.getElementById(`start-date-item-${device_id}`);
            const weeksItem = document.getElementById(`weeks-item-${device_id}`);
            
            if (data.name) {
                plantItem.style.display = 'flex';
                document.getElementById(`plant-name-${device_id}`).innerHTML = data.name;
            }
            
            if (data.start_date) {
                startDateItem.style.display = 'flex';
                document.getElementById(`start-date-${device_id}`).innerHTML = data.start_date;
                
                // Calculate weeks
                try {
                    const start = new Date(data.start_date);
                    if (!isNaN(start.getTime())) {
                        const now = new Date();
                        const diffMs = now - start;
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        const weeks = Math.floor(diffDays / 7);
                        weeksItem.style.display = 'flex';
                        document.getElementById(`weeks-${device_id}`).innerHTML = weeks;
                    }
                } catch (e) {
                    console.error('Error calculating weeks:', e);
                }
            }
        }

        function updateDosingControlsGranular(device_id, data) {
            // Update dosing controls with granular data
            const dosingCard = document.getElementById(`dosing-card-${device_id}`);
            if (!data || (data.ph_up_amount === 0 && data.ph_down_amount === 0)) {
                return; // Don't update if no dosing info
            }
            
            dosingCard.style.display = 'block';
            
            const phUpAmount = data.ph_up_amount || 0;
            const phDownAmount = data.ph_down_amount || 0;
            const phTarget = data.ph_target || '-';
            const currentPh = data.current_ph || '-';
            
            // Update the dosing controls (simplified - just update the values)
            const phTitleEl = document.getElementById(`ph-title-${device_id}`);
            if (phTitleEl) {
                phTitleEl.innerHTML = `pH: <strong style="color: var(--primary);">${currentPh}</strong> | Target: <strong style="color: var(--primary);">${phTarget}</strong>`;
            }

            const dosingControlsDiv = document.getElementById(`dosing-controls-${device_id}`);
            if (dosingControlsDiv) {
                // Update calculated amounts
                const upInfo = dosingControlsDiv.querySelector('.dose-section:first-child .dose-info');
                const downInfo = dosingControlsDiv.querySelector('.dose-section:last-child .dose-info');
                if (upInfo) upInfo.textContent = `${phUpAmount.toFixed(2)} ml`;
                if (downInfo) downInfo.textContent = `${phDownAmount.toFixed(2)} ml`;

                // Update button states
                const upCalcBtn = document.getElementById(`dose-up-calc-${device_id}`);
                const downCalcBtn = document.getElementById(`dose-down-calc-${device_id}`);
                if (upCalcBtn) upCalcBtn.disabled = phUpAmount === 0;
                if (downCalcBtn) downCalcBtn.disabled = phDownAmount === 0;
            }
        }

        function updateValveControls(device_id, statusData) {
            const valveControlsDiv = document.getElementById(`valve-controls-${device_id}`);
            const valvesCard = document.getElementById(`valves-card-${device_id}`);
            const fillLabel = statusData.settings?.fill_valve_label;
            const drainLabel = statusData.settings?.drain_valve_label;
            const valveRelays = statusData.valve_info?.valve_relays || {};

            valveControlsDiv.innerHTML = '';
            
            if (!fillLabel && !drainLabel) {
                valvesCard.style.display = 'none';
                return;
            }
            
            valvesCard.style.display = 'block';

            if (fillLabel) {
                const fillStatus = valveRelays[fillLabel]?.status || 'off';
                const fillGroup = document.createElement('div');
                fillGroup.classList.add('valve-group');
                fillGroup.innerHTML = `
                    <div class="valve-label">${fillLabel}: <strong id="fill-status-${device_id}">${fillStatus === 'on' ? 'On' : 'Off'}</strong></div>
                    <div class="valve-buttons">
                        <button id="fill-on-${device_id}" class="${fillStatus === 'on' ? 'btn-on-active' : 'btn-inactive'}">On</button>
                        <button id="fill-off-${device_id}" class="${fillStatus === 'off' ? 'btn-off-active' : 'btn-inactive'}">Off</button>
                    </div>
                `;
                valveControlsDiv.appendChild(fillGroup);
                document.getElementById(`fill-on-${device_id}`).onclick = (e) => { e.stopPropagation(); sendValveCommand(device_id, fillLabel, 'on'); };
                document.getElementById(`fill-off-${device_id}`).onclick = (e) => { e.stopPropagation(); sendValveCommand(device_id, fillLabel, 'off'); };
            }

            if (drainLabel) {
                const drainStatus = valveRelays[drainLabel]?.status || 'off';
                const drainGroup = document.createElement('div');
                drainGroup.classList.add('valve-group');
                drainGroup.innerHTML = `
                    <div class="valve-label">${drainLabel}: <strong id="drain-status-${device_id}">${drainStatus === 'on' ? 'On' : 'Off'}</strong></div>
                    <div class="valve-buttons">
                        <button id="drain-on-${device_id}" class="${drainStatus === 'on' ? 'btn-on-active' : 'btn-inactive'}">On</button>
                        <button id="drain-off-${device_id}" class="${drainStatus === 'off' ? 'btn-off-active' : 'btn-inactive'}">Off</button>
                    </div>
                `;
                valveControlsDiv.appendChild(drainGroup);
                document.getElementById(`drain-on-${device_id}`).onclick = (e) => { e.stopPropagation(); sendValveCommand(device_id, drainLabel, 'on'); };
                document.getElementById(`drain-off-${device_id}`).onclick = (e) => { e.stopPropagation(); sendValveCommand(device_id, drainLabel, 'off'); };
            }
        }

        function updateDosingControls(device_id, statusData) {
            const dosingControlsDiv = document.getElementById(`dosing-controls-${device_id}`);
            const dosingCard = document.getElementById(`dosing-card-${device_id}`);
            const dosageInfo = statusData.dosage_info;
            const hasPhProbe = statusData.settings?.usb_roles?.ph_probe;

            // Hide dosing card if no pH probe assigned or no dosage info
            if (!hasPhProbe || !dosageInfo) {
                dosingCard.style.display = 'none';
                return;
            }
            
            dosingCard.style.display = 'block';

            const phUpAmount = dosageInfo.ph_up_amount || 0;
            const phDownAmount = dosageInfo.ph_down_amount || 0;
            const phTarget = dosageInfo.ph_target || '-';
            const currentPh = dosageInfo.current_ph || '-';

            // Update pH in card title
            const phTitleEl = document.getElementById(`ph-title-${device_id}`);
            if (phTitleEl) {
                phTitleEl.innerHTML = `pH: <strong style="color: var(--primary);">${currentPh}</strong> | Target: <strong style="color: var(--primary);">${phTarget}</strong>`;
            }

            dosingControlsDiv.innerHTML = `
                <div class="dose-sections">
                    <div class="dose-section">
                        <div style="margin-bottom: 0.3rem;">
                            <h4>pH Up</h4>
                            <span class="dose-info">${phUpAmount.toFixed(2)} ml</span>
                            <button id="dose-up-calc-${device_id}" class="dose-button" ${phUpAmount === 0 ? 'disabled' : ''}>Dose</button>
                        </div>
                        <div class="manual-section">
                            <label>Manual</label>
                            <div class="manual-input">
                                <input type="text" inputmode="decimal" id="manual-up-${device_id}" placeholder="ml" value="5">
                                <button id="dose-up-manual-${device_id}">Dose</button>
                            </div>
                        </div>
                    </div>
                    <div class="dose-section">
                        <div style="margin-bottom: 0.3rem;">
                            <h4>pH Down</h4>
                            <span class="dose-info">${phDownAmount.toFixed(2)} ml</span>
                            <button id="dose-down-calc-${device_id}" class="dose-button" ${phDownAmount === 0 ? 'disabled' : ''}>Dose</button>
                        </div>
                        <div class="manual-section">
                            <label>Manual</label>
                            <div class="manual-input">
                                <input type="text" inputmode="decimal" id="manual-down-${device_id}" placeholder="ml" value="5">
                                <button id="dose-down-manual-${device_id}">Dose</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById(`dose-up-calc-${device_id}`).onclick = (e) => {
                e.stopPropagation();
                if (phUpAmount > 0) sendDoseCommand(device_id, 'up', phUpAmount);
            };
            document.getElementById(`dose-up-manual-${device_id}`).onclick = (e) => {
                e.stopPropagation();
                const amount = parseFloat(document.getElementById(`manual-up-${device_id}`).value) || 0;
                if (amount > 0) sendDoseCommand(device_id, 'up', amount);
                else alert('Please enter a valid amount greater than 0');
            };
            document.getElementById(`dose-down-calc-${device_id}`).onclick = (e) => {
                e.stopPropagation();
                if (phDownAmount > 0) sendDoseCommand(device_id, 'down', phDownAmount);
            };
            document.getElementById(`dose-down-manual-${device_id}`).onclick = (e) => {
                e.stopPropagation();
                const amount = parseFloat(document.getElementById(`manual-down-${device_id}`).value) || 0;
                if (amount > 0) sendDoseCommand(device_id, 'down', amount);
                else alert('Please enter a valid amount greater than 0');
            };
        }

        function sendValveCommand(device_id, valve_label, action) {
            const ws = wsMap[device_id];
            if (ws) {
                ws.send(JSON.stringify({
                    command: 'valve_control',
                    params: { valve_label: valve_label, action: action }
                }));
            }
        }

        function sendDoseCommand(device_id, dispense_type, amount) {
            const ws = wsMap[device_id];
            if (ws) {
                ws.send(JSON.stringify({
                    command: 'manual_dose',
                    params: { dispense_type: dispense_type, amount: amount }
                }));
                alert(`Dosing ${amount.toFixed(2)}ml of pH ${dispense_type.toUpperCase()}`);
            }
        }

        function updateAllValvesControls(device_id, statusData) {
            const allValvesCard = document.getElementById(`all-valves-card-${device_id}`);
            const allValvesControlsDiv = document.getElementById(`all-valves-controls-${device_id}`);
            const hasValveRelay = statusData.settings?.usb_roles?.valve_relay;
            const valveLabels = statusData.settings?.valve_labels || {};
            const valveRelays = statusData.valve_info?.valve_relays || {};

            // Only show if valve_relay is assigned
            if (!hasValveRelay) {
                allValvesCard.style.display = 'none';
                return;
            }

            allValvesCard.style.display = 'block';

            // Build table HTML
            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="border-bottom: 1px solid #444;">
                                <th style="padding: 0.5rem; text-align: center;">ID</th>
                                <th style="padding: 0.5rem; text-align: left;">Label</th>
                                <th style="padding: 0.5rem; text-align: center;">Status</th>
                                <th style="padding: 0.5rem; text-align: center;">Control</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Iterate through all 8 valve IDs
            for (let i = 1; i <= 8; i++) {
                const valveId = i.toString();
                const label = valveLabels[valveId] || `Valve ${valveId}`;

                // Find status from valve_relays by matching label
                let status = 'unknown';
                Object.keys(valveRelays).forEach(relayLabel => {
                    if (relayLabel === label) {
                        status = valveRelays[relayLabel].status || 'off';
                    }
                });

                tableHTML += `
                    <tr style="border-bottom: 1px solid #333;">
                        <td style="padding: 0.5rem; text-align: center;">${valveId}</td>
                        <td style="padding: 0.5rem;">${label}</td>
                        <td style="padding: 0.5rem; text-align: center;">
                            <span id="all-valve-status-${device_id}-${valveId}">${status}</span>
                        </td>
                        <td style="padding: 0.5rem; text-align: center;">
                            <div class="valve-buttons" style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button id="all-valve-${device_id}-${valveId}-on"
                                    class="${status === 'on' ? 'btn-on-active' : 'btn-inactive'}"
                                    style="width: 50px; padding: 0.4rem; font-size: 0.75rem;">
                                    ON
                                </button>
                                <button id="all-valve-${device_id}-${valveId}-off"
                                    class="${status === 'off' ? 'btn-off-active' : 'btn-inactive'}"
                                    style="width: 50px; padding: 0.4rem; font-size: 0.75rem;">
                                    OFF
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            allValvesControlsDiv.innerHTML = tableHTML;

            // Attach event listeners
            for (let i = 1; i <= 8; i++) {
                const valveId = i.toString();
                const label = valveLabels[valveId] || `Valve ${valveId}`;

                const onBtn = document.getElementById(`all-valve-${device_id}-${valveId}-on`);
                const offBtn = document.getElementById(`all-valve-${device_id}-${valveId}-off`);

                if (onBtn) {
                    onBtn.onclick = (e) => {
                        e.stopPropagation();
                        sendValveCommand(device_id, label, 'on');
                    };
                }

                if (offBtn) {
                    offBtn.onclick = (e) => {
                        e.stopPropagation();
                        sendValveCommand(device_id, label, 'off');
                    };
                }
            }
        }

        window.onload = fetchAndConnectDevices;
        window.onpageshow = (evt) => { if (evt.persisted) window.location.reload(); };
    </script>
    </div>
</body>
</html>