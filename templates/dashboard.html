<!-- templates/dashboard.html - Show statuses for all devices -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Simple styling for data sections */
        .device-section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>Welcome, {{ user.email }}</h1>
    <a href="/auth/logout">Logout</a>
    <a href="/devices">Manage Devices</a>

    <h2>My Devices Statuses</h2>
    <div id="devices-status"></div>

    <script>
        let wsMap = {};  // Store WS per device_id

        // Fetch devices and auto-connect WS for each
        async function fetchAndConnectDevices() {
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const statusDiv = document.getElementById('devices-status');
                statusDiv.innerHTML = '';
                devices.forEach(device => {
                    const deviceSection = document.createElement('div');
                    deviceSection.classList.add('device-section');
                    deviceSection.innerHTML = `
                        <h3>${device.name || device.device_id} - Online: ${device.is_online ? 'Yes' : 'No'}</h3>
                        <div class="data-row"><span>System Name:</span> <span id="system-name-${device.device_id}">Loading...</span></div>
                        <div class="data-row"><span>pH:</span> <span id="ph-${device.device_id}">Loading...</span></div>
                        <div class="data-row"><span>EC:</span> <span id="ec-${device.device_id}">Loading...</span></div>
                        <div class="data-row"><span>Sensor 1:</span> <span id="sensor1-${device.device_id}">Loading...</span></div>
                        <div class="data-row"><span>Sensor 2:</span> <span id="sensor2-${device.device_id}">Loading...</span></div>
                        <div class="data-row"><span>Sensor 3:</span> <span id="sensor3-${device.device_id}">Loading...</span></div>
                        <div class="data-row"><span>Fill Valve:</span> <span id="fill-valve-${device.device_id}">Loading...</span></div>
                        <div class="data-row"><span>Drain Valve:</span> <span id="drain-valve-${device.device_id}">Loading...</span></div>
                        <button onclick="sendDose('${device.device_id}', 'up', 10)">Dose pH Up (10ml)</button>
                        <button onclick="sendDose('${device.device_id}', 'down', 10)">Dose pH Down (10ml)</button>
                        <button id="refresh-${device.device_id}">Refresh</button> <!-- NEW: Refresh button per device -->
                    `;
                    statusDiv.appendChild(deviceSection);

                    // Wire up the refresh button click
                    document.getElementById(`refresh-${device.device_id}`).addEventListener('click', () => {
                        const ws = wsMap[device.device_id];
                        if (ws) {
                            console.log(`[Refresh] Requesting refresh for ${device.device_id}`);
                            ws.send(JSON.stringify({ type: 'request_refresh' }));
                        } else {
                            console.warn(`[Refresh] No WS connection for ${device.device_id}`);
                        }
                    });

                    // Auto-connect WS
                    connectToDevice(device.device_id);
                });
            }
        }

        // Connect to WS for a device
        function connectToDevice(device_id) {
            if (wsMap[device_id]) return;
            const ws = new WebSocket(`wss://${window.location.host}/ws/user/devices/${device_id}`);
            ws.onopen = () => {
                console.log(`Connected to ${device_id}`);
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log(`Received from server for ${device_id}:`, data);
                if (data.type === 'ph_update') {
                    document.getElementById(`ph-${device_id}`).innerHTML = data.ph || 'N/A';
                } else if (data.type === 'status_update' && data.data) {
                    const statusData = data.data;
                    document.getElementById(`system-name-${device_id}`).innerHTML = statusData.settings?.system_name || 'N/A';
                    document.getElementById(`ph-${device_id}`).innerHTML = statusData.current_ph || 'N/A';
                    document.getElementById(`ec-${device_id}`).innerHTML = statusData.current_ec || 'N/A';
                    const water = statusData.water_level || {};
                    document.getElementById(`sensor1-${device_id}`).innerHTML = water.sensor1?.triggered ? 'Triggered' : 'Not Triggered';
                    document.getElementById(`sensor2-${device_id}`).innerHTML = water.sensor2?.triggered ? 'Triggered' : 'Not Triggered';
                    document.getElementById(`sensor3-${device_id}`).innerHTML = water.sensor3?.triggered ? 'Triggered' : 'Not Triggered';
                    const valves = statusData.valve_info?.valve_relays || {};
                    const fillLabel = statusData.valve_info?.fill_valve_label || 'Fill Valve';
                    const drainLabel = statusData.valve_info?.drain_valve_label || 'Drain Valve';
                    document.getElementById(`fill-valve-${device_id}`).innerHTML = valves[fillLabel]?.status || 'N/A';
                    document.getElementById(`drain-valve-${device_id}`).innerHTML = valves[drainLabel]?.status || 'N/A';
                }
            };
            ws.onclose = () => {
                console.log(`Disconnected from ${device_id}`);
                delete wsMap[device_id];
            };
            wsMap[device_id] = ws;
        }

        // Send dose command
        function sendDose(device_id, dispense_type, amount) {
            const ws = wsMap[device_id];
            if (ws) {
                ws.send(JSON.stringify({
                    command: 'manual_dose',
                    params: { dispense_type: dispense_type, amount: amount }
                }));
            }
        }

        // Load devices and auto-connect on page load
        window.onload = fetchAndConnectDevices;

        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };
    </script>
</body>
</html>