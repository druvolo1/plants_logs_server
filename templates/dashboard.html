<!-- templates/dashboard.html - Modern dashboard with improved UI -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Plant Monitoring</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header / Navigation -->
    <header class="header">
        <div class="nav-container">
            <div class="logo">Plant Monitor</div>
            <nav class="nav-links">
                <a href="/dashboard" class="active">Dashboard</a>
                <a href="/devices">Devices</a>
                {% if user.is_superuser %}
                <a href="/admin/users">Users</a>
                {% endif %}
                <a href="/auth/logout" class="btn-outline">Logout</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div style="margin-bottom: 2rem;">
            <h1>Dashboard</h1>
            <p class="text-muted">Welcome back, {{ user.email }}!</p>
        </div>

        <!-- Loading State -->
        <div id="loading" style="text-align: center; padding: 3rem;">
            <div class="spinner"></div>
            <p class="text-muted mt-2">Loading your devices...</p>
        </div>

        <!-- No Devices State -->
        <div id="no-devices" style="display: none; text-align: center; padding: 3rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">ðŸŒ±</div>
            <h2>No Devices Found</h2>
            <p class="text-muted mb-3">Get started by adding your first device</p>
            <a href="/devices" class="btn btn-primary">Add Device</a>
        </div>

        <!-- Devices Grid -->
        <div id="devices-grid" class="grid grid-2" style="display: none;"></div>
    </div>

    <script>
        let devices = [];
        let websockets = {};

        // Fetch devices and create WebSocket connections
        async function fetchAndConnectDevices() {
            try {
                const response = await fetch('/user/devices');
                if (!response.ok) throw new Error('Failed to fetch devices');
                
                devices = await response.json();
                
                document.getElementById('loading').style.display = 'none';
                
                if (devices.length === 0) {
                    document.getElementById('no-devices').style.display = 'block';
                    return;
                }
                
                document.getElementById('devices-grid').style.display = 'grid';
                renderDevices();
                
                // Connect to each device
                devices.forEach(device => connectToDevice(device.device_id));
            } catch (error) {
                console.error('Error fetching devices:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> Failed to load devices. Please refresh the page.
                    </div>
                `;
            }
        }

        function renderDevices() {
            const grid = document.getElementById('devices-grid');
            grid.innerHTML = devices.map(device => createDeviceCard(device)).join('');
        }

        function createDeviceCard(device) {
            return `
                <div class="card device-card" id="device-${device.device_id}">
                    <div class="device-header">
                        <div>
                            <h3 class="device-name">${escapeHtml(device.name || device.device_id.substring(0, 8))}</h3>
                            <div class="status" id="status-${device.device_id}">
                                <span class="status-dot status-offline"></span>
                                <span class="text-muted">Connecting...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="metrics-${device.device_id}">
                        <div class="metric">
                            <span class="metric-label">pH Level</span>
                            <span class="metric-value" id="ph-${device.device_id}">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">EC (Î¼S/cm)</span>
                            <span class="metric-value" id="ec-${device.device_id}">--</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Water Level</span>
                            <span class="metric-value" style="font-size: 1rem;" id="water-${device.device_id}">--</span>
                        </div>
                    </div>

                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                        <h4 style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">VALVES</h4>
                        <div class="flex gap-1" id="valves-${device.device_id}">
                            <span class="text-muted">No data</span>
                        </div>
                    </div>

                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                        <button onclick="openControlPanel('${device.device_id}')" class="btn btn-primary" style="flex: 1;">
                            Control
                        </button>
                        <button onclick="refreshDevice('${device.device_id}')" class="btn btn-secondary">
                            ðŸ”„
                        </button>
                    </div>
                </div>
            `;
        }

        function connectToDevice(deviceId) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws/user/devices/${deviceId}`);
            
            ws.onopen = () => {
                console.log(`âœ“ Connected to ${deviceId}`);
                updateDeviceStatus(deviceId, true);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleDeviceData(deviceId, data);
            };
            
            ws.onerror = (error) => {
                console.error(`âœ— WebSocket error for ${deviceId}:`, error);
                updateDeviceStatus(deviceId, false);
            };
            
            ws.onclose = () => {
                console.log(`Disconnected from ${deviceId}`);
                updateDeviceStatus(deviceId, false);
                delete websockets[deviceId];
                
                // Attempt to reconnect after 5 seconds
                setTimeout(() => {
                    if (!websockets[deviceId]) {
                        console.log(`Attempting to reconnect to ${deviceId}...`);
                        connectToDevice(deviceId);
                    }
                }, 5000);
            };
            
            websockets[deviceId] = ws;
        }

        function updateDeviceStatus(deviceId, isOnline) {
            const statusElement = document.getElementById(`status-${deviceId}`);
            if (!statusElement) return;
            
            if (isOnline) {
                statusElement.innerHTML = `
                    <span class="status-dot status-online"></span>
                    <span class="badge badge-success">Online</span>
                `;
            } else {
                statusElement.innerHTML = `
                    <span class="status-dot status-offline"></span>
                    <span class="badge badge-secondary">Offline</span>
                `;
            }
        }

        function handleDeviceData(deviceId, data) {
            console.log(`Data from ${deviceId}:`, data);
            
            switch(data.type) {
                case 'ph_update':
                    updatePH(deviceId, data.value || data.ph);
                    break;
                case 'ec_update':
                    updateEC(deviceId, data.value);
                    break;
                case 'water_level_update':
                    updateWaterLevel(deviceId, data);
                    break;
                case 'valve_update':
                    updateValve(deviceId, data.label, data.status);
                    break;
                case 'full_sync':
                    handleFullSync(deviceId, data.data);
                    break;
            }
        }

        function updatePH(deviceId, value) {
            const element = document.getElementById(`ph-${deviceId}`);
            if (element && value !== null && value !== undefined) {
                element.textContent = parseFloat(value).toFixed(2);
                // Color code based on pH range
                if (value < 5.5 || value > 6.5) {
                    element.style.color = 'var(--warning)';
                } else {
                    element.style.color = 'var(--success)';
                }
            }
        }

        function updateEC(deviceId, value) {
            const element = document.getElementById(`ec-${deviceId}`);
            if (element && value !== null && value !== undefined) {
                element.textContent = parseFloat(value).toFixed(0);
            }
        }

        function updateWaterLevel(deviceId, data) {
            const element = document.getElementById(`water-${deviceId}`);
            if (!element) return;
            
            // Find the highest triggered sensor
            let level = 'Empty';
            if (data.sensor3?.triggered) level = data.sensor3.label || 'Low';
            if (data.sensor2?.triggered) level = data.sensor2.label || 'Medium';
            if (data.sensor1?.triggered) level = data.sensor1.label || 'Full';
            
            element.textContent = level;
            
            // Color code
            if (level.toLowerCase().includes('empty') || level.toLowerCase().includes('low')) {
                element.style.color = 'var(--danger)';
            } else if (level.toLowerCase().includes('full')) {
                element.style.color = 'var(--success)';
            } else {
                element.style.color = 'var(--warning)';
            }
        }

        function updateValve(deviceId, label, status) {
            const container = document.getElementById(`valves-${deviceId}`);
            if (!container) return;
            
            let valvesHtml = container.innerHTML;
            if (valvesHtml.includes('No data')) {
                valvesHtml = '';
            }
            
            const badgeClass = status === 'on' ? 'badge-success' : 'badge-secondary';
            const valveHtml = `<span class="badge ${badgeClass}">${escapeHtml(label)}: ${status.toUpperCase()}</span>`;
            
            // Update or add valve
            if (!valvesHtml.includes(label)) {
                valvesHtml += valveHtml;
            }
            
            container.innerHTML = valvesHtml || '<span class="text-muted">No valves</span>';
        }

        function handleFullSync(deviceId, data) {
            console.log(`Full sync for ${deviceId}:`, data);
            
            if (data.current_ph !== null && data.current_ph !== undefined) {
                updatePH(deviceId, data.current_ph);
            }
            
            if (data.current_ec !== null && data.current_ec !== undefined) {
                updateEC(deviceId, data.current_ec);
            }
            
            if (data.water_level) {
                updateWaterLevel(deviceId, data.water_level);
            }
            
            if (data.valve_info?.valve_relays) {
                Object.entries(data.valve_info.valve_relays).forEach(([label, info]) => {
                    updateValve(deviceId, label, info.status);
                });
            }
        }

        function refreshDevice(deviceId) {
            const ws = websockets[deviceId];
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'request_refresh' }));
            }
        }

        function openControlPanel(deviceId) {
            // TODO: Implement control panel modal
            alert(`Control panel for ${deviceId} - Coming soon!`);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        window.onload = fetchAndConnectDevices;

        // Force reload on back/forward
        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };

        // Cleanup on unload
        window.onbeforeunload = function() {
            Object.values(websockets).forEach(ws => ws.close());
        };
    </script>
</body>
</html>