<!-- templates/dashboard.html - Show statuses for all devices -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Compact Horizontal Layout */
        .device-section {
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.4) 0%, rgba(30, 41, 59, 0.6) 100%);
            backdrop-filter: blur(10px);
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .device-section:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            border-color: var(--primary);
        }
        
        /* Compact header */
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border);
        }
        
        .device-header:hover {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(30, 41, 59, 0.9) 100%);
        }
        
        .device-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }
        
        .device-name {
            font-size: 1rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-online {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }
        
        .status-offline {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }
        
        .header-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .info-item {
            display: flex;
            align-items: baseline;
            gap: 0.4rem;
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 6px;
        }
        
        .info-item label {
            color: var(--text-muted);
            font-size: 0.75rem;
        }
        
        .info-item span {
            color: var(--primary);
            font-weight: 600;
        }
        
        .expand-icon {
            font-size: 1rem;
            transition: transform 0.3s;
            color: var(--primary);
        }
        
        .expand-icon.expanded {
            transform: rotate(180deg);
        }
        
        /* Expandable content - Horizontal Layout */
        .device-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .device-content.expanded {
            max-height: 500px;
            overflow-x: auto;
        }
        
        .device-content-inner {
            padding: 1rem;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.3) 0%, rgba(30, 41, 59, 0.3) 100%);
        }
        
        /* Horizontal card layout - wider to prevent overflow */
        .cards-grid {
            display: flex;
            gap: 1rem;
            flex-wrap: nowrap;
            min-width: max-content;
        }
        
        /* Compact card styling */
        .card {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 0.65rem;
            min-width: 200px;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }
        
        .card-title {
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--primary);
            border-bottom: 1px solid rgba(16, 185, 129, 0.3);
            padding-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title-text {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .card-title-values {
            display: flex;
            gap: 1rem;
            font-size: 0.7rem;
            text-transform: none;
        }
        
        .card-title-values span {
            color: var(--text-secondary);
        }
        
        .card-title-values strong {
            color: var(--primary);
            margin-left: 0.25rem;
        }
        
        /* Compact water bucket */
        .bucket-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
        }
        
        .water-bucket {
            width: 60px;
            height: 90px;
            border: 2px solid var(--border-light);
            border-top: none;
            border-radius: 0 0 8px 8px;
            position: relative;
            background: linear-gradient(to top, rgba(15, 23, 42, 0.8) 0%, rgba(30, 41, 59, 0.6) 100%);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .water-level {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, 
                rgba(59, 130, 246, 0.9) 0%, 
                rgba(16, 185, 129, 0.7) 50%,
                rgba(16, 185, 129, 0.5) 100%);
            transition: height 0.3s ease;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 -2px 6px rgba(16, 185, 129, 0.5);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        
        .sensor-marker {
            position: absolute;
            left: -12px;
            right: -12px;
            height: 1px;
            background: var(--warning);
            box-shadow: 0 0 4px rgba(245, 158, 11, 0.6);
        }
        
        .sensor-label {
            position: absolute;
            right: -65px;
            font-size: 0.65rem;
            white-space: nowrap;
            color: var(--text-secondary);
            font-weight: 600;
            background: rgba(30, 41, 59, 0.8);
            padding: 0.15rem 0.35rem;
            border-radius: 3px;
        }
        
        .sensor-full { top: 10%; }
        .sensor-low { top: 50%; }
        .sensor-empty { bottom: 5%; }
        
        /* Compact valve controls */
        .valve-group {
            margin-bottom: 0.75rem;
        }
        
        .valve-group:last-child {
            margin-bottom: 0;
        }
        
        .valve-label {
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--text-secondary);
            font-weight: 600;
        }
        
        .valve-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .valve-buttons button {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.6) 0%, rgba(30, 41, 59, 0.8) 100%);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        
        .valve-buttons button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .valve-buttons button.btn-on-active {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border-color: var(--success);
            color: white;
        }
        
        .valve-buttons button.btn-off-active {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            border-color: var(--danger);
            color: white;
        }
        
        .valve-buttons button.btn-inactive {
            opacity: 0.6;
        }
        
        /* Compact pH dosing - removed ph-header since it's in card title now */
        
        .dose-sections {
            display: flex;
            gap: 0.4rem;
            flex-direction: row;
        }
        
        .dose-section {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.4rem;
            flex: 1;
            min-width: 0;
        }
        
        .dose-section h4 {
            font-size: 0.65rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
            color: var(--primary);
            text-transform: uppercase;
        }
        
        .dose-info {
            color: var(--text-secondary);
            margin-bottom: 0.35rem;
            font-size: 0.6rem;
            padding: 0.2rem 0.3rem;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 3px;
            border-left: 2px solid var(--primary);
        }
        
        .dose-button {
            width: 100%;
            padding: 0.3rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.6rem;
            transition: all 0.2s;
            text-transform: uppercase;
            margin-bottom: 0.35rem;
        }
        
        .dose-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }
        
        .dose-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: linear-gradient(135deg, rgba(148, 163, 184, 0.3) 0%, rgba(100, 116, 139, 0.3) 100%);
        }
        
        .manual-section {
            margin-top: 0.35rem;
            padding-top: 0.35rem;
            border-top: 1px solid var(--border);
        }
        
        .manual-section label {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--text-muted);
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        
        .manual-input {
            display: flex;
            gap: 0.25rem;
        }
        
        .manual-input input {
            flex: 1;
            padding: 0.25rem 0.3rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text-primary);
            font-size: 0.65rem;
            min-width: 0;
        }
        
        .manual-input button {
            padding: 0.25rem 0.4rem;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.55rem;
            text-transform: uppercase;
            white-space: nowrap;
        }
        
        /* Make pH dosing card specific width to fit side-by-side sections */
        .card:has(.dose-sections) {
            min-width: 380px;
            max-width: 380px;
        }
        
        /* Scrollbar styling for horizontal scroll */
        .cards-grid::-webkit-scrollbar {
            height: 6px;
        }
        
        .cards-grid::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
        }
        
        .cards-grid::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }
        
        .cards-grid::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav-container">
            <div class="logo">Plant Monitor</div>
            <div class="nav-links">
                <a href="/" class="active">Dashboard</a>
                <a href="/devices">Devices</a>
                <a href="/settings">Settings</a>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Dashboard</h1>
        <div id="devices-container"></div>
    </div>

    <script>
        const wsMap = {};

        async function fetchAndConnectDevices() {
            try {
                const response = await fetch('/user/devices');
                if (!response.ok) {
                    console.error('Failed to fetch devices:', response.status);
                    return;
                }
                const devices = await response.json();
                const container = document.getElementById('devices-container');
                container.innerHTML = '';
                
                devices.forEach(device => {
                    const deviceSection = createDeviceSection(device);
                    container.appendChild(deviceSection);
                    connectWebSocket(device.device_id);
                });
            } catch (error) {
                console.error('Error fetching devices:', error);
            }
        }

        function createDeviceSection(device) {
            const section = document.createElement('div');
            section.className = 'device-section';
            section.id = `device-${device.device_id}`;
            
            section.innerHTML = `
                <div class="device-header" onclick="toggleExpand('${device.device_id}')">
                    <div class="device-header-left">
                        <span class="device-name">Loading...</span>
                        <span id="status-badge-${device.device_id}" class="status-badge status-offline">Offline</span>
                        <div class="header-info">
                            <div class="info-item">
                                <label>PLANT:</label>
                                <span id="plant-${device.device_id}">-</span>
                            </div>
                            <div class="info-item" style="display: none;" id="started-item-${device.device_id}">
                                <label>STARTED:</label>
                                <span id="started-${device.device_id}">-</span>
                            </div>
                            <div class="info-item" style="display: none;" id="weeks-item-${device.device_id}">
                                <label>WEEK:</label>
                                <span id="weeks-${device.device_id}">-</span>
                            </div>
                            <div class="info-item" style="display: none;" id="ph-item-${device.device_id}">
                                <label>PH:</label>
                                <span id="ph-${device.device_id}">-</span>
                            </div>
                            <div class="info-item" style="display: none;" id="ec-item-${device.device_id}">
                                <label>EC:</label>
                                <span id="ec-${device.device_id}">-</span>
                            </div>
                        </div>
                    </div>
                    <span class="expand-icon" id="expand-icon-${device.device_id}">‚ñº</span>
                </div>
                <div class="device-content" id="content-${device.device_id}">
                    <div class="device-content-inner">
                        <div class="cards-grid">
                            <!-- Water Level Card -->
                            <div class="card">
                                <div class="card-title">üíß Water Level</div>
                                <div class="bucket-container">
                                    <div class="water-bucket">
                                        <div class="water-level" id="water-level-${device.device_id}" style="height: 0%;"></div>
                                        <div class="sensor-marker sensor-full">
                                            <span class="sensor-label">Full ‚úì</span>
                                        </div>
                                        <div class="sensor-marker sensor-low">
                                            <span class="sensor-label">Low ‚úó</span>
                                        </div>
                                        <div class="sensor-marker sensor-empty">
                                            <span class="sensor-label">Empty ‚úó</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Valve Controls Card -->
                            <div class="card" id="valves-card-${device.device_id}" style="display: none;">
                                <div class="card-title">üîß Valve Controls</div>
                                <div id="valve-controls-${device.device_id}"></div>
                            </div>
                            
                            <!-- pH Dosing Card -->
                            <div class="card" id="dosing-card-${device.device_id}" style="display: none;">
                                <div class="card-title">
                                    <span class="card-title-text">‚öóÔ∏è pH Dosing</span>
                                    <span class="card-title-values" id="ph-values-${device.device_id}">
                                        <span>Current pH: <strong id="current-ph-${device.device_id}">-</strong></span>
                                        <span>Target: <strong id="target-ph-${device.device_id}">-</strong></span>
                                    </span>
                                </div>
                                <div id="dosing-controls-${device.device_id}"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            return section;
        }

        function toggleExpand(device_id) {
            const content = document.getElementById(`content-${device_id}`);
            const icon = document.getElementById(`expand-icon-${device_id}`);
            
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        function connectWebSocket(device_id) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws/user/devices/${device_id}`);
            wsMap[device_id] = ws;
            
            ws.onopen = () => {
                console.log(`Connected to device ${device_id}`);
                ws.send(JSON.stringify({ type: 'request_refresh' }));
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                // Handle device status messages
                if (data.error === 'Device offline') {
                    updateOnlineStatus(device_id, false);
                } else if (data.type === 'device_status') {
                    updateOnlineStatus(device_id, data.online);
                }
                // Handle full sync (on connect or refresh)
                else if (data.type === 'full_sync' && data.data) {
                    updateOnlineStatus(device_id, true);
                    updateDeviceStatus(device_id, data.data);
                }
                // Handle granular pH update
                else if (data.type === 'ph_update') {
                    updateOnlineStatus(device_id, true);
                    // Only show pH if pH probe is assigned
                    const hasPhProbe = window.deviceHasPhProbe?.[device_id];
                    if (hasPhProbe && data.value !== null && data.value !== undefined) {
                        const phItem = document.getElementById(`ph-item-${device_id}`);
                        phItem.style.display = 'flex';
                        document.getElementById(`ph-${device_id}`).innerHTML = data.value;
                    }
                }
                // Handle granular EC update
                else if (data.type === 'ec_update') {
                    updateOnlineStatus(device_id, true);
                    // Only show EC if EC probe is assigned
                    const hasEcProbe = window.deviceHasEcProbe?.[device_id];
                    if (hasEcProbe && data.value !== null && data.value !== undefined) {
                        const ecItem = document.getElementById(`ec-item-${device_id}`);
                        ecItem.style.display = 'flex';
                        document.getElementById(`ec-${device_id}`).innerHTML = data.value;
                    }
                }
                // Handle granular water level update
                else if (data.type === 'water_level_update') {
                    updateOnlineStatus(device_id, true);
                    updateWaterBucketGranular(device_id, data);
                }
                // Handle granular valve update
                else if (data.type === 'valve_update') {
                    updateOnlineStatus(device_id, true);
                    updateValveStatusGranular(device_id, data);
                }
                // Handle granular dosage update
                else if (data.type === 'dosage_update') {
                    updateOnlineStatus(device_id, true);
                    updateDosingControlsGranular(device_id, data);
                }
            };
            
            ws.onerror = (error) => {
                console.error(`WebSocket error for device ${device_id}:`, error);
            };
            
            ws.onclose = () => {
                console.log(`Disconnected from device ${device_id}`);
                updateOnlineStatus(device_id, false);
                setTimeout(() => connectWebSocket(device_id), 5000);
            };
        }

        function updateOnlineStatus(device_id, isOnline) {
            const statusBadge = document.getElementById(`status-badge-${device_id}`);
            if (statusBadge) {
                statusBadge.textContent = isOnline ? 'Online' : 'Offline';
                statusBadge.className = `status-badge ${isOnline ? 'status-online' : 'status-offline'}`;
            }
        }

        function updateDeviceStatus(device_id, data) {
            // Store whether this device has pH and EC probes for granular updates
            if (!window.deviceHasPhProbe) window.deviceHasPhProbe = {};
            if (!window.deviceHasEcProbe) window.deviceHasEcProbe = {};
            window.deviceHasPhProbe[device_id] = !!data.settings?.ph_probe_usb_device;
            window.deviceHasEcProbe[device_id] = !!data.settings?.ec_probe_usb_device;
            
            // Update device name
            const deviceName = document.querySelector(`#device-${device_id} .device-name`);
            if (deviceName && data.settings?.system_name) {
                deviceName.textContent = data.settings.system_name;
            }
            
            // Update plant name
            if (data.settings?.plant_name) {
                document.getElementById(`plant-${device_id}`).textContent = data.settings.plant_name;
            }
            
            // Update start date and week
            if (data.settings?.start_date) {
                const startedItem = document.getElementById(`started-item-${device_id}`);
                startedItem.style.display = 'flex';
                document.getElementById(`started-${device_id}`).textContent = data.settings.start_date;
                
                try {
                    const weeksItem = document.getElementById(`weeks-item-${device_id}`);
                    const startDate = new Date(data.settings.start_date);
                    const now = new Date();
                    const diffTime = Math.abs(now - startDate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays > 0) {
                        const weeks = Math.floor(diffDays / 7);
                        weeksItem.style.display = 'flex';
                        document.getElementById(`weeks-${device_id}`).innerHTML = weeks;
                    }
                } catch (e) {
                    console.error('Error calculating weeks:', e);
                }
            }
            
            // Update pH - only show if pH probe is assigned
            if (data.settings?.ph_probe_usb_device && data.dosage_info?.current_ph) {
                const phItem = document.getElementById(`ph-item-${device_id}`);
                phItem.style.display = 'flex';
                document.getElementById(`ph-${device_id}`).textContent = data.dosage_info.current_ph;
            }
            
            // Update EC - only show if EC probe is assigned
            if (data.settings?.ec_probe_usb_device && data.ec_info?.current_ec) {
                const ecItem = document.getElementById(`ec-item-${device_id}`);
                if (ecItem) {
                    ecItem.style.display = 'flex';
                    document.getElementById(`ec-${device_id}`).textContent = data.ec_info.current_ec;
                }
            }
            
            // Update water level
            updateWaterLevel(device_id, data.water_level_info);
            
            // Update valves
            updateValveControls(device_id, data);
            
            // Update dosing
            updateDosingControls(device_id, data);
        }

        function updateWaterBucketGranular(device_id, data) {
            const waterLevelDiv = document.getElementById(`water-level-${device_id}`);
            if (!waterLevelDiv) return;
            
            const full = data.full_sensor || false;
            const low = data.low_sensor || false;
            const empty = data.empty_sensor || false;
            
            let heightPercent = 0;
            if (full) heightPercent = 100;
            else if (low) heightPercent = 50;
            else if (empty) heightPercent = 10;
            
            waterLevelDiv.style.height = `${heightPercent}%`;
        }

        function updateValveStatusGranular(device_id, data) {
            if (!data.valve_label || !data.status) return;
            
            // Get the stored valve labels for this device
            const labels = window.deviceValveLabels?.[device_id];
            if (!labels) return;
            
            let valveType = null;
            
            // Determine if this is the fill or drain valve
            if (labels.fillLabel === data.valve_label) {
                valveType = 'fill';
            } else if (labels.drainLabel === data.valve_label) {
                valveType = 'drain';
            }
            
            if (!valveType) return;
            
            // Update status text
            const statusSpan = document.getElementById(`${valveType}-status-${device_id}`);
            if (statusSpan) {
                statusSpan.textContent = data.status === 'on' ? 'On' : 'Off';
            }
            
            // Update button states
            const onBtn = document.getElementById(`${valveType}-on-${device_id}`);
            const offBtn = document.getElementById(`${valveType}-off-${device_id}`);
            
            if (onBtn && offBtn) {
                if (data.status === 'on') {
                    onBtn.className = 'btn-on-active';
                    offBtn.className = 'btn-inactive';
                } else {
                    onBtn.className = 'btn-inactive';
                    offBtn.className = 'btn-off-active';
                }
            }
        }

        function updateWaterLevel(device_id, waterInfo) {
            if (!waterInfo) return;
            
            const waterLevelDiv = document.getElementById(`water-level-${device_id}`);
            const full = waterInfo.full_sensor || false;
            const low = waterInfo.low_sensor || false;
            const empty = waterInfo.empty_sensor || false;
            
            let heightPercent = 0;
            if (full) heightPercent = 100;
            else if (low) heightPercent = 50;
            else if (empty) heightPercent = 10;
            
            waterLevelDiv.style.height = `${heightPercent}%`;
        }

        function updateDosingControlsGranular(device_id, data) {
            const dosingCard = document.getElementById(`dosing-card-${device_id}`);
            
            // Check if pH probe is assigned (store this during full_sync)
            const hasPhProbe = window.deviceHasPhProbe?.[device_id];
            
            if (!hasPhProbe || !data || (data.ph_up_amount === 0 && data.ph_down_amount === 0)) {
                return;
            }
            
            dosingCard.style.display = 'block';
            
            const phUpAmount = data.ph_up_amount || 0;
            const phDownAmount = data.ph_down_amount || 0;
            const phTarget = data.ph_target || '-';
            const currentPh = data.current_ph || '-';
            
            // Update pH values in card title
            const currentPhEl = document.getElementById(`current-ph-${device_id}`);
            const targetPhEl = document.getElementById(`target-ph-${device_id}`);
            if (currentPhEl) currentPhEl.textContent = currentPh;
            if (targetPhEl) targetPhEl.textContent = phTarget;
            
            const dosingControlsDiv = document.getElementById(`dosing-controls-${device_id}`);
            if (dosingControlsDiv) {
                const upInfo = dosingControlsDiv.querySelector('.dose-section:first-child .dose-info');
                const downInfo = dosingControlsDiv.querySelector('.dose-section:last-child .dose-info');
                if (upInfo) upInfo.textContent = `Calculated: ${phUpAmount.toFixed(2)} ml`;
                if (downInfo) downInfo.textContent = `Calculated: ${phDownAmount.toFixed(2)} ml`;
                
                const upCalcBtn = document.getElementById(`dose-up-calc-${device_id}`);
                const downCalcBtn = document.getElementById(`dose-down-calc-${device_id}`);
                if (upCalcBtn) upCalcBtn.disabled = phUpAmount === 0;
                if (downCalcBtn) downCalcBtn.disabled = phDownAmount === 0;
            }
        }

        function updateValveControls(device_id, statusData) {
            const valveControlsDiv = document.getElementById(`valve-controls-${device_id}`);
            const valvesCard = document.getElementById(`valves-card-${device_id}`);
            const fillLabel = statusData.settings?.fill_valve_label;
            const drainLabel = statusData.settings?.drain_valve_label;
            const valveRelays = statusData.valve_info?.valve_relays || {};

            // Store the labels for later use in granular updates
            if (!window.deviceValveLabels) window.deviceValveLabels = {};
            window.deviceValveLabels[device_id] = { fillLabel, drainLabel };

            valveControlsDiv.innerHTML = '';
            
            if (!fillLabel && !drainLabel) {
                valvesCard.style.display = 'none';
                return;
            }
            
            valvesCard.style.display = 'block';

            if (fillLabel) {
                const fillStatus = valveRelays[fillLabel]?.status || 'off';
                const fillGroup = document.createElement('div');
                fillGroup.classList.add('valve-group');
                fillGroup.innerHTML = `
                    <div class="valve-label">${fillLabel}: <strong id="fill-status-${device_id}">${fillStatus === 'on' ? 'On' : 'Off'}</strong></div>
                    <div class="valve-buttons">
                        <button id="fill-on-${device_id}" class="${fillStatus === 'on' ? 'btn-on-active' : 'btn-inactive'}">On</button>
                        <button id="fill-off-${device_id}" class="${fillStatus === 'off' ? 'btn-off-active' : 'btn-inactive'}">Off</button>
                    </div>
                `;
                valveControlsDiv.appendChild(fillGroup);
                document.getElementById(`fill-on-${device_id}`).onclick = (e) => { e.stopPropagation(); sendValveCommand(device_id, fillLabel, 'on'); };
                document.getElementById(`fill-off-${device_id}`).onclick = (e) => { e.stopPropagation(); sendValveCommand(device_id, fillLabel, 'off'); };
            }

            if (drainLabel) {
                const drainStatus = valveRelays[drainLabel]?.status || 'off';
                const drainGroup = document.createElement('div');
                drainGroup.classList.add('valve-group');
                drainGroup.innerHTML = `
                    <div class="valve-label">${drainLabel}: <strong id="drain-status-${device_id}">${drainStatus === 'on' ? 'On' : 'Off'}</strong></div>
                    <div class="valve-buttons">
                        <button id="drain-on-${device_id}" class="${drainStatus === 'on' ? 'btn-on-active' : 'btn-inactive'}">On</button>
                        <button id="drain-off-${device_id}" class="${drainStatus === 'off' ? 'btn-off-active' : 'btn-inactive'}">Off</button>
                    </div>
                `;
                valveControlsDiv.appendChild(drainGroup);
                document.getElementById(`drain-on-${device_id}`).onclick = (e) => { e.stopPropagation(); sendValveCommand(device_id, drainLabel, 'on'); };
                document.getElementById(`drain-off-${device_id}`).onclick = (e) => { e.stopPropagation(); sendValveCommand(device_id, drainLabel, 'off'); };
            }
        }

        function updateDosingControls(device_id, statusData) {
            const dosingControlsDiv = document.getElementById(`dosing-controls-${device_id}`);
            const dosingCard = document.getElementById(`dosing-card-${device_id}`);
            const dosageInfo = statusData.dosage_info;
            const hasPhProbe = statusData.settings?.ph_probe_usb_device;

            // Hide dosing card if no pH probe assigned or no dosage info
            if (!hasPhProbe || !dosageInfo) {
                dosingCard.style.display = 'none';
                return;
            }
            
            dosingCard.style.display = 'block';

            const phUpAmount = dosageInfo.ph_up_amount || 0;
            const phDownAmount = dosageInfo.ph_down_amount || 0;
            const phTarget = dosageInfo.ph_target || '-';
            const currentPh = dosageInfo.current_ph || '-';
            
            // Update pH values in card title
            document.getElementById(`current-ph-${device_id}`).textContent = currentPh;
            document.getElementById(`target-ph-${device_id}`).textContent = phTarget;

            dosingControlsDiv.innerHTML = `
                <div class="dose-sections">
                    <div class="dose-section">
                        <h4>pH Up</h4>
                        <div class="dose-info">Calculated: ${phUpAmount.toFixed(2)} ml</div>
                        <button id="dose-up-calc-${device_id}" class="dose-button" ${phUpAmount === 0 ? 'disabled' : ''}>Dose Calculated</button>
                        <div class="manual-section">
                            <label>Manual Dosing</label>
                            <div class="manual-input">
                                <input type="number" id="manual-up-${device_id}" placeholder="ml" step="0.1" min="0" value="5">
                                <button id="dose-up-manual-${device_id}">Dose</button>
                            </div>
                        </div>
                    </div>
                    <div class="dose-section">
                        <h4>pH Down</h4>
                        <div class="dose-info">Calculated: ${phDownAmount.toFixed(2)} ml</div>
                        <button id="dose-down-calc-${device_id}" class="dose-button" ${phDownAmount === 0 ? 'disabled' : ''}>Dose Calculated</button>
                        <div class="manual-section">
                            <label>Manual Dosing</label>
                            <div class="manual-input">
                                <input type="number" id="manual-down-${device_id}" placeholder="ml" step="0.1" min="0" value="5">
                                <button id="dose-down-manual-${device_id}">Dose</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById(`dose-up-calc-${device_id}`).onclick = (e) => {
                e.stopPropagation();
                if (phUpAmount > 0) sendDoseCommand(device_id, 'up', phUpAmount);
            };
            document.getElementById(`dose-up-manual-${device_id}`).onclick = (e) => {
                e.stopPropagation();
                const amount = parseFloat(document.getElementById(`manual-up-${device_id}`).value) || 0;
                if (amount > 0) sendDoseCommand(device_id, 'up', amount);
                else alert('Please enter a valid amount greater than 0');
            };
            document.getElementById(`dose-down-calc-${device_id}`).onclick = (e) => {
                e.stopPropagation();
                if (phDownAmount > 0) sendDoseCommand(device_id, 'down', phDownAmount);
            };
            document.getElementById(`dose-down-manual-${device_id}`).onclick = (e) => {
                e.stopPropagation();
                const amount = parseFloat(document.getElementById(`manual-down-${device_id}`).value) || 0;
                if (amount > 0) sendDoseCommand(device_id, 'down', amount);
                else alert('Please enter a valid amount greater than 0');
            };
        }

        function sendValveCommand(device_id, valve_label, action) {
            const ws = wsMap[device_id];
            if (ws) {
                ws.send(JSON.stringify({
                    command: 'valve_control',
                    params: { valve_label: valve_label, action: action }
                }));
            }
        }

        function sendDoseCommand(device_id, dispense_type, amount) {
            const ws = wsMap[device_id];
            if (ws) {
                ws.send(JSON.stringify({
                    command: 'manual_dose',
                    params: { dispense_type: dispense_type, amount: amount }
                }));
                alert(`Dosing ${amount.toFixed(2)}ml of pH ${dispense_type.toUpperCase()}`);
            }
        }

        window.onload = fetchAndConnectDevices;
        window.onpageshow = (evt) => { if (evt.persisted) window.location.reload(); };
    </script>
</body>
</html>