<!-- templates/devices.html - Device management page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Devices</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Modern Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #10b981;
        }
        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
            text-decoration: none;
        }
        .navbar-brand:hover {
            color: #34d399;
        }
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar-link {
            padding: 1rem 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .navbar-link:hover {
            background: rgba(16, 185, 129, 0.1);
            border-bottom-color: #10b981;
        }
        .navbar-link.active {
            background: rgba(16, 185, 129, 0.15);
            border-bottom-color: #10b981;
            color: #10b981;
        }
        .navbar-user {
            padding: 1rem 1.25rem;
            color: rgba(148, 163, 184, 0.9);
            font-size: 0.9rem;
            border-left: 1px solid rgba(148, 163, 184, 0.2);
        }
        .navbar-logout {
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .navbar-logout:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        /* Hamburger menu button (hidden on desktop) */
        .navbar-toggle {
            display: none;
            background: none;
            border: none;
            color: #10b981;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .navbar-container {
                padding: 0 1rem;
            }

            .navbar-toggle {
                display: block;
            }

            .navbar-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: #0f172a;
                flex-direction: column;
                gap: 0;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }

            .navbar-menu.active {
                display: flex;
            }

            .navbar-link {
                width: 100%;
                text-align: left;
                border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            }

            .navbar-user {
                width: 100%;
                border-left: none;
                border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            }

            .navbar-logout {
                margin: 0.5rem 1rem;
                width: calc(100% - 2rem);
                text-align: center;
            }
        }

        /* Tablet adjustments */
        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 1rem;
            }

            .navbar-link, .navbar-user {
                font-size: 0.85rem;
                padding: 0.75rem 1rem;
            }
        }

        /* Device Type Icon Bar */
        .device-type-icon-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            z-index: 5;
            font-size: 1.8rem;
            padding: 8px 0;
            border-radius: 8px 0 0 8px;
        }
        .device-type-icon-bar .scope-text {
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        .device-type-feeding {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .device-type-environmental {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .device-type-valve {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }
        .device-type-other {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        /* Linked Devices Section */
        .linked-devices-section {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }

        .linked-devices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .linked-devices-header h4 {
            margin: 0;
            color: #3b82f6;
            font-size: 0.95rem;
        }

        .linked-device-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .linked-device-chip.online {
            border-color: #10b981;
        }

        .linked-device-chip .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .linked-device-chip .status-dot.online {
            background: #10b981;
        }

        .linked-device-chip .status-dot.offline {
            background: #64748b;
        }

        .linked-device-chip .unlink-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0;
            margin-left: 0.25rem;
            font-size: 1rem;
            line-height: 1;
        }

        .linked-device-chip .unlink-btn:hover {
            color: #dc2626;
        }

        .link-device-btn {
            font-size: 0.8rem;
            padding: 0.35rem 0.75rem;
            background: #3b82f6;
        }

        .link-device-btn:hover {
            background: #2563eb;
        }

        /* Heartbeat Settings Button (Admin Only) */
        .heartbeat-btn {
            background: none;
            border: none;
            color: #f59e0b;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            margin-left: 0.5rem;
            transition: all 0.2s;
            vertical-align: middle;
        }
        .heartbeat-btn:hover {
            color: #fbbf24;
            transform: scale(1.1);
        }
        .heartbeat-btn:disabled {
            color: #64748b;
            cursor: not-allowed;
        }

        /* Heartbeat Settings Modal */
        .heartbeat-modal-content {
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1e293b;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .heartbeat-setting {
            margin-bottom: 1.5rem;
        }
        .heartbeat-setting label {
            display: block;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .heartbeat-setting input[type="number"],
        .heartbeat-setting select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #374151;
            background: #0f172a;
            color: #fff;
            font-size: 1rem;
        }
        .heartbeat-setting .hint {
            color: #64748b;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        .heartbeat-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .heartbeat-header h3 {
            margin: 0;
            color: #f59e0b;
        }
        .heartbeat-header .bolt-icon {
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard" class="navbar-brand">
                üå± Plant Monitor
            </a>
            <button class="navbar-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
            <div class="navbar-menu" id="navbar-menu">
                <a href="/dashboard" class="navbar-link">Dashboard</a>
                <a href="/devices" class="navbar-link active">Devices</a>
                <a href="/plants" class="navbar-link">Plants</a>
                <a href="/locations" class="navbar-link">Locations</a>
                <a href="/templates" class="navbar-link">Templates</a>
                {% if user.is_superuser %}
                <a href="/admin/overview" class="navbar-link">Admin Overview</a>
                <a href="/admin/users" class="navbar-link">Users</a>
                {% endif %}
                <span class="navbar-user">{{ user.email }}</span>
                <a href="/auth/logout" class="navbar-logout">Logout</a>
            </div>
        </div>
    </nav>

    <div style="padding: 2rem 1.5rem; max-width: 1400px; margin: 0 auto;">
    <h2 style="color: #10b981; margin-bottom: 1.5rem;">Manage Devices</h2>

    <!-- Add Device form -->
    <h3>Add Device</h3>
    <form id="add-device-form">
        <label for="device_id">Device ID (from Pi):</label>
        <input type="text" id="device_id">
        <br>
        <label for="name">Device Name (optional):</label>
        <input type="text" id="name">
        <br>
        <label for="device_location">Location (optional):</label>
        <select id="device_location">
            <option value="">Unassigned</option>
        </select>
        <br>
        <label style="margin-top: 1rem; display: block; font-weight: normal; color: #888;">OR accept shared device:</label>
        <label for="share_code">Share Code:</label>
        <input type="text" id="share_code" placeholder="Enter 10-character code">
        <br>
        <button type="submit">Add Device / Accept Share</button>
    </form>
    <div id="add-result"></div>

    <!-- Devices list -->
    <h3>My Devices</h3>

    <!-- Search Bar -->
    <div style="margin-bottom: 1.5rem;">
        <input
            type="text"
            id="device-search"
            placeholder="Search devices by name, ID, location, version, or online status..."
            style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid #374151; background: #0f172a; color: #fff; font-size: 1rem;"
            oninput="filterDevices()"
        >
        <p id="search-results-count" style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;"></p>
    </div>

    <div id="devices-list"></div>

    <!-- Share Management Modal -->
    <div id="share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h3 style="color: #10b981; margin-top: 0;">Manage Device Sharing</h3>
            <p style="color: #888; font-size: 0.9rem;" id="share-device-name"></p>

            <!-- Create New Share -->
            <div style="margin: 1.5rem 0; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                <h4 style="margin-top: 0; color: #10b981;">Create New Share Link</h4>
                <div style="margin-bottom: 0.5rem;">
                    <label for="permission-select">Permission Level:</label>
                    <select id="permission-select" style="margin-left: 0.5rem; padding: 0.5rem; border-radius: 4px;">
                        <option value="viewer">View Only</option>
                        <option value="controller">Can Control</option>
                    </select>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <label for="share-expires-type">Expiration:</label>
                    <select id="share-expires-type" onchange="toggleDeviceExpiresInput()" style="margin-left: 0.5rem; padding: 0.5rem; border-radius: 4px;">
                        <option value="days">Expires in days</option>
                        <option value="never">Never expires</option>
                    </select>
                    <input type="number" id="share-expires" value="7" min="1" max="365" style="margin-left: 0.5rem; padding: 0.5rem; border-radius: 4px; width: 80px;">
                </div>
                <button onclick="createShare()" style="margin-left: 1rem;">Generate Share Code</button>
                <div id="share-code-result" style="margin-top: 1rem;"></div>
            </div>

            <!-- Active Shares List -->
            <div style="margin: 1.5rem 0;">
                <h4 style="color: #10b981;">Active Shares</h4>
                <div id="shares-list" style="margin-top: 1rem;"></div>
            </div>

            <button onclick="closeShareModal()" style="background: #64748b; margin-top: 1rem;">Close</button>
        </div>
    </div>

    <!-- Edit Device Modal -->
    <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h3 style="color: #10b981; margin-top: 0;">Edit Device</h3>
            <p style="color: #888; font-size: 0.9rem;" id="edit-device-name"></p>

            <form id="edit-device-form" onsubmit="saveDeviceEdit(event)">
                <div style="margin-bottom: 1rem;">
                    <label for="edit-name" style="display: block; color: #fff; margin-bottom: 0.5rem;">Device Name:</label>
                    <input type="text" id="edit-name" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff;">
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="edit-location" style="display: block; color: #fff; margin-bottom: 0.5rem;">Location:</label>
                    <select id="edit-location" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff;">
                        <option value="">Unassigned</option>
                    </select>
                </div>

                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="submit" style="background: #10b981; flex: 1;">Save Changes</button>
                    <button type="button" onclick="closeEditModal()" style="background: #64748b; flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Link Devices Modal -->
    <div id="link-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.5); max-height: 80vh; overflow-y: auto;">
            <h3 style="color: #3b82f6; margin-top: 0;">Link Environmental Sensors & Valve Controllers</h3>
            <p style="color: #888; font-size: 0.9rem;" id="link-device-name"></p>

            <div style="margin: 1.5rem 0;">
                <h4 style="color: #10b981; margin-bottom: 0.75rem;">Available Devices to Link</h4>
                <div id="available-links-list" style="margin-top: 1rem;"></div>
            </div>

            <div style="margin: 1.5rem 0;">
                <h4 style="color: #3b82f6; margin-bottom: 0.75rem;">Currently Linked Devices</h4>
                <div id="current-links-list" style="margin-top: 1rem;"></div>
            </div>

            <button onclick="closeLinkModal()" style="background: #64748b; margin-top: 1rem;">Close</button>
        </div>
    </div>

    <!-- Heartbeat Settings Modal (Admin Only) -->
    {% if user.is_superuser %}
    <div id="heartbeat-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div class="heartbeat-modal-content">
            <div class="heartbeat-header">
                <span class="bolt-icon">‚ö°</span>
                <h3>Heartbeat Settings</h3>
            </div>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 1.5rem;" id="heartbeat-device-name"></p>

            <div class="heartbeat-setting">
                <label for="heartbeat-use-fahrenheit">Temperature Unit</label>
                <select id="heartbeat-use-fahrenheit">
                    <option value="false">Celsius (¬∞C)</option>
                    <option value="true">Fahrenheit (¬∞F)</option>
                </select>
                <p class="hint">How temperature is displayed on the device</p>
            </div>

            <div class="heartbeat-setting">
                <label for="heartbeat-update-interval">Heartbeat Interval (seconds)</label>
                <input type="number" id="heartbeat-update-interval" min="5" max="3600" value="30">
                <p class="hint">How often the device sends status updates (5-3600 seconds). Lower = more responsive UI but more network traffic.</p>
            </div>

            <div class="heartbeat-setting">
                <label for="heartbeat-log-interval">Logging Interval (seconds)</label>
                <input type="number" id="heartbeat-log-interval" min="60" max="86400" value="3600">
                <p class="hint">How often the device saves data to the database (60-86400 seconds). Default: 3600 (1 hour).</p>
            </div>

            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 3px solid #f59e0b;">
                <p style="margin: 0; color: #f59e0b; font-size: 0.9rem;">
                    <strong>Note:</strong> Changes will take effect on the device's next heartbeat (within the current heartbeat interval).
                </p>
            </div>

            <div style="display: flex; gap: 0.5rem;">
                <button onclick="saveHeartbeatSettings()" style="background: #f59e0b; flex: 1;">Save Settings</button>
                <button onclick="closeHeartbeatModal()" style="background: #64748b; flex: 1;">Cancel</button>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        // Admin status
        const isAdmin = {{ 'true' if user.is_superuser else 'false' }};
        // Store WebSocket connections per device
        let wsMap = {};
        let currentShareDeviceId = null;
        let currentEditDeviceId = null;
        let currentLinkDeviceId = null;
        let currentHeartbeatDeviceId = null;
        let locationsMap = {};
        let allDevices = []; // Store all devices for filtering

        // Helper function to get full location path (e.g., "Dave's House -> Basement")
        function getLocationPath(locationId) {
            if (!locationId || !locationsMap[locationId]) {
                return 'Unassigned';
            }

            const path = [];
            let currentId = locationId;
            let maxDepth = 10; // Prevent infinite loops

            while (currentId && maxDepth > 0) {
                const location = locationsMap[currentId];
                if (!location) break;

                path.unshift(location.name);
                currentId = location.parent_id;
                maxDepth--;
            }

            return path.join(' -> ');
        }

        // Filter devices based on search query
        function filterDevices() {
            const searchQuery = document.getElementById('device-search').value.toLowerCase().trim();

            if (!searchQuery) {
                // No search query, show all devices
                renderDevices(allDevices);
                document.getElementById('search-results-count').textContent = '';
                return;
            }

            const filteredDevices = allDevices.filter(device => {
                // Get device properties for searching
                const systemName = (device.name || '').toLowerCase();
                const deviceId = (device.device_id || '').toLowerCase();
                const locationPath = device.location_id ? getLocationPath(device.location_id).toLowerCase() : 'unassigned';
                const version = (device.version || 'loading...').toLowerCase();

                // Online status - match both "online"/"offline" and "yes"/"no"
                const isOnline = device.is_online;
                const onlineText = isOnline ? 'yes online' : 'no offline';

                // Check if search query matches any field
                return systemName.includes(searchQuery) ||
                       deviceId.includes(searchQuery) ||
                       locationPath.includes(searchQuery) ||
                       version.includes(searchQuery) ||
                       onlineText.includes(searchQuery);
            });

            renderDevices(filteredDevices);

            // Update search results count
            const countText = filteredDevices.length === 1
                ? '1 device found'
                : `${filteredDevices.length} devices found`;
            document.getElementById('search-results-count').textContent = countText;
        }

        // Render devices list (separated from fetching for filtering support)
        function renderDevices(devices) {
            const listDiv = document.getElementById('devices-list');
            listDiv.innerHTML = '';

            if (devices.length === 0) {
                listDiv.innerHTML = '<p style="color: #888;">No devices found</p>';
                return;
            }

            // Group devices by location
            const devicesByLocation = {};
            const unassignedDevices = [];

            devices.forEach(device => {
                if (device.location_id && locationsMap[device.location_id]) {
                    const locationPath = getLocationPath(device.location_id);
                    if (!devicesByLocation[locationPath]) {
                        devicesByLocation[locationPath] = [];
                    }
                    devicesByLocation[locationPath].push(device);
                } else {
                    unassignedDevices.push(device);
                }
            });

            // Render devices grouped by location
            Object.keys(devicesByLocation).sort().forEach(locationName => {
                const locationHeader = document.createElement('h4');
                locationHeader.textContent = `üìç ${locationName}`;
                locationHeader.style.color = '#10b981';
                locationHeader.style.marginTop = '1.5rem';
                locationHeader.style.marginBottom = '1rem';
                listDiv.appendChild(locationHeader);

                devicesByLocation[locationName].forEach(device => {
                    listDiv.appendChild(createDeviceCard(device));
                });
            });

            // Render unassigned devices
            if (unassignedDevices.length > 0) {
                const unassignedHeader = document.createElement('h4');
                unassignedHeader.textContent = 'Unassigned';
                unassignedHeader.style.color = '#64748b';
                unassignedHeader.style.marginTop = '2rem';
                unassignedHeader.style.marginBottom = '1rem';
                listDiv.appendChild(unassignedHeader);

                unassignedDevices.forEach(device => {
                    listDiv.appendChild(createDeviceCard(device));
                });
            }
        }

        // Fetch and display devices list with Update and Delete buttons
        async function fetchDevices() {
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();

                // Fetch locations for grouping and reference
                const locationsResponse = await fetch('/user/locations');
                locationsMap = {};
                if (locationsResponse.ok) {
                    const locations = await locationsResponse.json();
                    locations.forEach(loc => {
                        locationsMap[loc.id] = {
                            name: loc.name,
                            parent_id: loc.parent_id
                        };
                    });
                }

                // Store all devices for filtering
                // Add initial version property for search (will be updated via WebSocket)
                allDevices = devices.map(device => ({
                    ...device,
                    version: 'Loading...'
                }));

                // Render devices
                renderDevices(allDevices);

                // Clear search when refetching
                document.getElementById('device-search').value = '';
                document.getElementById('search-results-count').textContent = '';
            }
        }

        function createDeviceCard(device) {
            const deviceDiv = document.createElement('div');
            deviceDiv.style.marginBottom = '1.5rem';
            deviceDiv.style.padding = '1rem';
            deviceDiv.style.paddingLeft = '70px';
            deviceDiv.style.border = device.active_plant_name ? '2px solid #10b981' : '1px solid #ccc';
            deviceDiv.style.borderRadius = '8px';
            deviceDiv.style.background = device.active_plant_name ? 'rgba(16, 185, 129, 0.05)' : 'transparent';
            deviceDiv.style.position = 'relative';

            // Show ownership info
            const ownershipInfo = device.is_owner
                ? '<p style="color: #10b981; font-size: 0.9rem;">‚úì You own this device</p>'
                : `<p style="color: #f59e0b; font-size: 0.9rem;">üîó Shared by ${device.shared_by_email} (${device.permission_level})</p>`;

            // Show active plant info if in use
            const plantInfo = device.active_plant_name
                ? `<p style="color: #10b981; font-weight: bold; font-size: 1rem; margin: 0.5rem 0;">üå± Monitoring: ${device.active_plant_name} (${device.active_phase})</p>`
                : '';

            // Show location info with full path
            const locationPath = device.location_id ? getLocationPath(device.location_id) : 'Unassigned';
            const locationInfo = `<p><strong>Location:</strong> <span style="color: ${device.location_id ? '#10b981' : '#6b7280'};">üìç ${locationPath}</span></p>`;

            // Only owners can edit, share and delete
            const editButton = device.is_owner
                ? `<button onclick="openEditModal('${device.device_id}')" style="background: #3b82f6;">Edit</button>`
                : '';

            const shareButton = device.is_owner
                ? `<button onclick="openShareModal('${device.device_id}')" style="background: #8b5cf6;">Share</button>`
                : '';

            const deleteButton = device.is_owner
                ? `<button onclick="deleteDevice('${device.device_id}')">Delete</button>`
                : '';

            // Link button for feeding systems only
            const linkButton = (device.is_owner && device.device_type === 'feeding_system')
                ? `<button onclick="openLinkModal('${device.device_id}')" style="background: #3b82f6;">Link Devices</button>`
                : '';

            // Heartbeat settings button (admin only, environmental sensors only)
            const heartbeatButton = (isAdmin && device.device_type === 'environmental')
                ? `<button class="heartbeat-btn" onclick="openHeartbeatModal('${device.device_id}')" title="Heartbeat Settings (Admin)">‚ö°</button>`
                : '';

            // Device type icon bar
            const deviceType = device.device_type || 'feeding_system';
            const scope = device.scope || 'plant';
            const typeMap = {
                'feeding_system': { bgClass: 'device-type-feeding' },
                'environmental': { bgClass: 'device-type-environmental' },
                'valve_controller': { bgClass: 'device-type-valve' },
                'other': { bgClass: 'device-type-other' }
            };
            const type = typeMap[deviceType] || typeMap['other'];
            const scopeText = scope === 'room' ? 'ROOM' : 'PLANT';
            const deviceTypeBar = `<div class="device-type-icon-bar ${type.bgClass}">
                <div class="scope-text">${scopeText}</div>
            </div>`;

            // Linked devices section for feeding systems
            let linkedDevicesSection = '';
            if (device.device_type === 'feeding_system' && device.linked_devices && device.linked_devices.length > 0) {
                const linkedChips = device.linked_devices.map(linked => {
                    const typeIcon = linked.device_type === 'environmental' ? 'üå°Ô∏è' : 'üöø';
                    const statusClass = linked.is_online ? 'online' : '';
                    return `<span class="linked-device-chip ${statusClass}">
                        <span class="status-dot ${statusClass}"></span>
                        ${typeIcon} ${linked.name || linked.system_name || linked.device_id.substring(0, 8)}
                    </span>`;
                }).join('');

                linkedDevicesSection = `
                    <div class="linked-devices-section">
                        <div class="linked-devices-header">
                            <h4>üîó Linked Devices</h4>
                        </div>
                        <div>${linkedChips}</div>
                    </div>
                `;
            } else if (device.device_type === 'feeding_system' && device.is_owner) {
                linkedDevicesSection = `
                    <div class="linked-devices-section" style="background: rgba(100, 116, 139, 0.1); border-left-color: #64748b;">
                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">No linked devices. Click "Link Devices" to add environmental sensors or valve controllers.</p>
                    </div>
                `;
            }

            deviceDiv.innerHTML = `
                ${deviceTypeBar}
                ${ownershipInfo}
                ${plantInfo}
                <p><strong>System Name:</strong> <span id="name-${device.device_id}">${device.name || 'Loading...'}</span>${heartbeatButton}</p>
                <p><strong>Device ID:</strong> ${device.device_id}</p>
                ${locationInfo}
                <p><strong>Version:</strong> <span id="version-${device.device_id}">Loading...</span></p>
                <p><strong>Online:</strong> <span id="online-${device.device_id}">${device.is_online ? 'Yes' : 'No'}</span></p>
                ${linkedDevicesSection}
                ${editButton}
                ${linkButton}
                <button onclick="updateDevice('${device.device_id}')" id="update-btn-${device.device_id}">Update Software</button>
                <button onclick="restartService('${device.device_id}')" id="restart-btn-${device.device_id}">Restart Service</button>
                <button onclick="rebootSystem('${device.device_id}')" id="reboot-btn-${device.device_id}" style="background: #dc2626;">Reboot System</button>
                ${shareButton}
                ${deleteButton}
                <div id="update-status-${device.device_id}" style="margin-top: 0.5rem; color: #10b981;"></div>
            `;

            // Auto-connect to WebSocket for status updates (feeding systems)
            if (device.is_online && device.device_type !== 'environmental') {
                connectToDevice(device.device_id);
            }

            // For environmental sensors, fetch version from environment/latest endpoint
            if (device.device_type === 'environmental') {
                fetchEnvironmentalVersion(device.device_id);
            }

            return deviceDiv;
        }

        // Fetch firmware version for environmental sensors
        async function fetchEnvironmentalVersion(device_id) {
            try {
                const response = await fetch(`/api/devices/${device_id}/environment/latest`);
                if (response.ok) {
                    const data = await response.json();
                    const versionElem = document.getElementById(`version-${device_id}`);
                    if (versionElem && data.firmware_version) {
                        versionElem.textContent = data.firmware_version;
                        // Update in allDevices array for search
                        const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                        if (deviceIndex !== -1) {
                            allDevices[deviceIndex].version = data.firmware_version;
                        }
                    } else if (versionElem) {
                        versionElem.textContent = 'N/A';
                    }
                } else {
                    const versionElem = document.getElementById(`version-${device_id}`);
                    if (versionElem) {
                        versionElem.textContent = 'N/A';
                    }
                }
            } catch (error) {
                console.error(`Error fetching version for ${device_id}:`, error);
                const versionElem = document.getElementById(`version-${device_id}`);
                if (versionElem) {
                    versionElem.textContent = 'N/A';
                }
            }
        }

        // Share Management Functions
        function openShareModal(device_id) {
            currentShareDeviceId = device_id;
            document.getElementById('share-device-name').textContent = `Device: ${device_id}`;
            document.getElementById('share-modal').style.display = 'block';
            loadShares(device_id);
        }

        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
            document.getElementById('share-code-result').innerHTML = '';
            document.getElementById('shares-list').innerHTML = '';
            currentShareDeviceId = null;
        }

        function toggleDeviceExpiresInput() {
            const expiresType = document.getElementById('share-expires-type').value;
            const expiresInput = document.getElementById('share-expires');
            expiresInput.style.display = expiresType === 'never' ? 'none' : 'inline-block';
        }

        async function createShare() {
            const permission = document.getElementById('permission-select').value;
            const expiresType = document.getElementById('share-expires-type').value;
            const expiresInDays = expiresType === 'never' ? null : parseInt(document.getElementById('share-expires').value);

            const response = await fetch(`/user/devices/${currentShareDeviceId}/share`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    permission_level: permission,
                    expires_in_days: expiresInDays
                })
            });

            const resultDiv = document.getElementById('share-code-result');
            if (response.ok) {
                const data = await response.json();
                const expiryText = data.expires_at
                    ? `Expires: ${new Date(data.expires_at).toLocaleString()}`
                    : 'Never expires';
                resultDiv.innerHTML = `
                    <div style="background: rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 6px; margin-top: 0.5rem;">
                        <p style="margin: 0; color: #10b981; font-weight: bold;">Share Code Generated!</p>
                        <p style="margin: 0.5rem 0; font-size: 1.2rem; font-family: monospace; color: #fff;">${data.share_code}</p>
                        <p style="margin: 0; font-size: 0.85rem; color: #888;">${expiryText}</p>
                        <button onclick="navigator.clipboard.writeText('${data.share_code}')" style="margin-top: 0.5rem; font-size: 0.85rem;">Copy Code</button>
                    </div>
                `;
                // Reload shares list
                loadShares(currentShareDeviceId);
            } else {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Failed to create share</p>`;
            }
        }

        async function loadShares(device_id) {
            const response = await fetch(`/user/devices/${device_id}/shares`);
            if (response.ok) {
                const shares = await response.json();
                const sharesDiv = document.getElementById('shares-list');

                if (shares.length === 0) {
                    sharesDiv.innerHTML = '<p style="color: #888;">No active shares</p>';
                    return;
                }

                sharesDiv.innerHTML = '';
                shares.forEach(share => {
                    const shareDiv = document.createElement('div');
                    shareDiv.style.padding = '1rem';
                    shareDiv.style.marginBottom = '0.5rem';
                    shareDiv.style.background = 'rgba(100, 116, 139, 0.2)';
                    shareDiv.style.borderRadius = '6px';

                    const statusText = share.accepted_at
                        ? `Accepted by ${share.shared_with_email}`
                        : `Pending (Code: ${share.share_code})`;

                    let expiryText;
                    if (share.expires_at === null) {
                        expiryText = 'Never expires';
                    } else {
                        const expiryDate = new Date(share.expires_at);
                        expiryText = expiryDate > new Date()
                            ? `Expires: ${expiryDate.toLocaleString()}`
                            : '<span style="color: #ef4444;">Expired</span>';
                    }

                    shareDiv.innerHTML = `
                        <p style="margin: 0 0 0.5rem 0;"><strong>${statusText}</strong></p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">Permission: ${share.permission_level}</p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">${expiryText}</p>
                        ${share.accepted_at ? `
                            <select id="perm-${share.id}" style="margin-top: 0.5rem; margin-right: 0.5rem;">
                                <option value="viewer" ${share.permission_level === 'viewer' ? 'selected' : ''}>View Only</option>
                                <option value="controller" ${share.permission_level === 'controller' ? 'selected' : ''}>Can Control</option>
                            </select>
                            <button onclick="updatePermission(${share.id})" style="font-size: 0.85rem;">Update</button>
                        ` : ''}
                        <button onclick="revokeShare(${share.id})" style="background: #dc2626; font-size: 0.85rem; margin-top: 0.5rem;">Revoke</button>
                    `;
                    sharesDiv.appendChild(shareDiv);
                });
            }
        }

        async function revokeShare(share_id) {
            if (!confirm('Are you sure you want to revoke this share?')) return;

            const response = await fetch(`/user/devices/shares/${share_id}`, { method: 'DELETE' });
            if (response.ok) {
                loadShares(currentShareDeviceId);
                alert('Share revoked successfully');
            } else {
                alert('Failed to revoke share');
            }
        }

        async function updatePermission(share_id) {
            const permission = document.getElementById(`perm-${share_id}`).value;
            const response = await fetch(`/user/devices/shares/${share_id}/permission`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ permission_level: permission })
            });

            if (response.ok) {
                alert('Permission updated successfully');
                loadShares(currentShareDeviceId);
            } else {
                alert('Failed to update permission');
            }
        }

        // Edit Device Functions
        async function openEditModal(device_id) {
            currentEditDeviceId = device_id;

            // Fetch current device data
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const device = devices.find(d => d.device_id === device_id);

                if (device) {
                    document.getElementById('edit-device-name').textContent = `Device: ${device_id}`;
                    document.getElementById('edit-name').value = device.name || '';

                    // Populate locations dropdown
                    const locationsResponse = await fetch('/user/locations');
                    if (locationsResponse.ok) {
                        const locations = await locationsResponse.json();
                        const select = document.getElementById('edit-location');
                        select.innerHTML = '<option value="">Unassigned</option>';

                        const ownedLocations = locations.filter(loc => loc.is_owner);
                        ownedLocations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.id;
                            option.textContent = loc.name;
                            if (device.location_id === loc.id) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                    }

                    document.getElementById('edit-modal').style.display = 'block';
                }
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditDeviceId = null;
        }

        // Device Linking Functions
        async function openLinkModal(device_id) {
            currentLinkDeviceId = device_id;
            document.getElementById('link-device-name').textContent = `Feeding System: ${device_id}`;
            document.getElementById('link-modal').style.display = 'block';
            await loadAvailableLinks(device_id);
            await loadCurrentLinks(device_id);
        }

        function closeLinkModal() {
            document.getElementById('link-modal').style.display = 'none';
            currentLinkDeviceId = null;
        }

        async function loadAvailableLinks(device_id) {
            const listDiv = document.getElementById('available-links-list');
            listDiv.innerHTML = '<p style="color: #888;">Loading...</p>';

            try {
                const response = await fetch(`/user/devices/${device_id}/available-links`);
                if (response.ok) {
                    const available = await response.json();

                    if (available.length === 0) {
                        listDiv.innerHTML = '<p style="color: #888;">No devices available to link. Add environmental sensors or valve controllers first.</p>';
                        return;
                    }

                    listDiv.innerHTML = '';
                    available.forEach(device => {
                        const deviceDiv = document.createElement('div');
                        deviceDiv.style.cssText = 'padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(100, 116, 139, 0.2); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;';

                        const typeIcon = device.device_type === 'environmental' ? 'üå°Ô∏è' : 'üöø';
                        const typeName = device.device_type === 'environmental' ? 'Environmental Sensor' : 'Valve Controller';
                        const locationBadge = device.is_same_location
                            ? '<span style="background: #10b98130; color: #10b981; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Same Location</span>'
                            : '';

                        deviceDiv.innerHTML = `
                            <div>
                                <p style="margin: 0; font-weight: 600; color: #fff;">${typeIcon} ${device.name || device.system_name || 'Unnamed Device'}${locationBadge}</p>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #888;">${typeName} ‚Ä¢ ${device.location_name || 'No location'}</p>
                                <p style="margin: 0; font-size: 0.75rem; color: #64748b;">${device.device_id}</p>
                            </div>
                            <button onclick="linkDevice('${device.device_id}', '${device.device_type}')" style="background: #10b981; font-size: 0.85rem;">Link</button>
                        `;
                        listDiv.appendChild(deviceDiv);
                    });
                } else {
                    listDiv.innerHTML = '<p style="color: #ef4444;">Failed to load available devices</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p style="color: #ef4444;">Error loading available devices</p>';
            }
        }

        async function loadCurrentLinks(device_id) {
            const listDiv = document.getElementById('current-links-list');
            listDiv.innerHTML = '<p style="color: #888;">Loading...</p>';

            try {
                const response = await fetch(`/user/devices/${device_id}/links`);
                if (response.ok) {
                    const links = await response.json();

                    if (links.length === 0) {
                        listDiv.innerHTML = '<p style="color: #888;">No devices currently linked.</p>';
                        return;
                    }

                    listDiv.innerHTML = '';
                    links.forEach(link => {
                        const linkDiv = document.createElement('div');
                        linkDiv.style.cssText = 'padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(59, 130, 246, 0.2); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;';

                        const typeIcon = link.child_device_type === 'environmental' ? 'üå°Ô∏è' : 'üöø';
                        const statusDot = link.child_device_is_online
                            ? '<span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block; margin-right: 0.5rem;"></span>'
                            : '<span style="width: 8px; height: 8px; background: #64748b; border-radius: 50%; display: inline-block; margin-right: 0.5rem;"></span>';
                        const inheritedBadge = link.is_location_inherited
                            ? '<span style="background: #f59e0b30; color: #f59e0b; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Auto (Location)</span>'
                            : '';

                        linkDiv.innerHTML = `
                            <div>
                                <p style="margin: 0; font-weight: 600; color: #fff;">${statusDot}${typeIcon} ${link.child_device_name || link.child_device_system_name || 'Unnamed Device'}${inheritedBadge}</p>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: #64748b;">${link.child_device_id}</p>
                            </div>
                            <button onclick="unlinkDevice(${link.id})" style="background: #dc2626; font-size: 0.85rem;">Unlink</button>
                        `;
                        listDiv.appendChild(linkDiv);
                    });
                } else {
                    listDiv.innerHTML = '<p style="color: #ef4444;">Failed to load linked devices</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p style="color: #ef4444;">Error loading linked devices</p>';
            }
        }

        async function linkDevice(childDeviceId, deviceType) {
            const linkType = deviceType === 'environmental' ? 'environmental' : 'valve_controller';

            try {
                const response = await fetch(`/user/devices/${currentLinkDeviceId}/links`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        child_device_id: childDeviceId,
                        link_type: linkType
                    })
                });

                if (response.ok) {
                    // Reload both lists
                    await loadAvailableLinks(currentLinkDeviceId);
                    await loadCurrentLinks(currentLinkDeviceId);
                    // Also refresh the main devices list to update the linked devices display
                    fetchDevices();
                } else {
                    const error = await response.json();
                    alert(`Failed to link device: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Error linking device');
            }
        }

        async function unlinkDevice(linkId) {
            if (!confirm('Are you sure you want to unlink this device?')) return;

            try {
                const response = await fetch(`/user/devices/${currentLinkDeviceId}/links/${linkId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Reload both lists
                    await loadAvailableLinks(currentLinkDeviceId);
                    await loadCurrentLinks(currentLinkDeviceId);
                    // Also refresh the main devices list to update the linked devices display
                    fetchDevices();
                } else {
                    const error = await response.json();
                    alert(`Failed to unlink device: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Error unlinking device');
            }
        }

        // Heartbeat Settings Functions (Admin Only)
        async function openHeartbeatModal(device_id) {
            if (!isAdmin) return;

            currentHeartbeatDeviceId = device_id;
            document.getElementById('heartbeat-device-name').textContent = `Device: ${device_id}`;
            document.getElementById('heartbeat-modal').style.display = 'block';

            // Load current settings
            try {
                const response = await fetch(`/admin/devices/${device_id}/heartbeat-settings`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('heartbeat-use-fahrenheit').value = data.use_fahrenheit ? 'true' : 'false';
                    document.getElementById('heartbeat-update-interval').value = data.update_interval || 30;
                    document.getElementById('heartbeat-log-interval').value = data.log_interval || 3600;

                    // Update device name display if available
                    if (data.device_name) {
                        document.getElementById('heartbeat-device-name').textContent = `Device: ${data.device_name} (${device_id.substring(0, 8)}...)`;
                    }
                } else {
                    alert('Failed to load heartbeat settings');
                    closeHeartbeatModal();
                }
            } catch (error) {
                console.error('Error loading heartbeat settings:', error);
                alert('Error loading heartbeat settings');
                closeHeartbeatModal();
            }
        }

        function closeHeartbeatModal() {
            document.getElementById('heartbeat-modal').style.display = 'none';
            currentHeartbeatDeviceId = null;
        }

        async function saveHeartbeatSettings() {
            if (!currentHeartbeatDeviceId) return;

            const useFahrenheit = document.getElementById('heartbeat-use-fahrenheit').value === 'true';
            const updateInterval = parseInt(document.getElementById('heartbeat-update-interval').value);
            const logInterval = parseInt(document.getElementById('heartbeat-log-interval').value);

            // Validate inputs
            if (updateInterval < 5 || updateInterval > 3600) {
                alert('Heartbeat interval must be between 5 and 3600 seconds');
                return;
            }
            if (logInterval < 60 || logInterval > 86400) {
                alert('Logging interval must be between 60 and 86400 seconds');
                return;
            }

            try {
                const params = new URLSearchParams({
                    use_fahrenheit: useFahrenheit,
                    update_interval: updateInterval,
                    log_interval: logInterval
                });

                const response = await fetch(`/admin/devices/${currentHeartbeatDeviceId}/heartbeat-settings?${params}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('Heartbeat settings saved! Changes will apply on the device\'s next heartbeat.');
                    closeHeartbeatModal();
                } else {
                    const error = await response.json();
                    alert(`Failed to save settings: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error saving heartbeat settings:', error);
                alert('Error saving heartbeat settings');
            }
        }

        async function saveDeviceEdit(event) {
            event.preventDefault();

            const name = document.getElementById('edit-name').value;
            const location_id = document.getElementById('edit-location').value;

            const payload = { name: name };
            if (location_id) {
                payload.location_id = parseInt(location_id);
            } else {
                payload.location_id = null;
            }

            const response = await fetch(`/user/devices/${currentEditDeviceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                closeEditModal();
                fetchDevices(); // Reload devices list
                alert('Device updated successfully');
            } else {
                const error = await response.json();
                alert(`Failed to update device: ${error.detail || 'Unknown error'}`);
            }
        }

        // Delete device function
        async function deleteDevice(device_id) {
            if (confirm(`Are you sure you want to delete device ${device_id}?`)) {
                const response = await fetch(`/user/devices/${device_id}`, { method: 'DELETE' });
                if (response.ok) {
                    // Close WebSocket connection if exists
                    if (wsMap[device_id]) {
                        wsMap[device_id].close();
                        delete wsMap[device_id];
                    }

                    // Remove the device div from DOM instead of rebuilding entire list
                    const deviceElements = document.querySelectorAll('#devices-list > div');
                    for (let elem of deviceElements) {
                        if (elem.innerHTML.includes(device_id)) {
                            elem.remove();
                            break;
                        }
                    }

                    alert('Device deleted successfully');
                } else {
                    alert('Failed to delete device');
                }
            }
        }

        // Connect to WS for status updates
        function connectToDevice(device_id) {
            if (wsMap[device_id]) return;
            const ws = new WebSocket(`wss://${window.location.host}/ws/user/devices/${device_id}`);
            ws.onopen = () => {
                console.log(`Connected to ${device_id}`);
                // Version info is automatically included in full_sync from device
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log(`Received from server for ${device_id}:`, data);
                console.log(`Message type: ${data.type}`);
                if (data.type === 'full_sync' || data.type === 'status_update') {
                    console.log(`Has data.data? ${!!data.data}`);
                    console.log(`Has data.data.settings? ${!!(data.data && data.data.settings)}`);
                    console.log(`Version in data: ${data.data?.settings?.current_version}`);
                }

                // Update system name from settings
                if (data.type === 'settings_update' && data.system_name) {
                    document.getElementById(`name-${device_id}`).textContent = data.system_name;
                    // Update in allDevices array for search
                    const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                    if (deviceIndex !== -1) {
                        allDevices[deviceIndex].name = data.system_name;
                    }
                }

                // Update version from full_sync or status_update
                if ((data.type === 'full_sync' || data.type === 'status_update') && data.data && data.data.settings) {
                    if (data.data.settings.current_version) {
                        document.getElementById(`version-${device_id}`).textContent = data.data.settings.current_version;

                        // Update in allDevices array for search
                        const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                        if (deviceIndex !== -1) {
                            allDevices[deviceIndex].version = data.data.settings.current_version;
                        }

                        // Check if this device was updating and clear the status message
                        if (localStorage.getItem(`updating_${device_id}`) === 'true') {
                            const statusDiv = document.getElementById(`update-status-${device_id}`);
                            const updateBtn = document.getElementById(`update-btn-${device_id}`);
                            if (statusDiv) {
                                statusDiv.textContent = 'Update completed successfully!';
                                statusDiv.style.color = '#10b981';
                                setTimeout(() => {
                                    statusDiv.textContent = '';
                                }, 5000);
                            }
                            if (updateBtn) {
                                updateBtn.disabled = false;
                            }
                            localStorage.removeItem(`updating_${device_id}`);
                        }
                    }
                    if (data.data.settings.system_name) {
                        document.getElementById(`name-${device_id}`).textContent = data.data.settings.system_name;
                        // Update in allDevices array for search
                        const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                        if (deviceIndex !== -1) {
                            allDevices[deviceIndex].name = data.data.settings.system_name;
                        }
                    }
                }

                // Handle device status changes (online/offline)
                if (data.type === 'device_status') {
                    const onlineElem = document.getElementById(`online-${device_id}`);
                    if (onlineElem) {
                        onlineElem.textContent = data.online ? 'Yes' : 'No';
                    }
                    // Update in allDevices array for search
                    const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                    if (deviceIndex !== -1) {
                        allDevices[deviceIndex].is_online = data.online;
                    }
                }
            };
            ws.onclose = () => {
                console.log(`Disconnected from ${device_id}`);
                const onlineElem = document.getElementById(`online-${device_id}`);
                if (onlineElem) {
                    onlineElem.textContent = 'No';
                }
                // Update in allDevices array for search
                const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                if (deviceIndex !== -1) {
                    allDevices[deviceIndex].is_online = false;
                }
                delete wsMap[device_id];
            };
            wsMap[device_id] = ws;
        }

        // Update device software
        function updateDevice(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('This will update the software on the device. Continue?')) {
                return;
            }

            const statusDiv = document.getElementById(`update-status-${device_id}`);
            const updateBtn = document.getElementById(`update-btn-${device_id}`);

            statusDiv.textContent = 'Sending update command...';
            updateBtn.disabled = true;

            // Send update command via WebSocket
            ws.send(JSON.stringify({
                command: 'update_software'
            }));

            // Show progress message
            setTimeout(() => {
                statusDiv.textContent = 'Update in progress... The device will restart when complete.';
            }, 1000);

            // Re-enable button after 30 seconds
            setTimeout(() => {
                updateBtn.disabled = false;
                statusDiv.textContent = 'Update command sent. Please wait for the device to restart.';
            }, 30000);

            // Mark that this device is updating so we can clear status when it reconnects
            localStorage.setItem(`updating_${device_id}`, 'true');
        }

        // Restart service
        function restartService(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('This will restart the garden service on the device. Continue?')) {
                return;
            }

            const statusDiv = document.getElementById(`update-status-${device_id}`);
            const restartBtn = document.getElementById(`restart-btn-${device_id}`);

            statusDiv.textContent = 'Restarting service...';
            statusDiv.style.color = '#f59e0b';
            restartBtn.disabled = true;

            // Send restart command via WebSocket
            ws.send(JSON.stringify({
                command: 'restart_service'
            }));

            // Re-enable button after 10 seconds
            setTimeout(() => {
                restartBtn.disabled = false;
                statusDiv.textContent = 'Service restart command sent.';
                statusDiv.style.color = '#10b981';
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 3000);
            }, 10000);
        }

        // Reboot system
        function rebootSystem(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('WARNING: This will reboot the entire Raspberry Pi system. Continue?')) {
                return;
            }

            const statusDiv = document.getElementById(`update-status-${device_id}`);
            const rebootBtn = document.getElementById(`reboot-btn-${device_id}`);

            statusDiv.textContent = 'Rebooting system...';
            statusDiv.style.color = '#dc2626';
            rebootBtn.disabled = true;

            // Send reboot command via WebSocket
            ws.send(JSON.stringify({
                command: 'reboot_system'
            }));

            // Re-enable button after 60 seconds (system reboot takes longer)
            setTimeout(() => {
                rebootBtn.disabled = false;
                statusDiv.textContent = 'System reboot command sent. Device will be offline briefly.';
                statusDiv.style.color = '#10b981';
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 5000);
            }, 60000);
        }

        // Add form submit - handle both device adding and share code acceptance
        document.getElementById('add-device-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const device_id = document.getElementById('device_id').value.trim();
            const name = document.getElementById('name').value.trim();
            const share_code = document.getElementById('share_code').value.trim();
            const resultDiv = document.getElementById('add-result');

            // If share code is provided, accept share
            if (share_code) {
                const response = await fetch('/user/devices/accept-share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ share_code: share_code })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<p style="color: #10b981;">‚úì Device share accepted successfully! Device ID: ${data.device_id}</p>`;
                    document.getElementById('share_code').value = '';
                    fetchDevices();  // Reload list
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<p style="color: #ef4444;">Error: ${error.detail}</p>`;
                }
            }
            // Otherwise, add new device
            else if (device_id) {
                const location_id = document.getElementById('device_location').value;
                const payload = { device_id: device_id, name: name };
                if (location_id) {
                    payload.location_id = parseInt(location_id);
                }

                const response = await fetch('/user/devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<p style="color: #10b981;">Device added! API Key: <strong>${data.api_key}</strong> (copy to Pi settings.json as "api_key")</p>`;
                    document.getElementById('device_id').value = '';
                    document.getElementById('name').value = '';
                    fetchDevices();  // Reload list
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<p style="color: #ef4444;">Error: ${error.detail}</p>`;
                }
            } else {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Please enter either a Device ID or a Share Code</p>`;
            }
        });

        // Load devices on page load
        async function fetchLocations() {
            const response = await fetch('/user/locations');
            if (response.ok) {
                const locations = await response.json();
                const select = document.getElementById('device_location');
                select.innerHTML = '<option value="">Unassigned</option>';

                // Only show owned locations
                const ownedLocations = locations.filter(loc => loc.is_owner);
                ownedLocations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc.id;
                    option.textContent = loc.name;
                    select.appendChild(option);
                });
            }
        }

        window.onload = function() {
            fetchDevices();
            fetchLocations();
        };

        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('active');
        }
    </script>
    </div>
</body>
</html>