<!-- templates/devices.html - Device management page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Devices</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Modern Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #10b981;
        }
        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
            text-decoration: none;
        }
        .navbar-brand:hover {
            color: #34d399;
        }
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar-link {
            padding: 1rem 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .navbar-link:hover {
            background: rgba(16, 185, 129, 0.1);
            border-bottom-color: #10b981;
        }
        .navbar-link.active {
            background: rgba(16, 185, 129, 0.15);
            border-bottom-color: #10b981;
            color: #10b981;
        }
        .navbar-user {
            padding: 1rem 1.25rem;
            color: rgba(148, 163, 184, 0.9);
            font-size: 0.9rem;
            border-left: 1px solid rgba(148, 163, 184, 0.2);
        }
        .navbar-logout {
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .navbar-logout:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard" class="navbar-brand">
                ðŸŒ± Plant Monitor
            </a>
            <div class="navbar-menu">
                <a href="/dashboard" class="navbar-link">Dashboard</a>
                <a href="/devices" class="navbar-link active">Devices</a>
                {% if user.is_superuser %}
                <a href="/admin/users" class="navbar-link">Users</a>
                {% endif %}
                <span class="navbar-user">{{ user.email }}</span>
                <a href="/auth/logout" class="navbar-logout">Logout</a>
            </div>
        </div>
    </nav>

    <div style="padding: 2rem 1.5rem; max-width: 1400px; margin: 0 auto;">
    <h2 style="color: #10b981; margin-bottom: 1.5rem;">Manage Devices</h2>

    <!-- Add Device form -->
    <h3>Add Device</h3>
    <form id="add-device-form">
        <label for="device_id">Device ID (from Pi):</label>
        <input type="text" id="device_id" required>
        <br>
        <label for="name">Device Name (optional):</label>
        <input type="text" id="name">
        <br>
        <button type="submit">Add Device</button>
    </form>
    <div id="add-result"></div>

    <!-- Devices list -->
    <h3>My Devices</h3>
    <div id="devices-list"></div>

    <script>
        // Store WebSocket connections per device
        let wsMap = {};

        // Fetch and display devices list with Update and Delete buttons
        async function fetchDevices() {
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const listDiv = document.getElementById('devices-list');
                listDiv.innerHTML = '';
                devices.forEach(device => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.style.marginBottom = '1.5rem';
                    deviceDiv.style.padding = '1rem';
                    deviceDiv.style.border = '1px solid #ccc';
                    deviceDiv.style.borderRadius = '8px';
                    deviceDiv.innerHTML = `
                        <p><strong>System Name:</strong> <span id="name-${device.device_id}">${device.name || 'Loading...'}</span></p>
                        <p><strong>Device ID:</strong> ${device.device_id}</p>
                        <p><strong>Version:</strong> <span id="version-${device.device_id}">Loading...</span></p>
                        <p><strong>Online:</strong> <span id="online-${device.device_id}">${device.is_online ? 'Yes' : 'No'}</span></p>
                        <button onclick="updateDevice('${device.device_id}')" id="update-btn-${device.device_id}">Update Software</button>
                        <button onclick="deleteDevice('${device.device_id}')">Delete</button>
                        <div id="update-status-${device.device_id}" style="margin-top: 0.5rem; color: #10b981;"></div>
                    `;
                    listDiv.appendChild(deviceDiv);

                    // Auto-connect to WebSocket for status updates
                    if (device.is_online) {
                        connectToDevice(device.device_id);
                    }
                });
            }
        }

        // Delete device function
        async function deleteDevice(device_id) {
            if (confirm(`Are you sure you want to delete device ${device_id}?`)) {
                const response = await fetch(`/user/devices/${device_id}`, { method: 'DELETE' });
                if (response.ok) {
                    // Close WebSocket connection if exists
                    if (wsMap[device_id]) {
                        wsMap[device_id].close();
                        delete wsMap[device_id];
                    }

                    // Remove the device div from DOM instead of rebuilding entire list
                    const deviceElements = document.querySelectorAll('#devices-list > div');
                    for (let elem of deviceElements) {
                        if (elem.innerHTML.includes(device_id)) {
                            elem.remove();
                            break;
                        }
                    }

                    alert('Device deleted successfully');
                } else {
                    alert('Failed to delete device');
                }
            }
        }

        // Connect to WS for status updates
        function connectToDevice(device_id) {
            if (wsMap[device_id]) return;
            const ws = new WebSocket(`wss://${window.location.host}/ws/user/devices/${device_id}`);
            ws.onopen = () => {
                console.log(`Connected to ${device_id}`);
                // Version info is automatically included in full_sync from device
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log(`Received from server for ${device_id}:`, data);
                console.log(`Message type: ${data.type}`);
                if (data.type === 'full_sync' || data.type === 'status_update') {
                    console.log(`Has data.data? ${!!data.data}`);
                    console.log(`Has data.data.settings? ${!!(data.data && data.data.settings)}`);
                    console.log(`Version in data: ${data.data?.settings?.current_version}`);
                }

                // Update system name from settings
                if (data.type === 'settings_update' && data.system_name) {
                    document.getElementById(`name-${device_id}`).textContent = data.system_name;
                }

                // Update version from full_sync or status_update
                if ((data.type === 'full_sync' || data.type === 'status_update') && data.data && data.data.settings) {
                    if (data.data.settings.current_version) {
                        document.getElementById(`version-${device_id}`).textContent = data.data.settings.current_version;

                        // Check if this device was updating and clear the status message
                        if (localStorage.getItem(`updating_${device_id}`) === 'true') {
                            const statusDiv = document.getElementById(`update-status-${device_id}`);
                            const updateBtn = document.getElementById(`update-btn-${device_id}`);
                            if (statusDiv) {
                                statusDiv.textContent = 'Update completed successfully!';
                                statusDiv.style.color = '#10b981';
                                setTimeout(() => {
                                    statusDiv.textContent = '';
                                }, 5000);
                            }
                            if (updateBtn) {
                                updateBtn.disabled = false;
                            }
                            localStorage.removeItem(`updating_${device_id}`);
                        }
                    }
                    if (data.data.settings.system_name) {
                        document.getElementById(`name-${device_id}`).textContent = data.data.settings.system_name;
                    }
                }

                // Handle device status changes (online/offline)
                if (data.type === 'device_status') {
                    const onlineElem = document.getElementById(`online-${device_id}`);
                    if (onlineElem) {
                        onlineElem.textContent = data.online ? 'Yes' : 'No';
                    }
                }
            };
            ws.onclose = () => {
                console.log(`Disconnected from ${device_id}`);
                const onlineElem = document.getElementById(`online-${device_id}`);
                if (onlineElem) {
                    onlineElem.textContent = 'No';
                }
                delete wsMap[device_id];
            };
            wsMap[device_id] = ws;
        }

        // Update device software
        function updateDevice(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('This will update the software on the device. Continue?')) {
                return;
            }

            const statusDiv = document.getElementById(`update-status-${device_id}`);
            const updateBtn = document.getElementById(`update-btn-${device_id}`);

            statusDiv.textContent = 'Sending update command...';
            updateBtn.disabled = true;

            // Send update command via WebSocket
            ws.send(JSON.stringify({
                command: 'update_software'
            }));

            // Show progress message
            setTimeout(() => {
                statusDiv.textContent = 'Update in progress... The device will restart when complete.';
            }, 1000);

            // Re-enable button after 30 seconds
            setTimeout(() => {
                updateBtn.disabled = false;
                statusDiv.textContent = 'Update command sent. Please wait for the device to restart.';
            }, 30000);

            // Mark that this device is updating so we can clear status when it reconnects
            localStorage.setItem(`updating_${device_id}`, 'true');
        }

        // Add form submit
        document.getElementById('add-device-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const device_id = document.getElementById('device_id').value;
            const name = document.getElementById('name').value;
            const response = await fetch('/user/devices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_id: device_id, name: name })
            });
            const resultDiv = document.getElementById('add-result');
            if (response.ok) {
                const data = await response.json();
                resultDiv.innerHTML = `Device added! API Key: ${data.api_key} (copy to Pi settings.json as "api_key")`;
                fetchDevices();  // Reload list
            } else {
                const error = await response.json();
                resultDiv.innerHTML = `Error: ${error.detail}`;
            }
        });

        // Load devices on page load
        window.onload = fetchDevices;

        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };
    </script>
    </div>
</body>
</html>