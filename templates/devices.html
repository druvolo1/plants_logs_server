<!-- templates/devices.html - Device management page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Devices</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Modern Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #10b981;
        }
        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
            text-decoration: none;
        }
        .navbar-brand:hover {
            color: #34d399;
        }
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar-link {
            padding: 1rem 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .navbar-link:hover {
            background: rgba(16, 185, 129, 0.1);
            border-bottom-color: #10b981;
        }
        .navbar-link.active {
            background: rgba(16, 185, 129, 0.15);
            border-bottom-color: #10b981;
            color: #10b981;
        }
        .navbar-user {
            padding: 1rem 1.25rem;
            color: rgba(148, 163, 184, 0.9);
            font-size: 0.9rem;
            border-left: 1px solid rgba(148, 163, 184, 0.2);
        }
        .navbar-logout {
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .navbar-logout:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        /* Hamburger menu button (hidden on desktop) */
        .navbar-toggle {
            display: none;
            background: none;
            border: none;
            color: #10b981;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .navbar-container {
                padding: 0 1rem;
            }

            .navbar-toggle {
                display: block;
            }

            .navbar-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: #0f172a;
                flex-direction: column;
                gap: 0;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }

            .navbar-menu.active {
                display: flex;
            }

            .navbar-link {
                width: 100%;
                text-align: left;
                border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            }

            .navbar-user {
                width: 100%;
                border-left: none;
                border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            }

            .navbar-logout {
                margin: 0.5rem 1rem;
                width: calc(100% - 2rem);
                text-align: center;
            }
        }

        /* Tablet adjustments */
        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 1rem;
            }

            .navbar-link, .navbar-user {
                font-size: 0.85rem;
                padding: 0.75rem 1rem;
            }
        }

        /* Device Type Icon Bar */
        .device-type-icon-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 50px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            z-index: 5;
            font-size: 1.8rem;
            padding: 8px 0;
            border-radius: 8px 0 0 8px;
        }
        .device-type-icon-bar .scope-text {
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }
        .device-type-feeding {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        .device-type-environmental {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .device-type-valve {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }
        .device-type-other {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        /* Linked Devices Section */
        .linked-devices-section {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }

        .linked-devices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .linked-devices-header h4 {
            margin: 0;
            color: #3b82f6;
            font-size: 0.95rem;
        }

        .linked-device-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .linked-device-chip.online {
            border-color: #10b981;
        }

        .linked-device-chip .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .linked-device-chip .status-dot.online {
            background: #10b981;
        }

        .linked-device-chip .status-dot.offline {
            background: #64748b;
        }

        .linked-device-chip .unlink-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 0;
            margin-left: 0.25rem;
            font-size: 1rem;
            line-height: 1;
        }

        .linked-device-chip .unlink-btn:hover {
            color: #dc2626;
        }

        .link-device-btn {
            font-size: 0.8rem;
            padding: 0.35rem 0.75rem;
            background: #3b82f6;
        }

        .link-device-btn:hover {
            background: #2563eb;
        }

        /* Heartbeat Settings Button (Admin Only) */
        .heartbeat-btn {
            background: none;
            border: none;
            color: #f59e0b;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            margin-left: 0.5rem;
            transition: all 0.2s;
            vertical-align: middle;
        }
        .heartbeat-btn:hover {
            color: #fbbf24;
            transform: scale(1.1);
        }
        .heartbeat-btn:disabled {
            color: #64748b;
            cursor: not-allowed;
        }

        /* Compact Device Card */
        .device-card {
            display: flex;
            align-items: stretch;
            margin-bottom: 0.75rem;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            overflow: visible;
            transition: border-color 0.2s;
            position: relative;
        }

        .device-card.has-status {
            margin-bottom: 2.5rem;
        }

        .device-card:hover {
            border-color: #475569;
        }

        .device-card.has-plant {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .device-card-type {
            width: 42px;
            min-width: 42px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .device-card-type.feeding { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .device-card-type.environmental { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .device-card-type.valve { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }

        .device-card-content {
            flex: 1;
            padding: 0.75rem 1rem;
            min-width: 0;
        }

        .device-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.35rem;
            flex-wrap: wrap;
        }

        .device-card-name {
            font-size: 1.05rem;
            font-weight: 600;
            color: #f1f5f9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .device-card-owner {
            font-size: 0.75rem;
            color: #10b981;
        }

        .device-card-shared {
            font-size: 0.75rem;
            color: #f59e0b;
        }

        .device-card-online {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            margin-left: auto;
        }

        .device-card-online .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .device-card-online .dot.online { background: #10b981; }
        .device-card-online .dot.offline { background: #64748b; }

        .device-card-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #94a3b8;
            flex-wrap: wrap;
        }

        .device-card-meta .sep {
            color: #475569;
        }

        .device-card-meta .meta-label {
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
        }

        .device-card-meta .device-id {
            font-family: monospace;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .device-card-meta .version {
            color: #94a3b8;
            display: inline-block;
            min-width: 40px;
            font-weight: 500;
        }

        .device-card-meta .location {
            color: #10b981;
        }

        .device-card-meta .update-badge {
            background: #f59e0b;
            color: #000;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }

        .device-card-plant {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.8rem;
            color: #10b981;
            font-weight: 500;
            margin-top: 0.25rem;
        }

        .device-card-links {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.35rem;
            flex-wrap: wrap;
        }

        .device-card-links .link-label {
            font-size: 0.75rem;
            color: #64748b;
        }

        .device-card-links .linked-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.15rem 0.5rem;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 4px;
            font-size: 0.75rem;
            color: #93c5fd;
        }

        .device-card-links .linked-chip .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #64748b;
        }

        .device-card-links .linked-chip .dot.online {
            background: #10b981;
        }

        .device-card-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            gap: 0.35rem;
            border-left: 1px solid #334155;
            background: rgba(0,0,0,0.1);
        }

        .device-card-actions .action-btn {
            padding: 0.4rem 0.6rem;
            border: none;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }

        .device-card-actions .action-btn.primary {
            background: #3b82f6;
            color: white;
        }

        .device-card-actions .action-btn.primary:hover {
            background: #2563eb;
        }

        .device-card-actions .action-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #e2e8f0;
        }

        .device-card-actions .action-btn.secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .device-card-actions .overflow-btn {
            padding: 0.3rem 0.5rem;
            font-size: 1.1rem;
        }

        .device-card-status {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            font-size: 0.75rem;
            padding: 0.4rem 1rem;
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #334155;
            border-top: none;
            border-radius: 0 0 8px 8px;
            margin-top: -1px;
        }

        /* Device Card Action Bar - legacy, keep for modals */
        .device-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .device-actions .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .device-actions .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .device-actions .btn-primary:hover {
            background: #2563eb;
        }

        .device-actions .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        .device-actions .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Overflow Menu */
        .overflow-menu-container {
            position: relative;
            margin-left: auto;
        }

        .overflow-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #e2e8f0;
            font-size: 1.25rem;
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1;
        }

        .overflow-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Device Actions Modal */
        .actions-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .actions-modal-overlay.show {
            display: flex;
        }

        .actions-modal {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 12px;
            min-width: 280px;
            max-width: 90vw;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        .actions-modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .actions-modal-title {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin: 0;
        }

        .actions-modal-close {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .actions-modal-close:hover {
            color: #f1f5f9;
        }

        .actions-modal-body {
            padding: 0.5rem 0;
        }

        .actions-modal-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding: 0.875rem 1.25rem;
            border: none;
            background: none;
            color: #e2e8f0;
            font-size: 0.95rem;
            text-align: left;
            cursor: pointer;
            transition: background 0.15s;
        }

        .actions-modal-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .actions-modal-item.danger {
            color: #f87171;
        }

        .actions-modal-item.danger:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        .actions-modal-divider {
            height: 1px;
            background: #334155;
            margin: 0.5rem 0;
        }

        .actions-modal-item .icon {
            width: 1.5rem;
            text-align: center;
            font-size: 1.1rem;
        }

        /* Heartbeat Settings Modal */
        .heartbeat-modal-content {
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1e293b;
            padding: 2rem;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .heartbeat-setting {
            margin-bottom: 1.5rem;
        }
        .heartbeat-setting label {
            display: block;
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .heartbeat-setting input[type="number"],
        .heartbeat-setting select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #374151;
            background: #0f172a;
            color: #fff;
            font-size: 1rem;
        }
        .heartbeat-setting .hint {
            color: #64748b;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }
        .heartbeat-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .heartbeat-header h3 {
            margin: 0;
            color: #f59e0b;
        }
        .heartbeat-header .bolt-icon {
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    {% if impersonating_user %}
    <!-- Impersonation Banner -->
    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: #000; padding: 0.75rem 2rem; display: flex; justify-content: space-between; align-items: center; font-weight: 600; position: sticky; top: 0; z-index: 1001;">
        <span>üëÅÔ∏è Viewing as: <strong>{{ impersonating_user.email }}</strong></span>
        <button onclick="exitImpersonation()" style="background: #000; color: #f59e0b; border: none; padding: 0.35rem 1rem; border-radius: 4px; font-weight: 600; cursor: pointer;">
            Exit View Mode
        </button>
    </div>
    <script>
        async function exitImpersonation() {
            try {
                const response = await fetch('/admin/impersonate/exit', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/admin/users';
                }
            } catch (error) {
                console.error('Error exiting impersonation:', error);
            }
        }
    </script>
    {% endif %}

    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard" class="navbar-brand">
                üå± Plant Monitor
            </a>
            <button class="navbar-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
            <div class="navbar-menu" id="navbar-menu">
                <a href="/dashboard" class="navbar-link">Dashboard</a>
                <a href="/devices" class="navbar-link active">Devices</a>
                <a href="/plants" class="navbar-link">Plants</a>
                <a href="/locations" class="navbar-link">Locations</a>
                <a href="/templates" class="navbar-link">Templates</a>
                {% if user.is_superuser and not impersonating_user %}
                <a href="/admin/overview" class="navbar-link">Admin Overview</a>
                <a href="/admin/users" class="navbar-link">Users</a>
                {% endif %}
                <span class="navbar-user">{{ user.email }}</span>
                <a href="/auth/logout" class="navbar-logout">Logout</a>
            </div>
        </div>
    </nav>

    <div style="padding: 2rem 1.5rem; max-width: 1400px; margin: 0 auto;">
    <h2 style="color: #10b981; margin-bottom: 1.5rem;">Manage Devices</h2>

    <!-- Accept Shared Device form -->
    <h3>Accept Shared Device</h3>
    <form id="add-device-form">
        <label for="share_code">Share Code:</label>
        <input type="text" id="share_code" placeholder="Enter 10-character code">
        <br>
        <button type="submit">Accept Share</button>
    </form>
    <div id="add-result"></div>

    <!-- Devices list -->
    <h3>My Devices</h3>

    <!-- Search Bar -->
    <div style="margin-bottom: 1.5rem;">
        <input
            type="text"
            id="device-search"
            placeholder="Search devices by name, ID, location, version, or online status..."
            style="width: 100%; padding: 0.75rem; border-radius: 6px; border: 1px solid #374151; background: #0f172a; color: #fff; font-size: 1rem;"
            oninput="filterDevices()"
        >
        <p id="search-results-count" style="color: #888; font-size: 0.9rem; margin-top: 0.5rem;"></p>
    </div>

    <div id="devices-list"></div>

    <!-- Device Actions Modal -->
    <div id="actions-modal" class="actions-modal-overlay" onclick="if(event.target === this) closeActionsModal();">
        <div class="actions-modal">
            <div class="actions-modal-header">
                <h4 class="actions-modal-title" id="actions-modal-title">Device Actions</h4>
                <button class="actions-modal-close" onclick="closeActionsModal()">&times;</button>
            </div>
            <div class="actions-modal-body" id="actions-modal-body">
                <!-- Actions will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Device Settings Modal -->
    <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;" onclick="if(event.target === this) closeDeviceSettingsModal();">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h3 style="color: #10b981; margin-top: 0;" id="settings-modal-title">Device Settings</h3>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 1.5rem;">Configure device settings remotely via WebSocket</p>

            <div id="settings-modal-body">
                <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <div>Loading settings...</div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; text-align: right;">
                <button onclick="closeDeviceSettingsModal()" style="padding: 0.5rem 1rem; background: #475569; color: white; border: none; border-radius: 6px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <!-- Share Management Modal -->
    <div id="share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h3 style="color: #10b981; margin-top: 0;">Manage Device Sharing</h3>
            <p style="color: #888; font-size: 0.9rem;" id="share-device-name"></p>

            <!-- Create New Share -->
            <div style="margin: 1.5rem 0; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                <h4 style="margin-top: 0; color: #10b981;">Create New Share Link</h4>
                <div style="margin-bottom: 0.5rem;">
                    <label for="permission-select">Permission Level:</label>
                    <select id="permission-select" style="margin-left: 0.5rem; padding: 0.5rem; border-radius: 4px;">
                        <option value="viewer">View Only</option>
                        <option value="controller">Can Control</option>
                    </select>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <label for="share-expires-type">Expiration:</label>
                    <select id="share-expires-type" onchange="toggleDeviceExpiresInput()" style="margin-left: 0.5rem; padding: 0.5rem; border-radius: 4px;">
                        <option value="days">Expires in days</option>
                        <option value="never">Never expires</option>
                    </select>
                    <input type="number" id="share-expires" value="7" min="1" max="365" style="margin-left: 0.5rem; padding: 0.5rem; border-radius: 4px; width: 80px;">
                </div>
                <button onclick="createShare()" style="margin-left: 1rem;">Generate Share Code</button>
                <div id="share-code-result" style="margin-top: 1rem;"></div>
            </div>

            <!-- Active Shares List -->
            <div style="margin: 1.5rem 0;">
                <h4 style="color: #10b981;">Active Shares</h4>
                <div id="shares-list" style="margin-top: 1rem;"></div>
            </div>

            <button onclick="closeShareModal()" style="background: #64748b; margin-top: 1rem;">Close</button>
        </div>
    </div>

    <!-- Edit Device Modal -->
    <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h3 style="color: #10b981; margin-top: 0;">Edit Device</h3>
            <p style="color: #888; font-size: 0.9rem;" id="edit-device-name"></p>

            <form id="edit-device-form" onsubmit="saveDeviceEdit(event)">
                <div style="margin-bottom: 1rem;">
                    <label for="edit-name" style="display: block; color: #fff; margin-bottom: 0.5rem;">Device Name:</label>
                    <input type="text" id="edit-name" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff;">
                </div>

                <div style="margin-bottom: 1rem;">
                    <label for="edit-location" style="display: block; color: #fff; margin-bottom: 0.5rem;">Location:</label>
                    <select id="edit-location" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff;">
                        <option value="">Unassigned</option>
                    </select>
                </div>

                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="submit" style="background: #10b981; flex: 1;">Save Changes</button>
                    <button type="button" onclick="closeEditModal()" style="background: #64748b; flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Location Modal -->
    <div id="location-change-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h3 style="color: #10b981; margin-top: 0;">üìç Change Location</h3>
            <p style="color: #888; font-size: 0.9rem;" id="location-change-device-name"></p>

            <form id="location-change-form" onsubmit="saveLocationChange(event)">
                <div style="margin-bottom: 1rem;">
                    <label for="location-change-select" style="display: block; color: #fff; margin-bottom: 0.5rem;">Location:</label>
                    <select id="location-change-select" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff;">
                        <option value="">Unassigned</option>
                    </select>
                </div>

                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="submit" style="background: #10b981; flex: 1;">Save Changes</button>
                    <button type="button" onclick="closeLocationChangeModal()" style="background: #64748b; flex: 1;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Valve Labels Modal -->
    <div id="labels-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;" onclick="if(event.target === this) closeLabelsModal();">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h3 style="color: #10b981; margin-top: 0;">üè∑Ô∏è Edit Valve Labels</h3>
            <p style="color: #888; font-size: 0.9rem;" id="labels-device-name"></p>

            <form id="labels-form" onsubmit="saveValveLabels(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <div>
                        <label for="label-1" style="display: block; color: #9ca3af; margin-bottom: 0.25rem; font-size: 0.8rem;">Valve 1:</label>
                        <input type="text" id="label-1" name="label-1" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="label-2" style="display: block; color: #9ca3af; margin-bottom: 0.25rem; font-size: 0.8rem;">Valve 2:</label>
                        <input type="text" id="label-2" name="label-2" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="label-3" style="display: block; color: #9ca3af; margin-bottom: 0.25rem; font-size: 0.8rem;">Valve 3:</label>
                        <input type="text" id="label-3" name="label-3" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="label-4" style="display: block; color: #9ca3af; margin-bottom: 0.25rem; font-size: 0.8rem;">Valve 4:</label>
                        <input type="text" id="label-4" name="label-4" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="label-5" style="display: block; color: #9ca3af; margin-bottom: 0.25rem; font-size: 0.8rem;">Valve 5:</label>
                        <input type="text" id="label-5" name="label-5" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="label-6" style="display: block; color: #9ca3af; margin-bottom: 0.25rem; font-size: 0.8rem;">Valve 6:</label>
                        <input type="text" id="label-6" name="label-6" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="label-7" style="display: block; color: #9ca3af; margin-bottom: 0.25rem; font-size: 0.8rem;">Valve 7:</label>
                        <input type="text" id="label-7" name="label-7" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff; box-sizing: border-box;">
                    </div>
                    <div>
                        <label for="label-8" style="display: block; color: #9ca3af; margin-bottom: 0.25rem; font-size: 0.8rem;">Valve 8:</label>
                        <input type="text" id="label-8" name="label-8" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #374151; background: #0f172a; color: #fff; box-sizing: border-box;">
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="submit" style="background: #10b981; flex: 1; padding: 0.75rem; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">Save Labels</button>
                    <button type="button" onclick="closeLabelsModal()" style="background: #64748b; flex: 1; padding: 0.75rem; border: none; border-radius: 6px; color: white; font-weight: 600; cursor: pointer;">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Link Devices Modal -->
    <div id="link-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.5); max-height: 80vh; overflow-y: auto;">
            <h3 style="color: #3b82f6; margin-top: 0;">Link Environmental Sensors & Valve Controllers</h3>
            <p style="color: #888; font-size: 0.9rem;" id="link-device-name"></p>

            <div style="margin: 1.5rem 0;">
                <h4 style="color: #10b981; margin-bottom: 0.75rem;">Available Devices to Link</h4>
                <div id="available-links-list" style="margin-top: 1rem;"></div>
            </div>

            <div style="margin: 1.5rem 0;">
                <h4 style="color: #3b82f6; margin-bottom: 0.75rem;">Currently Linked Devices</h4>
                <div id="current-links-list" style="margin-top: 1rem;"></div>
            </div>

            <button onclick="closeLinkModal()" style="background: #64748b; margin-top: 1rem;">Close</button>
        </div>
    </div>

    <!-- Heartbeat Settings Modal (Admin Only) -->
    {% if user.is_superuser %}
    <div id="heartbeat-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div class="heartbeat-modal-content">
            <div class="heartbeat-header">
                <span class="bolt-icon">‚ö°</span>
                <h3>Heartbeat Settings</h3>
            </div>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 1.5rem;" id="heartbeat-device-name"></p>

            <div class="heartbeat-setting">
                <label for="heartbeat-use-fahrenheit">Temperature Unit</label>
                <select id="heartbeat-use-fahrenheit">
                    <option value="false">Celsius (¬∞C)</option>
                    <option value="true">Fahrenheit (¬∞F)</option>
                </select>
                <p class="hint">How temperature is displayed on the device</p>
            </div>

            <div class="heartbeat-setting">
                <label for="heartbeat-update-interval">Heartbeat Interval (seconds)</label>
                <input type="number" id="heartbeat-update-interval" min="5" max="3600" value="30">
                <p class="hint">How often the device sends status updates (5-3600 seconds). Lower = more responsive UI but more network traffic.</p>
            </div>

            <div class="heartbeat-setting">
                <label for="heartbeat-log-interval">Logging Interval (seconds)</label>
                <input type="number" id="heartbeat-log-interval" min="60" max="86400" value="3600">
                <p class="hint">How often the device saves data to the database (60-86400 seconds). Default: 3600 (1 hour).</p>
            </div>

            <!-- Firmware Update Section -->
            <div id="firmware-section" style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 3px solid #3b82f6;">
                <h4 style="margin: 0 0 0.75rem 0; color: #3b82f6;">Firmware Update</h4>
                <div id="firmware-status">
                    <p style="margin: 0; color: #888; font-size: 0.9rem;">Loading firmware info...</p>
                </div>
            </div>

            <div style="background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 3px solid #f59e0b;">
                <p style="margin: 0; color: #f59e0b; font-size: 0.9rem;">
                    <strong>Note:</strong> Changes will take effect on the device's next heartbeat (within the current heartbeat interval).
                </p>
            </div>

            <div style="display: flex; gap: 0.5rem;">
                <button onclick="saveHeartbeatSettings()" style="background: #f59e0b; flex: 1;">Save Settings</button>
                <button onclick="closeHeartbeatModal()" style="background: #64748b; flex: 1;">Cancel</button>
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        // Admin status
        const isAdmin = {{ 'true' if user.is_superuser else 'false' }};
        // Store WebSocket connections per device
        let wsMap = {};
        let currentShareDeviceId = null;
        let currentEditDeviceId = null;
        let currentLinkDeviceId = null;
        let currentHeartbeatDeviceId = null;
        let locationsMap = {};
        let allDevices = []; // Store all devices for filtering

        // Helper function to get full location path (e.g., "Dave's House -> Basement")
        function getLocationPath(locationId) {
            if (!locationId || !locationsMap[locationId]) {
                return 'Unassigned';
            }

            const path = [];
            let currentId = locationId;
            let maxDepth = 10; // Prevent infinite loops

            while (currentId && maxDepth > 0) {
                const location = locationsMap[currentId];
                if (!location) break;

                path.unshift(location.name);
                currentId = location.parent_id;
                maxDepth--;
            }

            return path.join(' -> ');
        }

        // Filter devices based on search query
        function filterDevices() {
            const searchQuery = document.getElementById('device-search').value.toLowerCase().trim();

            if (!searchQuery) {
                // No search query, show all devices
                renderDevices(allDevices);
                document.getElementById('search-results-count').textContent = '';
                return;
            }

            const filteredDevices = allDevices.filter(device => {
                // Get device properties for searching
                const systemName = (device.name || '').toLowerCase();
                const deviceId = (device.device_id || '').toLowerCase();
                const locationPath = device.location_id ? getLocationPath(device.location_id).toLowerCase() : 'unassigned';
                const version = (device.version || 'loading...').toLowerCase();

                // Online status - match both "online"/"offline" and "yes"/"no"
                const isOnline = device.is_online;
                const onlineText = isOnline ? 'yes online' : 'no offline';

                // Check if search query matches any field
                return systemName.includes(searchQuery) ||
                       deviceId.includes(searchQuery) ||
                       locationPath.includes(searchQuery) ||
                       version.includes(searchQuery) ||
                       onlineText.includes(searchQuery);
            });

            renderDevices(filteredDevices);

            // Update search results count
            const countText = filteredDevices.length === 1
                ? '1 device found'
                : `${filteredDevices.length} devices found`;
            document.getElementById('search-results-count').textContent = countText;
        }

        // Render devices list (separated from fetching for filtering support)
        function renderDevices(devices) {
            const listDiv = document.getElementById('devices-list');
            listDiv.innerHTML = '';

            if (devices.length === 0) {
                listDiv.innerHTML = '<p style="color: #888;">No devices found</p>';
                return;
            }

            // Group devices by location
            const devicesByLocation = {};
            const unassignedDevices = [];

            devices.forEach(device => {
                if (device.location_id && locationsMap[device.location_id]) {
                    const locationPath = getLocationPath(device.location_id);
                    if (!devicesByLocation[locationPath]) {
                        devicesByLocation[locationPath] = [];
                    }
                    devicesByLocation[locationPath].push(device);
                } else {
                    unassignedDevices.push(device);
                }
            });

            // Render devices grouped by location
            Object.keys(devicesByLocation).sort().forEach(locationName => {
                const locationHeader = document.createElement('h4');
                locationHeader.textContent = `üìç ${locationName}`;
                locationHeader.style.color = '#10b981';
                locationHeader.style.marginTop = '1.5rem';
                locationHeader.style.marginBottom = '1rem';
                listDiv.appendChild(locationHeader);

                devicesByLocation[locationName].forEach(device => {
                    listDiv.appendChild(createDeviceCard(device));
                });
            });

            // Render unassigned devices
            if (unassignedDevices.length > 0) {
                const unassignedHeader = document.createElement('h4');
                unassignedHeader.textContent = 'Unassigned';
                unassignedHeader.style.color = '#64748b';
                unassignedHeader.style.marginTop = '2rem';
                unassignedHeader.style.marginBottom = '1rem';
                listDiv.appendChild(unassignedHeader);

                unassignedDevices.forEach(device => {
                    listDiv.appendChild(createDeviceCard(device));
                });
            }
        }

        // Fetch and display devices list with Update and Delete buttons
        async function fetchDevices() {
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();

                // Fetch locations for grouping and reference
                const locationsResponse = await fetch('/user/locations');
                locationsMap = {};
                if (locationsResponse.ok) {
                    const locations = await locationsResponse.json();
                    locations.forEach(loc => {
                        locationsMap[loc.id] = {
                            name: loc.name,
                            parent_id: loc.parent_id
                        };
                    });
                }

                // Store all devices for filtering
                // Add initial version property for search (will be updated via WebSocket)
                allDevices = devices.map(device => ({
                    ...device,
                    version: 'Loading...'
                }));

                // Render devices
                renderDevices(allDevices);

                // Clear search when refetching
                document.getElementById('device-search').value = '';
                document.getElementById('search-results-count').textContent = '';
            }
        }

        // Format last seen timestamp as relative time
        function formatLastSeen(lastSeenStr) {
            if (!lastSeenStr) return 'Never';

            // Parse as UTC if no timezone indicator present
            let lastSeen;
            if (lastSeenStr.endsWith('Z') || /[+-]\d{2}:\d{2}$/.test(lastSeenStr)) {
                // Already has timezone info
                lastSeen = new Date(lastSeenStr);
            } else {
                // Assume UTC if no timezone info (server sends naive UTC timestamps)
                lastSeen = new Date(lastSeenStr + 'Z');
            }

            const now = new Date();
            const diffMs = now - lastSeen;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffSecs < 60) return `${diffSecs}s ago`;
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return lastSeen.toLocaleDateString();
        }

        function createDeviceCard(device) {
            const deviceDiv = document.createElement('div');
            deviceDiv.className = `device-card${device.active_plant_name ? ' has-plant' : ''}`;

            // Device type info
            const deviceType = device.device_type || 'feeding_system';
            const scope = device.scope || 'plant';
            const typeClass = deviceType === 'environmental' ? 'environmental' :
                              deviceType === 'valve_controller' ? 'valve' : 'feeding';
            const scopeText = deviceType === 'valve_controller' ? 'VALVE' : (scope === 'room' ? 'ROOM' : 'PLANT');

            // Heartbeat button for admin
            const heartbeatButton = (isAdmin && deviceType === 'environmental')
                ? `<button class="heartbeat-btn" onclick="event.stopPropagation(); openHeartbeatModal('${device.device_id}')" title="Heartbeat Settings">‚ö°</button>`
                : '';

            // Ownership badge
            const ownerBadge = device.is_owner
                ? `<span class="device-card-owner">‚úì Owner</span>`
                : `<span class="device-card-shared">Shared by ${device.shared_by_email}</span>`;

            // Location display (not showing if already grouped by location)
            const locationPath = device.location_id ? getLocationPath(device.location_id) : null;

            // Linked devices for feeding systems
            let linkedChips = '';
            if (deviceType === 'feeding_system' && device.linked_devices && device.linked_devices.length > 0) {
                linkedChips = device.linked_devices.map(linked => {
                    const icon = linked.device_type === 'environmental' ? 'üå°Ô∏è' : 'üöø';
                    const dotClass = linked.is_online ? 'online' : '';
                    return `<span class="linked-chip"><span class="dot ${dotClass}"></span>${icon} ${linked.name || linked.device_id.substring(0, 8)}</span>`;
                }).join('');
            }

            // Plant info
            const plantInfo = device.active_plant_name
                ? `<div class="device-card-plant">üå± ${device.active_plant_name} (${device.active_phase})</div>`
                : '';


            // Action buttons
            let actionButtons = '';
            if (device.is_owner && deviceType === 'feeding_system') {
                actionButtons += `<button class="action-btn secondary" onclick="openLinkModal('${device.device_id}')">Link</button>`;
            }

            deviceDiv.innerHTML = `
                <div class="device-card-type ${typeClass}">${scopeText}</div>
                <div class="device-card-content">
                    <div class="device-card-header">
                        <span class="device-card-name" id="name-${device.device_id}">${device.name || 'Unnamed Device'}</span>
                        ${heartbeatButton}
                        ${ownerBadge}
                        <span class="device-card-online">
                            <span class="dot ${device.is_online ? 'online' : 'offline'}"></span>
                            <span id="online-${device.device_id}">${device.is_online ? 'Online' : 'Offline'}</span>
                        </span>
                    </div>
                    <div class="device-card-meta">
                        <span class="meta-label">UUID:</span>
                        <span class="device-id">${device.device_id.split('-').pop()}</span>
                        <span class="sep">¬∑</span>
                        <span class="meta-label">Version:</span>
                        <span class="version" id="version-${device.device_id}">...</span>
                        <span id="update-badge-${device.device_id}"></span>
                        ${device.last_seen ? `<span class="sep">¬∑</span><span class="meta-label">Last seen:</span><span class="last-seen">${formatLastSeen(device.last_seen)}</span>` : ''}
                        ${device.ip_address ? `<span class="sep">¬∑</span><span class="meta-label">IP:</span><span class="ip-address">${device.ip_address}</span>` : ''}
                        ${device.mdns_hostname ? `<span class="sep">¬∑</span><span class="meta-label">mDNS:</span><span class="mdns-hostname">${device.mdns_hostname}</span>` : ''}
                        ${locationPath ? `<span class="sep">¬∑</span><span class="location">üìç ${locationPath}</span>` : ''}
                    </div>
                    ${plantInfo}
                    ${linkedChips ? `<div class="device-card-links"><span class="link-label">üîó</span>${linkedChips}</div>` : ''}
                </div>
                <div class="device-card-actions">
                    ${actionButtons}
                    <button class="overflow-btn" onclick="openActionsModal('${device.device_id}', '${deviceType}', ${device.is_owner})" title="More actions">‚ãÆ</button>
                </div>
            `;

            // Status div for feedback (appended outside main card for positioning)
            const statusDiv = document.createElement('div');
            statusDiv.id = `update-status-${device.device_id}`;
            statusDiv.className = 'device-card-status';
            statusDiv.style.display = 'none';
            deviceDiv.appendChild(statusDiv);

            // Auto-connect to WebSocket for status updates (all devices except environmental sensors)
            console.log(`Device ${device.device_id.substring(0,8)}: is_online=${device.is_online}, type=${device.device_type}`);
            if (device.device_type !== 'environmental') {
                console.log(`Connecting to WebSocket for ${device.device_id.substring(0,8)}`);
                connectToDevice(device.device_id);
            } else {
                console.log(`Skipping WebSocket for ${device.device_id.substring(0,8)}: environmental sensor`);
            }

            // For environmental sensors, fetch version from environment/latest endpoint
            if (device.device_type === 'environmental') {
                fetchEnvironmentalVersion(device.device_id);
            }

            return deviceDiv;
        }

        // Show status message for device card
        function showDeviceStatus(deviceId, message, color = '#10b981') {
            const statusDiv = document.getElementById(`update-status-${deviceId}`);
            const card = statusDiv?.closest('.device-card');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.style.color = color;
                statusDiv.style.display = message ? 'block' : 'none';
                // Add/remove margin class to make room for status
                if (card) {
                    if (message) {
                        card.classList.add('has-status');
                    } else {
                        card.classList.remove('has-status');
                    }
                }
            }
        }

        // Device Actions Modal
        let currentActionsDeviceId = null;

        function openActionsModal(deviceId, deviceType, isOwner) {
            currentActionsDeviceId = deviceId;

            // Find device name
            const device = allDevices.find(d => d.device_id === deviceId);
            const deviceName = device ? device.name : deviceId;

            document.getElementById('actions-modal-title').textContent = deviceName;

            // Build modal content
            let html = '';

            if (deviceType === 'environmental') {
                html += `
                    <button class="actions-modal-item" onclick="closeActionsModal(); updateEnvironmentalFirmware('${deviceId}');">
                        <span class="icon">‚¨ÜÔ∏è</span> Update Software
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); rebootEnvironmentalDevice('${deviceId}');">
                        <span class="icon">üîÑ</span> Reboot System
                    </button>`;
            } else if (deviceType === 'valve_controller') {
                html += `
                    <button class="actions-modal-item" onclick="closeActionsModal(); openDeviceSettingsModal('${deviceId}', '${deviceType}');">
                        <span class="icon">‚öôÔ∏è</span> Device Settings
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); openEditLabelsModal('${deviceId}');">
                        <span class="icon">üè∑Ô∏è</span> Edit Valve Labels
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); updateValveControllerFirmware('${deviceId}');">
                        <span class="icon">‚¨ÜÔ∏è</span> Update Software
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); rebootValveController('${deviceId}');">
                        <span class="icon">üîÑ</span> Reboot System
                    </button>`;
            } else if (deviceType === 'hydroponic_controller') {
                html += `
                    <button class="actions-modal-item" onclick="closeActionsModal(); openGeneralSettingsModal('${deviceId}');">
                        <span class="icon">‚öôÔ∏è</span> General Settings
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); openSensorConfigModal('${deviceId}');">
                        <span class="icon">üìä</span> Sensor Config
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); openCalibrationModal('${deviceId}');">
                        <span class="icon">üîß</span> pH & EC Calibration
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); openDosingModal('${deviceId}');">
                        <span class="icon">üíß</span> pH & EC Dosing
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); openAutomationsModal('${deviceId}');">
                        <span class="icon">ü§ñ</span> Automations
                    </button>`;

                // Admin-only Advanced Settings
                {% if actual_user.is_superuser %}
                html += `
                    <button class="actions-modal-item" onclick="closeActionsModal(); openAdvancedSettingsModal('${deviceId}');">
                        <span class="icon">üîß</span> Advanced Settings
                    </button>`;
                {% endif %}

                html += `
                    <button class="actions-modal-item" onclick="closeActionsModal(); updateHydroponicControllerFirmware('${deviceId}');">
                        <span class="icon">‚¨ÜÔ∏è</span> Update Software
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); rebootHydroponicController('${deviceId}');">
                        <span class="icon">üîÑ</span> Reboot System
                    </button>`;
            } else {
                html += `
                    <button class="actions-modal-item" onclick="closeActionsModal(); updateDevice('${deviceId}');">
                        <span class="icon">‚¨ÜÔ∏è</span> Update Software
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); restartService('${deviceId}');">
                        <span class="icon">üîÉ</span> Restart Service
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); rebootSystem('${deviceId}');">
                        <span class="icon">üîÑ</span> Reboot System
                    </button>`;
            }

            if (isOwner) {
                html += `
                    <div class="actions-modal-divider"></div>
                    <button class="actions-modal-item" onclick="closeActionsModal(); openLocationChangeModal('${deviceId}');">
                        <span class="icon">üìç</span> Change Location
                    </button>
                    <button class="actions-modal-item" onclick="closeActionsModal(); openShareModal('${deviceId}');">
                        <span class="icon">üì§</span> Share Device
                    </button>
                    <button class="actions-modal-item danger" onclick="closeActionsModal(); deleteDevice('${deviceId}');">
                        <span class="icon">üóëÔ∏è</span> Delete Device
                    </button>`;
            }

            document.getElementById('actions-modal-body').innerHTML = html;
            document.getElementById('actions-modal').classList.add('show');
        }

        function closeActionsModal() {
            document.getElementById('actions-modal').classList.remove('show');
            currentActionsDeviceId = null;
        }

        // Device Settings Modal
        let currentSettingsDeviceId = null;
        let currentSettingsDeviceType = null;

        function openDeviceSettingsModal(deviceId, deviceType) {
            // Check if device is online
            const device = allDevices.find(d => d.device_id === deviceId);
            if (!device || !device.is_online) {
                alert('Cannot access settings: Device is offline. Settings can only be configured when the device is connected.');
                return;
            }

            currentSettingsDeviceId = deviceId;
            currentSettingsDeviceType = deviceType;

            // Update modal title with device name
            const deviceName = device.name || deviceId.substring(0, 8);
            document.getElementById('settings-modal-title').textContent = `${deviceName} - Settings`;

            // Show modal with loading state
            document.getElementById('settings-modal-body').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <div>Loading settings from device...</div>
                </div>
            `;
            document.getElementById('settings-modal').style.display = 'block';

            // Request settings from device via WebSocket
            requestDeviceSettings(deviceId);
        }

        function closeDeviceSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
            currentSettingsDeviceId = null;
            currentSettingsDeviceType = null;
            currentHydroModalType = null;

            // Clear sensor update interval if running
            if (hydroSensorUpdateInterval) {
                clearInterval(hydroSensorUpdateInterval);
                hydroSensorUpdateInterval = null;
            }
        }

        function requestDeviceSettings(deviceId) {
            const ws = wsMap[deviceId];
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                document.getElementById('settings-modal-body').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ùå</div>
                        <div>WebSocket not connected</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem; color: #94a3b8;">Please try again in a moment</div>
                    </div>
                `;
                return;
            }

            // Send get_settings request
            console.log(`[Settings] Sending get_settings to ${deviceId}`);
            ws.send(JSON.stringify({
                type: 'get_settings'
            }));

            // Set timeout for response
            setTimeout(() => {
                const body = document.getElementById('settings-modal-body');
                if (body && body.innerHTML.includes('Loading')) {
                    body.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #ef4444;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">‚è±Ô∏è</div>
                            <div>Request timed out</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem; color: #94a3b8;">Device did not respond</div>
                        </div>
                    `;
                }
            }, 5000);
        }

        function displayDeviceSettings(settings) {
            if (!currentSettingsDeviceId) return;

            // Route to appropriate display function based on device type
            if (currentSettingsDeviceType === 'valve_controller') {
                displayValveControllerSettings(settings);
            } else if (currentSettingsDeviceType === 'hydroponic_controller') {
                // Route to specific hydro modal based on currentHydroModalType
                switch(currentHydroModalType) {
                    case 'general':
                        displayHydroGeneralModal(settings);
                        break;
                    case 'sensors':
                        displayHydroSensorsModal(settings);
                        break;
                    case 'calibration':
                        displayHydroCalibrationModal(settings);
                        break;
                    case 'dosing':
                        displayHydroDosingModal(settings);
                        break;
                    case 'automation':
                        displayHydroAutomationModal(settings);
                        break;
                    case 'advanced':
                        displayHydroAdvancedModal(settings);
                        break;
                }
            }
        }

        function displayValveControllerSettings(settings) {

            // Generate valve label inputs
            let valveLabelsHTML = '';
            const valveLabels = settings.valve_labels || ['Valve 1', 'Valve 2', 'Valve 3', 'Valve 4', 'Valve 5', 'Valve 6', 'Valve 7', 'Valve 8'];
            for (let i = 0; i < 8; i++) {
                valveLabelsHTML += `
                    <div style="display: grid; grid-template-columns: 60px 1fr; gap: 0.75rem; align-items: center;">
                        <label style="color: #94a3b8; font-size: 0.9rem;">Valve ${i + 1}</label>
                        <input type="text" id="valve-label-${i}" value="${valveLabels[i] || 'Valve ' + (i + 1)}"
                            onchange="updateValveLabel(${i}, this.value)"
                            style="padding: 0.5rem; background: #0f172a; border: 1px solid #374151; border-radius: 6px; color: #fff; font-size: 0.95rem;">
                    </div>
                `;
            }

            // Generate valve assignment checkboxes
            let valveAssignmentsHTML = '';
            const valveAssignments = settings.outlet_valve_assignments || 0xFF;
            for (let i = 0; i < 8; i++) {
                const isAssigned = (valveAssignments & (1 << i)) !== 0;
                valveAssignmentsHTML += `
                    <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(59, 130, 246, 0.05); border-radius: 4px; cursor: pointer;">
                        <input type="checkbox" id="outlet-valve-${i}" ${isAssigned ? 'checked' : ''}
                            onchange="updateOutletValveAssignment(${i}, this.checked)"
                            style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="color: #e2e8f0; font-size: 0.9rem;">Valve ${i + 1} (${valveLabels[i] || 'Valve ' + (i + 1)})</span>
                    </label>
                `;
            }

            const html = `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Device Name -->
                    <div>
                        <label style="display: block; color: #94a3b8; font-size: 0.9rem; margin-bottom: 0.5rem; font-weight: 600;">Device Name</label>
                        <input type="text" id="setting-device-name" value="${settings.device_name || ''}"
                            onchange="updateDeviceSetting('device_name', this.value)"
                            style="width: 100%; padding: 0.75rem; background: #0f172a; border: 1px solid #374151; border-radius: 6px; color: #fff; font-size: 1rem;">
                    </div>

                    <!-- Valve Labels -->
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 8px; border: 1px solid #374151;">
                        <h3 style="color: #10b981; margin: 0 0 1rem 0; font-size: 1.1rem;">Valve Labels</h3>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                            ${valveLabelsHTML}
                        </div>
                    </div>

                    <!-- Outlet Configuration -->
                    <div style="background: rgba(59, 130, 246, 0.05); padding: 1rem; border-radius: 8px; border: 1px solid #374151;">
                        <h3 style="color: #10b981; margin: 0 0 1rem 0; font-size: 1.1rem;">Remote Outlet Configuration</h3>

                        <!-- Outlet Enabled -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 6px; margin-bottom: 1rem;">
                            <div>
                                <div style="color: #e2e8f0; font-weight: 500;">Enable Outlet Control</div>
                                <div style="color: #94a3b8; font-size: 0.85rem;">Automatically control remote outlet based on valve states</div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="outlet-enabled" ${settings.outlet_enabled ? 'checked' : ''}
                                    onchange="updateDeviceSetting('outlet_enabled', this.checked)">
                                <span class="slider round"></span>
                            </label>
                        </div>

                        <!-- Outlet Host -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: #94a3b8; font-size: 0.9rem; margin-bottom: 0.5rem;">Outlet IP Address / Hostname</label>
                            <input type="text" id="outlet-host" value="${settings.outlet_host || ''}"
                                placeholder="e.g., 192.168.1.100 or outlet.local"
                                onchange="updateDeviceSetting('outlet_host', this.value)"
                                style="width: 100%; padding: 0.75rem; background: #0f172a; border: 1px solid #374151; border-radius: 6px; color: #fff; font-size: 1rem;">
                        </div>

                        <!-- Outlet Port -->
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; color: #94a3b8; font-size: 0.9rem; margin-bottom: 0.5rem;">Outlet Port</label>
                            <input type="number" id="outlet-port" value="${settings.outlet_port || 80}" min="1" max="65535"
                                onchange="updateDeviceSetting('outlet_port', parseInt(this.value))"
                                style="width: 150px; padding: 0.75rem; background: #0f172a; border: 1px solid #374151; border-radius: 6px; color: #fff; font-size: 1rem;">
                        </div>

                        <!-- Valve Assignments -->
                        <div>
                            <label style="display: block; color: #94a3b8; font-size: 0.9rem; margin-bottom: 0.5rem;">Assigned Valves</label>
                            <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.75rem;">Select which valves control this outlet (outlet turns on when any assigned valve is on)</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                                ${valveAssignmentsHTML}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('settings-modal-body').innerHTML = html;
        }

        function updateValveLabel(valveIndex, label) {
            updateDeviceSetting('valve_label', { index: valveIndex, label: label });
        }

        function updateOutletValveAssignment(valveIndex, assigned) {
            // Get current assignments from checkboxes
            let assignments = 0;
            for (let i = 0; i < 8; i++) {
                const checkbox = document.getElementById(`outlet-valve-${i}`);
                if (checkbox && checkbox.checked) {
                    assignments |= (1 << i);
                }
            }
            updateDeviceSetting('outlet_valve_assignments', assignments);
        }

        function updateDeviceSetting(key, value) {
            if (!currentSettingsDeviceId) return;

            const ws = wsMap[currentSettingsDeviceId];
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket not connected. Cannot update setting.');
                return;
            }

            // Send update to device
            console.log(`[Settings] Sending update_setting: ${key} = ${JSON.stringify(value)} to ${currentSettingsDeviceId}`);
            ws.send(JSON.stringify({
                type: 'update_setting',
                key: key,
                value: value
            }));

            console.log(`Updating setting ${key} = ${value} on device ${currentSettingsDeviceId}`);
        }

        function sendDeviceCommand(command, data = {}) {
            if (!currentSettingsDeviceId) {
                alert('No device selected.');
                return;
            }

            const ws = wsMap[currentSettingsDeviceId];
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket not connected. Cannot send command.');
                return;
            }

            // Send command to device
            console.log(`[Command] Sending ${command} to ${currentSettingsDeviceId}`, data);
            ws.send(JSON.stringify({
                type: command,
                ...data
            }));
        }

        function runPumpCalibration(pumpNum, duration) {
            if (!currentSettingsDeviceId) {
                alert('No device selected.');
                return;
            }

            const ws = wsMap[currentSettingsDeviceId];
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket not connected. Cannot run pump.');
                return;
            }

            // Confirm before running pump
            if (!confirm(`Run Pump ${pumpNum} for ${duration} seconds?`)) {
                return;
            }

            console.log(`[Calibration] Running pump ${pumpNum} for ${duration} seconds`);
            ws.send(JSON.stringify({
                type: 'run_pump_calibration',
                pump: pumpNum,
                duration: duration
            }));
        }

        function calibrateWaterTemp() {
            const input = document.getElementById('waterActualTemp');
            const val = parseFloat(input ? input.value : '0');

            if (!val || val <= -50 || val > 150) {
                alert('Enter a valid actual water temperature');
                return;
            }

            sendDeviceCommand('calibrate_water_temp', { actualTemp: val });
            input.value = '';
        }

        function calibrateAirTemp() {
            const input = document.getElementById('airActualTemp');
            const val = parseFloat(input ? input.value : '0');

            if (!val || val <= -50 || val > 150) {
                alert('Enter a valid actual air temperature');
                return;
            }

            sendDeviceCommand('calibrate_air_temp', { actualTemp: val });
            input.value = '';
        }

        function clearWaterTempCal() {
            sendDeviceCommand('clear_water_temp_cal');
        }

        function clearAirTempCal() {
            sendDeviceCommand('clear_air_temp_cal');
        }

        // Hydroponic Controller Settings - Separate Modals
        let currentHydroModalType = null;
        let hydroSensorUpdateInterval = null;

        // Modal opener functions
        function openGeneralSettingsModal(deviceId) {
            currentHydroModalType = 'general';
            const device = allDevices.find(d => d.device_id === deviceId);
            const deviceName = device ? device.name : deviceId;
            const deviceType = device ? device.device_type : 'hydroponic_controller';

            currentSettingsDeviceId = deviceId;
            currentSettingsDeviceType = deviceType;

            document.getElementById('settings-modal-title').textContent = `${deviceName} - General Settings`;
            document.getElementById('settings-modal-body').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <div>Loading settings from device...</div>
                </div>
            `;
            document.getElementById('settings-modal').style.display = 'block';
            requestDeviceSettings(deviceId);
        }

        function openSensorConfigModal(deviceId) {
            currentHydroModalType = 'sensors';
            const device = allDevices.find(d => d.device_id === deviceId);
            const deviceName = device ? device.name : deviceId;
            const deviceType = device ? device.device_type : 'hydroponic_controller';

            currentSettingsDeviceId = deviceId;
            currentSettingsDeviceType = deviceType;

            document.getElementById('settings-modal-title').textContent = `${deviceName} - Sensor Config`;
            document.getElementById('settings-modal-body').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <div>Loading sensor data...</div>
                </div>
            `;
            document.getElementById('settings-modal').style.display = 'block';
            requestDeviceSettings(deviceId);
        }

        function openCalibrationModal(deviceId) {
            currentHydroModalType = 'calibration';
            const device = allDevices.find(d => d.device_id === deviceId);
            const deviceName = device ? device.name : deviceId;
            const deviceType = device ? device.device_type : 'hydroponic_controller';

            currentSettingsDeviceId = deviceId;
            currentSettingsDeviceType = deviceType;

            document.getElementById('settings-modal-title').textContent = `${deviceName} - pH & EC Calibration`;
            document.getElementById('settings-modal-body').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <div>Loading calibration settings...</div>
                </div>
            `;
            document.getElementById('settings-modal').style.display = 'block';
            requestDeviceSettings(deviceId);
        }

        function openDosingModal(deviceId) {
            currentHydroModalType = 'dosing';
            const device = allDevices.find(d => d.device_id === deviceId);
            const deviceName = device ? device.name : deviceId;
            const deviceType = device ? device.device_type : 'hydroponic_controller';

            currentSettingsDeviceId = deviceId;
            currentSettingsDeviceType = deviceType;

            document.getElementById('settings-modal-title').textContent = `${deviceName} - pH & EC Dosing`;
            document.getElementById('settings-modal-body').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <div>Loading dosing settings...</div>
                </div>
            `;
            document.getElementById('settings-modal').style.display = 'block';
            requestDeviceSettings(deviceId);
        }

        function openAutomationsModal(deviceId) {
            currentHydroModalType = 'automation';
            const device = allDevices.find(d => d.device_id === deviceId);
            const deviceName = device ? device.name : deviceId;
            const deviceType = device ? device.device_type : 'hydroponic_controller';

            currentSettingsDeviceId = deviceId;
            currentSettingsDeviceType = deviceType;

            document.getElementById('settings-modal-title').textContent = `${deviceName} - Automations`;
            document.getElementById('settings-modal-body').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <div>Loading automation settings...</div>
                </div>
            `;
            document.getElementById('settings-modal').style.display = 'block';
            requestDeviceSettings(deviceId);
        }

        function openAdvancedSettingsModal(deviceId) {
            currentHydroModalType = 'advanced';
            const device = allDevices.find(d => d.device_id === deviceId);
            const deviceName = device ? device.name : deviceId;
            const deviceType = device ? device.device_type : 'hydroponic_controller';

            currentSettingsDeviceId = deviceId;
            currentSettingsDeviceType = deviceType;

            document.getElementById('settings-modal-title').textContent = `${deviceName} - Advanced Settings`;
            document.getElementById('settings-modal-body').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #94a3b8;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
                    <div>Loading advanced settings...</div>
                </div>
            `;
            document.getElementById('settings-modal').style.display = 'block';
            requestDeviceSettings(deviceId);
        }

        function displayHydroGeneralModal(settings) {
            const html = `
                <style>
                    .setting-group {
                        background: rgba(59, 130, 246, 0.05);
                        padding: 1rem;
                        border-radius: 8px;
                        border: 1px solid #374151;
                        margin-bottom: 1rem;
                    }
                    .setting-group h4 {
                        color: #10b981;
                        margin: 0 0 1rem 0;
                        font-size: 1rem;
                    }
                    .setting-row {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 0.75rem;
                    }
                    .setting-row:last-child {
                        margin-bottom: 0;
                    }
                    .setting-label {
                        color: #94a3b8;
                        font-size: 0.9rem;
                        flex: 1;
                    }
                    .setting-input {
                        padding: 0.5rem;
                        background: #0f172a;
                        border: 1px solid #374151;
                        border-radius: 6px;
                        color: #fff;
                        font-size: 0.95rem;
                        width: 200px;
                    }
                </style>

                <div class="setting-group">
                    <h4>Device Configuration</h4>
                    <div class="setting-row">
                        <label class="setting-label">Device Name</label>
                        <input type="text" class="setting-input" style="width: 300px;"
                            value="${settings.device_name || ''}"
                            onchange="updateDeviceSetting('device_name', this.value)">
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Time Settings</h4>
                    <div class="setting-row">
                        <label class="setting-label">NTP Server</label>
                        <input type="text" class="setting-input" style="width: 250px;"
                            value="${settings.ntp_server || 'pool.ntp.org'}"
                            onchange="updateDeviceSetting('ntp_server', this.value)">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Timezone</label>
                        <select class="setting-input" style="width: 300px;"
                            onchange="updateDeviceSetting('timezone_offset', parseInt(this.value))">
                            <option value="-43200" ${(settings.timezone_offset || -18000) === -43200 ? 'selected' : ''}>UTC-12:00 (Baker Island)</option>
                            <option value="-39600" ${(settings.timezone_offset || -18000) === -39600 ? 'selected' : ''}>UTC-11:00 (Samoa)</option>
                            <option value="-36000" ${(settings.timezone_offset || -18000) === -36000 ? 'selected' : ''}>UTC-10:00 (Hawaii)</option>
                            <option value="-32400" ${(settings.timezone_offset || -18000) === -32400 ? 'selected' : ''}>UTC-09:00 (Alaska)</option>
                            <option value="-28800" ${(settings.timezone_offset || -18000) === -28800 ? 'selected' : ''}>UTC-08:00 (Pacific)</option>
                            <option value="-25200" ${(settings.timezone_offset || -18000) === -25200 ? 'selected' : ''}>UTC-07:00 (Mountain)</option>
                            <option value="-21600" ${(settings.timezone_offset || -18000) === -21600 ? 'selected' : ''}>UTC-06:00 (Central)</option>
                            <option value="-18000" ${(settings.timezone_offset || -18000) === -18000 ? 'selected' : ''}>UTC-05:00 (Eastern)</option>
                            <option value="-14400" ${(settings.timezone_offset || -18000) === -14400 ? 'selected' : ''}>UTC-04:00 (Atlantic)</option>
                            <option value="-12600" ${(settings.timezone_offset || -18000) === -12600 ? 'selected' : ''}>UTC-03:30 (Newfoundland)</option>
                            <option value="-10800" ${(settings.timezone_offset || -18000) === -10800 ? 'selected' : ''}>UTC-03:00 (Brazil)</option>
                            <option value="-7200" ${(settings.timezone_offset || -18000) === -7200 ? 'selected' : ''}>UTC-02:00 (Mid-Atlantic)</option>
                            <option value="-3600" ${(settings.timezone_offset || -18000) === -3600 ? 'selected' : ''}>UTC-01:00 (Azores)</option>
                            <option value="0" ${(settings.timezone_offset || -18000) === 0 ? 'selected' : ''}>UTC+00:00 (London)</option>
                            <option value="3600" ${(settings.timezone_offset || -18000) === 3600 ? 'selected' : ''}>UTC+01:00 (Paris)</option>
                            <option value="7200" ${(settings.timezone_offset || -18000) === 7200 ? 'selected' : ''}>UTC+02:00 (Cairo)</option>
                            <option value="10800" ${(settings.timezone_offset || -18000) === 10800 ? 'selected' : ''}>UTC+03:00 (Moscow)</option>
                            <option value="12600" ${(settings.timezone_offset || -18000) === 12600 ? 'selected' : ''}>UTC+03:30 (Tehran)</option>
                            <option value="14400" ${(settings.timezone_offset || -18000) === 14400 ? 'selected' : ''}>UTC+04:00 (Dubai)</option>
                            <option value="18000" ${(settings.timezone_offset || -18000) === 18000 ? 'selected' : ''}>UTC+05:00 (Karachi)</option>
                            <option value="19800" ${(settings.timezone_offset || -18000) === 19800 ? 'selected' : ''}>UTC+05:30 (Mumbai)</option>
                            <option value="21600" ${(settings.timezone_offset || -18000) === 21600 ? 'selected' : ''}>UTC+06:00 (Dhaka)</option>
                            <option value="25200" ${(settings.timezone_offset || -18000) === 25200 ? 'selected' : ''}>UTC+07:00 (Bangkok)</option>
                            <option value="28800" ${(settings.timezone_offset || -18000) === 28800 ? 'selected' : ''}>UTC+08:00 (Singapore)</option>
                            <option value="32400" ${(settings.timezone_offset || -18000) === 32400 ? 'selected' : ''}>UTC+09:00 (Tokyo)</option>
                            <option value="36000" ${(settings.timezone_offset || -18000) === 36000 ? 'selected' : ''}>UTC+10:00 (Sydney)</option>
                            <option value="43200" ${(settings.timezone_offset || -18000) === 43200 ? 'selected' : ''}>UTC+12:00 (Auckland)</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Daylight Saving Time</label>
                        <label class="switch">
                            <input type="checkbox" ${settings.dst_offset === 3600 ? 'checked' : ''}
                                onchange="updateDeviceSetting('dst_offset', this.checked ? 3600 : 0)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            `;
            document.getElementById('settings-modal-body').innerHTML = html;
        }

        function displayHydroSensorsModal(settings) {
            const html = `
                <style>
                    .setting-group {
                        background: rgba(59, 130, 246, 0.05);
                        padding: 1rem;
                        border-radius: 8px;
                        border: 1px solid #374151;
                        margin-bottom: 1rem;
                    }
                    .setting-group h4 {
                        color: #10b981;
                        margin: 0 0 1rem 0;
                        font-size: 1rem;
                    }
                    .setting-row {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 0.75rem;
                        padding-bottom: 0.75rem;
                        border-bottom: 1px solid #334155;
                    }
                    .setting-row:last-child {
                        margin-bottom: 0;
                        padding-bottom: 0;
                        border-bottom: none;
                    }
                    .setting-label {
                        color: #94a3b8;
                        font-size: 0.9rem;
                    }
                    .setting-input {
                        padding: 0.5rem;
                        background: #0f172a;
                        border: 1px solid #374151;
                        border-radius: 6px;
                        color: #fff;
                        width: 100px;
                    }
                    .sensor-status {
                        color: #94a3b8;
                        font-size: 0.85rem;
                        margin-top: 0.5rem;
                    }
                </style>

                <div class="setting-group">
                    <h4>pH Target Range</h4>
                    <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">Typical: Seedlings 5.5-6.0, Veg 5.5-6.5, Flower 6.0-6.8</p>
                    <div class="setting-row">
                        <label class="setting-label">Minimum pH</label>
                        <input type="number" class="setting-input" step="0.1" min="0" max="14"
                            value="${settings.ph_min || 5.5}"
                            onchange="updateDeviceSetting('ph_min', parseFloat(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Maximum pH</label>
                        <input type="number" class="setting-input" step="0.1" min="0" max="14"
                            value="${settings.ph_max || 6.5}"
                            onchange="updateDeviceSetting('ph_max', parseFloat(this.value))">
                    </div>
                    <div class="sensor-status">Current pH: <span id="sensor-ph" style="color: #10b981; font-weight: 600;">--</span></div>
                </div>

                <div class="setting-group">
                    <h4>EC Target Range</h4>
                    <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">Typical: Seedlings 0.5-0.8, Veg 1.0-1.4, Flower 1.2-2.0 mS/cm</p>
                    <div class="setting-row">
                        <label class="setting-label">Minimum EC (mS/cm)</label>
                        <input type="number" class="setting-input" step="0.1" min="0" max="10"
                            value="${(settings.ec_min || 1000) / 1000}"
                            onchange="updateDeviceSetting('ec_min', parseFloat(this.value) * 1000)">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Maximum EC (mS/cm)</label>
                        <input type="number" class="setting-input" step="0.1" min="0" max="10"
                            value="${(settings.ec_max || 2000) / 1000}"
                            onchange="updateDeviceSetting('ec_max', parseFloat(this.value) * 1000)">
                    </div>
                    <div class="sensor-status">Current EC: <span id="sensor-ec" style="color: #10b981; font-weight: 600;">--</span> ŒºS/cm</div>
                </div>

                <div class="setting-group">
                    <h4>Temperature Sensors</h4>
                    <div class="setting-row">
                        <label class="setting-label">Water Temperature Sensor</label>
                        <label class="switch">
                            <input type="checkbox" ${settings.water_temp_enabled ? 'checked' : ''}
                                onchange="updateDeviceSetting('water_temp_enabled', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="sensor-status">Status: <span id="water-temp-status">--</span></div>
                    <div class="sensor-status">Current: <span id="sensor-water-temp" style="color: #10b981; font-weight: 600;">--</span> ¬∞C</div>

                    <div class="setting-row" style="margin-top: 1rem;">
                        <label class="setting-label">Air Temperature Sensor</label>
                        <label class="switch">
                            <input type="checkbox" ${settings.air_temp_enabled ? 'checked' : ''}
                                onchange="updateDeviceSetting('air_temp_enabled', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="sensor-status">Status: <span id="air-temp-status">--</span></div>
                    <div class="sensor-status">Current: <span id="sensor-air-temp" style="color: #10b981; font-weight: 600;">--</span> ¬∞C</div>

                    <div class="setting-row" style="margin-top: 1rem;">
                        <label class="setting-label">Temperature Unit</label>
                        <select class="setting-input" style="width: 150px;"
                            onchange="updateDeviceSetting('use_fahrenheit', this.value === 'fahrenheit')">
                            <option value="fahrenheit" ${settings.use_fahrenheit ? 'selected' : ''}>Fahrenheit (¬∞F)</option>
                            <option value="celsius" ${!settings.use_fahrenheit ? 'selected' : ''}>Celsius (¬∞C)</option>
                        </select>
                    </div>

                    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #334155;">
                        <h5 style="color: #94a3b8; font-size: 0.9rem; margin: 0 0 0.5rem 0;">Temperature Calibration</h5>
                        <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1.5rem;">Fine-tune sensors to match a reference thermometer. Enter the actual temperature and click Calibrate.</p>

                        <!-- Water Temperature Calibration -->
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <h6 style="color: #94a3b8; font-size: 0.85rem; font-weight: 500; margin: 0 0 0.75rem 0;">Water Sensor</h6>
                            <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.75rem;">
                                Current: <span id="sensor-water-temp-cal" style="color: #10b981; font-weight: 600;">--</span>
                                <span style="opacity: 0.6;">(offset: <span id="water-temp-offset-display" style="color: #94a3b8;">0.0</span>¬∞)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="number" id="waterActualTemp" step="0.1" placeholder="Actual temp"
                                    style="width: 100px; padding: 0.5rem; background: #0f172a; border: 1px solid #374151; border-radius: 6px; color: #fff;">
                                <button class="btn" style="padding: 0.5rem 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;"
                                    onclick="calibrateWaterTemp()">Calibrate</button>
                                <button class="btn" style="padding: 0.5rem 0.75rem; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; opacity: 0.7;"
                                    onclick="if(confirm('Clear water temperature calibration?')) clearWaterTempCal()">Clear</button>
                            </div>
                        </div>

                        <!-- Air Temperature Calibration -->
                        <div style="padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 6px;">
                            <h6 style="color: #94a3b8; font-size: 0.85rem; font-weight: 500; margin: 0 0 0.75rem 0;">Air Sensor</h6>
                            <div style="color: #64748b; font-size: 0.85rem; margin-bottom: 0.75rem;">
                                Current: <span id="sensor-air-temp-cal" style="color: #10b981; font-weight: 600;">--</span>
                                <span style="opacity: 0.6;">(offset: <span id="air-temp-offset-display" style="color: #94a3b8;">0.0</span>¬∞)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="number" id="airActualTemp" step="0.1" placeholder="Actual temp"
                                    style="width: 100px; padding: 0.5rem; background: #0f172a; border: 1px solid #374151; border-radius: 6px; color: #fff;">
                                <button class="btn" style="padding: 0.5rem 0.75rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;"
                                    onclick="calibrateAirTemp()">Calibrate</button>
                                <button class="btn" style="padding: 0.5rem 0.75rem; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; opacity: 0.7;"
                                    onclick="if(confirm('Clear air temperature calibration?')) clearAirTempCal()">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Water Level Sensor</h4>
                    <div class="setting-row">
                        <label class="setting-label">Sensor Type</label>
                        <select id="water-level-type-select" class="setting-input" style="width: 200px;"
                            onchange="updateDeviceSetting('water_level_type', parseInt(this.value)); updateWaterLevelUI();">
                            <option value="0" ${(settings.water_level_type || 0) === 0 ? 'selected' : ''}>Disabled</option>
                            <option value="1" ${(settings.water_level_type || 0) === 1 ? 'selected' : ''}>ETape (Continuous)</option>
                            <option value="2" ${(settings.water_level_type || 0) === 2 ? 'selected' : ''}>Water Sensors (3-Point)</option>
                        </select>
                    </div>
                    <div class="sensor-status">Current Level: <span id="sensor-water-level" style="color: #10b981; font-weight: 600;">--</span>%</div>

                    <!-- ETape Configuration -->
                    <div id="etape-config" style="display: ${(settings.water_level_type || 0) === 1 ? 'block' : 'none'}; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #334155;">
                        <h5 style="color: #94a3b8; font-size: 0.9rem; margin: 0 0 0.5rem 0;">Calibration</h5>
                        <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">Set sensor to tank empty, click Empty. Fill tank, click Full.</p>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
                            <button class="btn" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;"
                                onclick="sendDeviceCommand('calibrate_water_empty')">Set Empty</button>
                            <button class="btn" style="padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem;"
                                onclick="sendDeviceCommand('calibrate_water_full')">Set Full</button>
                            <button class="btn" style="padding: 0.5rem 1rem; background: #64748b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; opacity: 0.7;"
                                onclick="if(confirm('Clear water level calibration?')) sendDeviceCommand('clear_water_level_cal')">Clear</button>
                        </div>

                        <h5 style="color: #94a3b8; font-size: 0.9rem; margin: 1.5rem 0 0.5rem 0;">Level Thresholds</h5>
                        <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">Configure water level percentage thresholds for status determination.</p>
                        <div class="setting-row">
                            <label class="setting-label">Empty Threshold (%)</label>
                            <input type="number" class="setting-input" step="1" min="0" max="100"
                                value="${settings.water_level_empty_threshold || 5}"
                                onchange="updateDeviceSetting('water_level_empty_threshold', parseInt(this.value))">
                        </div>
                        <small style="color: #64748b; font-size: 0.8rem; display: block; margin: -0.5rem 0 0.75rem 0;">Below this % = Empty status</small>
                        <div class="setting-row">
                            <label class="setting-label">Low Threshold (%)</label>
                            <input type="number" class="setting-input" step="1" min="0" max="100"
                                value="${settings.water_level_low_threshold || 20}"
                                onchange="updateDeviceSetting('water_level_low_threshold', parseInt(this.value))">
                        </div>
                        <small style="color: #64748b; font-size: 0.8rem; display: block; margin: -0.5rem 0 0.75rem 0;">Below this % = Low status (blocks auto-dosing)</small>
                        <div class="setting-row">
                            <label class="setting-label">Full Threshold (%)</label>
                            <input type="number" class="setting-input" step="1" min="0" max="100"
                                value="${settings.water_level_full_threshold || 95}"
                                onchange="updateDeviceSetting('water_level_full_threshold', parseInt(this.value))">
                        </div>
                        <small style="color: #64748b; font-size: 0.8rem; display: block; margin: -0.5rem 0 0 0;">Above this % = Full status</small>
                    </div>

                    <!-- 3-Point Water Sensor Configuration -->
                    <div id="water-sensors-config" style="display: ${(settings.water_level_type || 0) === 2 ? 'block' : 'none'}; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #334155;">
                        <h5 style="color: #94a3b8; font-size: 0.9rem; margin: 0 0 1rem 0;">Sensor Output Type</h5>
                        <div class="setting-row">
                            <label class="setting-label">Output Type</label>
                            <select class="setting-input" style="width: 250px;"
                                onchange="updateDeviceSetting('water_sensor_output_type', parseInt(this.value))">
                                <option value="0" ${(settings.water_sensor_output_type || 0) === 0 ? 'selected' : ''}>NPN (LOW when triggered)</option>
                                <option value="1" ${(settings.water_sensor_output_type || 0) === 1 ? 'selected' : ''}>PNP (HIGH when triggered)</option>
                            </select>
                        </div>
                        <small style="color: #64748b; font-size: 0.8rem; display: block; margin-top: 0.5rem;">Most sensors are NPN. Check your sensor's datasheet if unsure.</small>
                    </div>
                </div>
            `;
            document.getElementById('settings-modal-body').innerHTML = html;

            // Start updating sensors
            startHydroSensorUpdates();
        }

        function updateWaterLevelUI() {
            const type = parseInt(document.getElementById('water-level-type-select').value);
            document.getElementById('etape-config').style.display = type === 1 ? 'block' : 'none';
            document.getElementById('water-sensors-config').style.display = type === 2 ? 'block' : 'none';
        }

        function displayHydroCalibrationModal(settings) {
            const html = `
                <style>
                    .setting-group {
                        background: rgba(59, 130, 246, 0.05);
                        padding: 1rem;
                        border-radius: 8px;
                        border: 1px solid #374151;
                        margin-bottom: 1rem;
                    }
                    .setting-group h4 {
                        color: #10b981;
                        margin: 0 0 1rem 0;
                        font-size: 1rem;
                    }
                    .setting-row {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 0.75rem;
                    }
                    .setting-row:last-child {
                        margin-bottom: 0;
                    }
                    .setting-label {
                        color: #94a3b8;
                        font-size: 0.9rem;
                        flex: 1;
                    }
                    .setting-input {
                        padding: 0.5rem;
                        background: #0f172a;
                        border: 1px solid #374151;
                        border-radius: 6px;
                        color: #fff;
                        font-size: 0.95rem;
                        width: 200px;
                    }
                </style>

                <div class="setting-group">
                    <h4>pH Calibration</h4>
                    <div class="setting-row">
                        <label class="setting-label">pH 4.0 Calibration Value</label>
                        <input type="number" class="setting-input" step="0.01" min="0" max="14"
                            value="${settings.ph_cal_4 || 4.0}"
                            onchange="updateDeviceSetting('ph_cal_4', parseFloat(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">pH 7.0 Calibration Value</label>
                        <input type="number" class="setting-input" step="0.01" min="0" max="14"
                            value="${settings.ph_cal_7 || 7.0}"
                            onchange="updateDeviceSetting('ph_cal_7', parseFloat(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">pH 10.0 Calibration Value</label>
                        <input type="number" class="setting-input" step="0.01" min="0" max="14"
                            value="${settings.ph_cal_10 || 10.0}"
                            onchange="updateDeviceSetting('ph_cal_10', parseFloat(this.value))">
                    </div>
                </div>

                <div class="setting-group">
                    <h4>EC Calibration</h4>
                    <div class="setting-row">
                        <label class="setting-label">EC Dry Calibration</label>
                        <input type="number" class="setting-input" step="1" min="0"
                            value="${settings.ec_cal_dry || 0}"
                            onchange="updateDeviceSetting('ec_cal_dry', parseInt(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">EC Low Point (ŒºS/cm)</label>
                        <input type="number" class="setting-input" step="1" min="0"
                            value="${settings.ec_cal_low || 1413}"
                            onchange="updateDeviceSetting('ec_cal_low', parseInt(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">EC High Point (ŒºS/cm)</label>
                        <input type="number" class="setting-input" step="1" min="0"
                            value="${settings.ec_cal_high || 12880}"
                            onchange="updateDeviceSetting('ec_cal_high', parseInt(this.value))">
                    </div>
                </div>
            `;
            document.getElementById('settings-modal-body').innerHTML = html;
        }

        function displayHydroDosingModal(settings) {
            const volumeUnit = settings.use_gallons ? 'gal' : 'L';
            const html = `
                <style>
                    .setting-group {
                        background: rgba(59, 130, 246, 0.05);
                        padding: 1rem;
                        border-radius: 8px;
                        border: 1px solid #374151;
                        margin-bottom: 1rem;
                    }
                    .setting-group h4 {
                        color: #10b981;
                        margin: 0 0 1rem 0;
                        font-size: 1rem;
                    }
                    .setting-row {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 0.75rem;
                    }
                    .setting-row:last-child {
                        margin-bottom: 0;
                    }
                    .setting-label {
                        color: #94a3b8;
                        font-size: 0.9rem;
                        flex: 1;
                    }
                    .setting-input {
                        padding: 0.5rem;
                        background: #0f172a;
                        border: 1px solid #374151;
                        border-radius: 6px;
                        color: #fff;
                        font-size: 0.95rem;
                        width: 200px;
                    }
                    .setting-input-small {
                        padding: 0.5rem;
                        background: #0f172a;
                        border: 1px solid #374151;
                        border-radius: 6px;
                        color: #fff;
                        font-size: 0.95rem;
                        width: 120px;
                    }
                    .unit-selector {
                        display: inline-flex;
                        gap: 0.5rem;
                        margin-left: 0.5rem;
                    }
                    .calibration-btn {
                        padding: 0.5rem 1rem;
                        background: #3b82f6;
                        border: none;
                        border-radius: 6px;
                        color: #fff;
                        cursor: pointer;
                        font-size: 0.9rem;
                        transition: background 0.2s;
                    }
                    .calibration-btn:hover {
                        background: #2563eb;
                    }
                    .calibration-btn:active {
                        background: #1d4ed8;
                    }
                    .stat-value {
                        color: #10b981;
                        font-weight: 500;
                    }
                    .info-text {
                        color: #64748b;
                        font-size: 0.85rem;
                        font-style: italic;
                    }
                </style>

                <div class="setting-group">
                    <h4>Reservoir Configuration</h4>
                    <div class="setting-row">
                        <label class="setting-label">Reservoir Volume</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" class="setting-input-small" step="0.1" min="0.1"
                                value="${settings.system_volume || 5.0}"
                                onchange="updateDeviceSetting('system_volume', parseFloat(this.value))">
                            <label class="switch">
                                <input type="checkbox" ${settings.use_gallons ? 'checked' : ''}
                                    onchange="updateDeviceSetting('use_gallons', this.checked)">
                                <span class="slider round"></span>
                            </label>
                            <span style="color: #94a3b8; min-width: 30px;">${volumeUnit}</span>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Dosing Settings</h4>
                    <div class="setting-row">
                        <label class="setting-label">pH Target for Dosing</label>
                        <input type="number" class="setting-input" step="0.01" min="0" max="14"
                            value="${settings.ph_target || 6.0}"
                            onchange="updateDeviceSetting('ph_target', parseFloat(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">pH Up Strength (ml/pH/${volumeUnit})</label>
                        <input type="number" class="setting-input" step="0.01" min="0"
                            value="${settings.ph_up_strength || 0.5}"
                            onchange="updateDeviceSetting('ph_up_strength', parseFloat(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">pH Down Strength (ml/pH/${volumeUnit})</label>
                        <input type="number" class="setting-input" step="0.01" min="0"
                            value="${settings.ph_down_strength || 0.5}"
                            onchange="updateDeviceSetting('ph_down_strength', parseFloat(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Max Dose Limit (ml)</label>
                        <input type="number" class="setting-input" step="0.1" min="0.1"
                            value="${settings.max_dose_ml || 10.0}"
                            onchange="updateDeviceSetting('max_dose_ml', parseFloat(this.value))">
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Pump Calibration</h4>
                    <div class="setting-row">
                        <label class="setting-label">Pump 1 (pH Up) - sec/ml</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" class="setting-input-small" step="0.01" min="0.01"
                                value="${settings.pump1_calibration || 1.0}"
                                onchange="updateDeviceSetting('pump1_calibration', parseFloat(this.value))">
                            <button class="calibration-btn" onclick="runPumpCalibration(1, 10)">Run 10 sec</button>
                        </div>
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Pump 2 (pH Down) - sec/ml</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="number" class="setting-input-small" step="0.01" min="0.01"
                                value="${settings.pump2_calibration || 1.0}"
                                onchange="updateDeviceSetting('pump2_calibration', parseFloat(this.value))">
                            <button class="calibration-btn" onclick="runPumpCalibration(2, 10)">Run 10 sec</button>
                        </div>
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Pump 1 Last Calibrated</label>
                        <span class="info-text">${settings.pump1_last_calibrated || 'Never'}</span>
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Pump 2 Last Calibrated</label>
                        <span class="info-text">${settings.pump2_last_calibrated || 'Never'}</span>
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Pump Statistics</h4>
                    <div class="setting-row">
                        <label class="setting-label">Pump 1 Activations</label>
                        <span class="stat-value">${settings.pump1_activations || 0}</span>
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Pump 1 Total Runtime</label>
                        <span class="stat-value">${(settings.pump1_total_duration || 0).toFixed(1)} sec</span>
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Pump 2 Activations</label>
                        <span class="stat-value">${settings.pump2_activations || 0}</span>
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Pump 2 Total Runtime</label>
                        <span class="stat-value">${(settings.pump2_total_duration || 0).toFixed(1)} sec</span>
                    </div>
                </div>
            `;
            document.getElementById('settings-modal-body').innerHTML = html;
        }

        function displayHydroAutomationModal(settings) {
            const html = `
                <style>
                    .setting-group {
                        background: rgba(59, 130, 246, 0.05);
                        padding: 1rem;
                        border-radius: 8px;
                        border: 1px solid #374151;
                        margin-bottom: 1rem;
                    }
                    .setting-group h4 {
                        color: #10b981;
                        margin: 0 0 1rem 0;
                        font-size: 1rem;
                    }
                    .setting-row {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 0.75rem;
                    }
                    .setting-row:last-child {
                        margin-bottom: 0;
                    }
                    .setting-label {
                        color: #94a3b8;
                        font-size: 0.9rem;
                        flex: 1;
                    }
                    .setting-input {
                        padding: 0.5rem;
                        background: #0f172a;
                        border: 1px solid #374151;
                        border-radius: 6px;
                        color: #fff;
                        font-size: 0.95rem;
                        width: 200px;
                    }
                </style>

                <div class="setting-group">
                    <h4>Auto-Fill Configuration</h4>
                    <div class="setting-row">
                        <label class="setting-label">Enable Auto-Fill</label>
                        <label class="switch">
                            <input type="checkbox" ${settings.auto_fill_enabled ? 'checked' : ''}
                                onchange="updateDeviceSetting('auto_fill_enabled', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Fill Start Level (%)</label>
                        <input type="number" class="setting-input" step="1" min="0" max="100"
                            value="${settings.auto_fill_start || 30}"
                            onchange="updateDeviceSetting('auto_fill_start', parseInt(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Fill Stop Level (%)</label>
                        <input type="number" class="setting-input" step="1" min="0" max="100"
                            value="${settings.auto_fill_stop || 80}"
                            onchange="updateDeviceSetting('auto_fill_stop', parseInt(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Max Fill Duration (seconds)</label>
                        <input type="number" class="setting-input" step="10" min="10" max="600"
                            value="${settings.auto_fill_max_duration || 300}"
                            onchange="updateDeviceSetting('auto_fill_max_duration', parseInt(this.value))">
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Remote Fill Valve</h4>
                    <div class="setting-row">
                        <label class="setting-label">Fill Valve Host</label>
                        <input type="text" class="setting-input" style="width: 250px;"
                            value="${settings.fill_valve_host || ''}"
                            placeholder="192.168.1.100"
                            onchange="updateDeviceSetting('fill_valve_host', this.value)">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Fill Valve Port</label>
                        <input type="number" class="setting-input" min="1" max="65535"
                            value="${settings.fill_valve_port || 80}"
                            onchange="updateDeviceSetting('fill_valve_port', parseInt(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Fill Valve Number</label>
                        <input type="number" class="setting-input" min="1" max="8"
                            value="${settings.fill_valve_num || 1}"
                            onchange="updateDeviceSetting('fill_valve_num', parseInt(this.value))">
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Remote Drain Valve</h4>
                    <div class="setting-row">
                        <label class="setting-label">Drain Valve Host</label>
                        <input type="text" class="setting-input" style="width: 250px;"
                            value="${settings.drain_valve_host || ''}"
                            placeholder="192.168.1.100"
                            onchange="updateDeviceSetting('drain_valve_host', this.value)">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Drain Valve Port</label>
                        <input type="number" class="setting-input" min="1" max="65535"
                            value="${settings.drain_valve_port || 80}"
                            onchange="updateDeviceSetting('drain_valve_port', parseInt(this.value))">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Drain Valve Number</label>
                        <input type="number" class="setting-input" min="1" max="8"
                            value="${settings.drain_valve_num || 2}"
                            onchange="updateDeviceSetting('drain_valve_num', parseInt(this.value))">
                    </div>
                </div>

                <div class="setting-group">
                    <h4>Leak Detection</h4>
                    <div class="setting-row">
                        <label class="setting-label">Enable Leak Detection</label>
                        <label class="switch">
                            <input type="checkbox" ${settings.leak_detection_enabled !== false ? 'checked' : ''}
                                onchange="updateDeviceSetting('leak_detection_enabled', this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Leak Sensor Pin</label>
                        <input type="number" class="setting-input" min="0" max="40"
                            value="${settings.leak_sensor_pin || 10}"
                            onchange="updateDeviceSetting('leak_sensor_pin', parseInt(this.value))">
                    </div>
                </div>
            `;
            document.getElementById('settings-modal-body').innerHTML = html;
        }

        function displayHydroAdvancedModal(settings) {
            const html = `
                <style>
                    .setting-group {
                        background: rgba(59, 130, 246, 0.05);
                        padding: 1rem;
                        border-radius: 8px;
                        border: 1px solid #374151;
                        margin-bottom: 1rem;
                    }
                    .setting-group h4 {
                        color: #10b981;
                        margin: 0 0 1rem 0;
                        font-size: 1rem;
                    }
                    .setting-row {
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        margin-bottom: 0.75rem;
                    }
                    .setting-row:last-child {
                        margin-bottom: 0;
                    }
                    .setting-label {
                        color: #94a3b8;
                        font-size: 0.9rem;
                        flex: 1;
                    }
                    .setting-input {
                        padding: 0.5rem;
                        background: #0f172a;
                        border: 1px solid #374151;
                        border-radius: 6px;
                        color: #fff;
                        font-size: 0.95rem;
                        width: 200px;
                    }
                    .info-box {
                        background: rgba(59, 130, 246, 0.1);
                        border: 1px solid rgba(59, 130, 246, 0.3);
                        color: #94a3b8;
                        padding: 0.75rem;
                        border-radius: 6px;
                        font-size: 0.85rem;
                        margin-bottom: 1.5rem;
                    }
                </style>

                <div class="info-box">
                    ‚ö†Ô∏è <strong>Admin Only:</strong> These settings control how the device communicates with the server. Changes take effect immediately and persist across reboots.
                </div>

                <div class="setting-group">
                    <h4>Server Communication</h4>
                    <div class="setting-row">
                        <label class="setting-label">Heartbeat Interval (seconds)</label>
                        <input type="number" class="setting-input" min="10" max="300"
                            value="${settings.update_interval || 30}"
                            onchange="updateDeviceSetting('update_interval', parseInt(this.value))"
                            title="How often the device sends status updates to the server">
                    </div>
                    <div class="setting-row">
                        <label class="setting-label">Log Interval (seconds)</label>
                        <input type="number" class="setting-input" min="60" max="7200"
                            value="${settings.log_interval || 3600}"
                            onchange="updateDeviceSetting('log_interval', parseInt(this.value))"
                            title="How often sensor readings are saved to the database">
                    </div>
                </div>

                <div style="color: #64748b; font-size: 0.85rem; margin-top: 1rem;">
                    <strong>Heartbeat Interval:</strong> Determines how often the device reports its online status (default: 30s)<br>
                    <strong>Log Interval:</strong> Determines data storage frequency to reduce database writes (default: 3600s = 1 hour)
                </div>
            `;
            document.getElementById('settings-modal-body').innerHTML = html;
        }

        function startHydroSensorUpdates() {
            // Clear any existing interval
            if (hydroSensorUpdateInterval) {
                clearInterval(hydroSensorUpdateInterval);
            }

            // Update sensors immediately
            updateHydroSensorReadings();

            // Then update every 2 seconds
            hydroSensorUpdateInterval = setInterval(updateHydroSensorReadings, 2000);
        }

        function updateHydroSensorReadings() {
            if (!currentSettingsDeviceId) return;

            const device = allDevices.find(d => d.device_id === currentSettingsDeviceId);
            if (!device) {
                console.log('[Update] Device not found in allDevices');
                return;
            }

            // Debug: Log what sensor values we have
            console.log('[Update] Device sensor data:', {
                pH: device.pH,
                ec: device.ec,
                water_temp: device.water_temp,
                air_temp: device.air_temp,
                water_level: device.water_level,
                water_temp_offset: device.water_temp_offset,
                air_temp_offset: device.air_temp_offset
            });

            // Update sensor displays with current values
            const phEl = document.getElementById('sensor-ph');
            const ecEl = document.getElementById('sensor-ec');
            const waterTempEl = document.getElementById('sensor-water-temp');
            const airTempEl = document.getElementById('sensor-air-temp');
            const waterLevelEl = document.getElementById('sensor-water-level');

            if (phEl && device.pH !== undefined && device.pH !== null) {
                phEl.innerHTML = device.pH.toFixed(2) + '<span class="sensor-unit">pH</span>';
            }
            if (ecEl && device.ec !== undefined && device.ec !== null) {
                ecEl.innerHTML = device.ec.toFixed(0) + '<span class="sensor-unit">ŒºS/cm</span>';
            }
            if (waterTempEl && device.water_temp !== undefined && device.water_temp !== null) {
                waterTempEl.innerHTML = device.water_temp.toFixed(1) + '<span class="sensor-unit">¬∞C</span>';
            }
            if (airTempEl && device.air_temp !== undefined && device.air_temp !== null) {
                airTempEl.innerHTML = device.air_temp.toFixed(1) + '<span class="sensor-unit">¬∞C</span>';
            }
            if (waterLevelEl && device.water_level !== undefined && device.water_level !== null) {
                waterLevelEl.innerHTML = device.water_level.toFixed(0) + '<span class="sensor-unit">%</span>';
            }

            // Update temperature calibration displays
            const waterTempCalEl = document.getElementById('sensor-water-temp-cal');
            const airTempCalEl = document.getElementById('sensor-air-temp-cal');
            const waterOffsetEl = document.getElementById('water-temp-offset-display');
            const airOffsetEl = document.getElementById('air-temp-offset-display');

            if (waterTempCalEl && device.water_temp !== undefined && device.water_temp !== null) {
                waterTempCalEl.textContent = device.water_temp.toFixed(1) + '¬∞C';
            }
            if (airTempCalEl && device.air_temp !== undefined && device.air_temp !== null) {
                airTempCalEl.textContent = device.air_temp.toFixed(1) + '¬∞C';
            }
            if (waterOffsetEl && device.water_temp_offset !== undefined && device.water_temp_offset !== null) {
                waterOffsetEl.textContent = device.water_temp_offset.toFixed(2);
            }
            if (airOffsetEl && device.air_temp_offset !== undefined && device.air_temp_offset !== null) {
                airOffsetEl.textContent = device.air_temp_offset.toFixed(2);
            }
        }

        // Edit Valve Labels Modal
        let currentLabelsDeviceId = null;
        let currentValveLabels = {};

        function openEditLabelsModal(deviceId) {
            currentLabelsDeviceId = deviceId;

            // Find device name
            const device = allDevices.find(d => d.device_id === deviceId);
            const deviceName = device ? device.name : deviceId;
            document.getElementById('labels-device-name').textContent = deviceName;

            // Get current labels from the valve panel if available
            const grid = document.getElementById(`valve-grid-${deviceId}`);
            if (grid) {
                const labels = grid.querySelectorAll('.valve-label');
                labels.forEach((label, index) => {
                    const input = document.getElementById(`label-${index + 1}`);
                    if (input) {
                        input.value = label.textContent || `Valve ${index + 1}`;
                        currentValveLabels[index + 1] = label.textContent;
                    }
                });
            } else {
                // Default labels if no data yet
                for (let i = 1; i <= 8; i++) {
                    const input = document.getElementById(`label-${i}`);
                    if (input) {
                        input.value = `Valve ${i}`;
                        currentValveLabels[i] = `Valve ${i}`;
                    }
                }
            }

            document.getElementById('labels-modal').style.display = 'block';
        }

        function closeLabelsModal() {
            document.getElementById('labels-modal').style.display = 'none';
            currentLabelsDeviceId = null;
            currentValveLabels = {};
        }

        function saveValveLabels(event) {
            event.preventDefault();

            if (!currentLabelsDeviceId) return;

            const ws = wsMap[currentLabelsDeviceId];
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Device is not connected. Please wait for the device to come online.');
                return;
            }

            // Collect labels from form
            const labels = {};
            for (let i = 1; i <= 8; i++) {
                const input = document.getElementById(`label-${i}`);
                if (input && input.value.trim()) {
                    labels[i] = input.value.trim();
                }
            }

            // Send labels to device via WebSocket
            ws.send(JSON.stringify({
                type: 'set_labels',
                labels: labels
            }));

            console.log('Sent set_labels command:', labels);

            // Close modal
            closeLabelsModal();

            // Show feedback
            showDeviceStatus(currentLabelsDeviceId, 'Labels updated', '#10b981');
        }

        // Fetch firmware version for environmental sensors
        async function fetchEnvironmentalVersion(device_id) {
            try {
                const response = await fetch(`/api/devices/${device_id}/environment/latest`);
                if (response.ok) {
                    const data = await response.json();
                    const versionElem = document.getElementById(`version-${device_id}`);
                    const updateBadge = document.getElementById(`update-badge-${device_id}`);
                    if (versionElem && data.firmware_version) {
                        versionElem.textContent = data.firmware_version;
                        // Update in allDevices array for search
                        const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                        if (deviceIndex !== -1) {
                            allDevices[deviceIndex].version = data.firmware_version;
                        }
                        // Check for firmware updates
                        checkForFirmwareUpdate(device_id, data.firmware_version, updateBadge);
                    } else if (versionElem) {
                        versionElem.textContent = 'N/A';
                    }
                } else {
                    const versionElem = document.getElementById(`version-${device_id}`);
                    if (versionElem) {
                        versionElem.textContent = 'N/A';
                    }
                }
            } catch (error) {
                console.error(`Error fetching version for ${device_id}:`, error);
                const versionElem = document.getElementById(`version-${device_id}`);
                if (versionElem) {
                    versionElem.textContent = 'N/A';
                }
            }
        }

        // Check if firmware update is available
        async function checkForFirmwareUpdate(device_id, current_version, badgeElem) {
            if (!badgeElem) return;

            try {
                const response = await fetch(`/api/firmware/check/${device_id}?current_version=${current_version}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.update_available) {
                        badgeElem.innerHTML = `<span style="background: #f59e0b; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; cursor: pointer;" onclick="showUpdateInfo('${device_id}', '${data.latest_version}', \`${(data.release_notes || '').replace(/`/g, '\\`').replace(/\n/g, '\\n')}\`)">UPDATE v${data.latest_version}</span>`;
                    }
                }
            } catch (error) {
                console.error(`Error checking firmware update for ${device_id}:`, error);
            }
        }

        // Show update info in alert (or could be a modal)
        function showUpdateInfo(device_id, version, release_notes) {
            const message = `Firmware Update Available\n\nDevice: ${device_id.substring(0, 8)}...\nNew Version: v${version}\n\n${release_notes ? 'Release Notes:\n' + release_notes : 'No release notes available.'}\n\nTo update, go to the heartbeat settings (‚ö° button) and click "Force Update Now".`;
            alert(message);
        }

        // Share Management Functions
        function openShareModal(device_id) {
            currentShareDeviceId = device_id;
            document.getElementById('share-device-name').textContent = `Device: ${device_id}`;
            document.getElementById('share-modal').style.display = 'block';
            loadShares(device_id);
        }

        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
            document.getElementById('share-code-result').innerHTML = '';
            document.getElementById('shares-list').innerHTML = '';
            currentShareDeviceId = null;
        }

        function toggleDeviceExpiresInput() {
            const expiresType = document.getElementById('share-expires-type').value;
            const expiresInput = document.getElementById('share-expires');
            expiresInput.style.display = expiresType === 'never' ? 'none' : 'inline-block';
        }

        async function createShare() {
            const permission = document.getElementById('permission-select').value;
            const expiresType = document.getElementById('share-expires-type').value;
            const expiresInDays = expiresType === 'never' ? null : parseInt(document.getElementById('share-expires').value);

            const response = await fetch(`/user/devices/${currentShareDeviceId}/share`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    permission_level: permission,
                    expires_in_days: expiresInDays
                })
            });

            const resultDiv = document.getElementById('share-code-result');
            if (response.ok) {
                const data = await response.json();
                const expiryText = data.expires_at
                    ? `Expires: ${new Date(data.expires_at).toLocaleString()}`
                    : 'Never expires';
                resultDiv.innerHTML = `
                    <div style="background: rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 6px; margin-top: 0.5rem;">
                        <p style="margin: 0; color: #10b981; font-weight: bold;">Share Code Generated!</p>
                        <p style="margin: 0.5rem 0; font-size: 1.2rem; font-family: monospace; color: #fff;">${data.share_code}</p>
                        <p style="margin: 0; font-size: 0.85rem; color: #888;">${expiryText}</p>
                        <button onclick="navigator.clipboard.writeText('${data.share_code}')" style="margin-top: 0.5rem; font-size: 0.85rem;">Copy Code</button>
                    </div>
                `;
                // Reload shares list
                loadShares(currentShareDeviceId);
            } else {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Failed to create share</p>`;
            }
        }

        async function loadShares(device_id) {
            const response = await fetch(`/user/devices/${device_id}/shares`);
            if (response.ok) {
                const shares = await response.json();
                const sharesDiv = document.getElementById('shares-list');

                if (shares.length === 0) {
                    sharesDiv.innerHTML = '<p style="color: #888;">No active shares</p>';
                    return;
                }

                sharesDiv.innerHTML = '';
                shares.forEach(share => {
                    const shareDiv = document.createElement('div');
                    shareDiv.style.padding = '1rem';
                    shareDiv.style.marginBottom = '0.5rem';
                    shareDiv.style.background = 'rgba(100, 116, 139, 0.2)';
                    shareDiv.style.borderRadius = '6px';

                    const statusText = share.accepted_at
                        ? `Accepted by ${share.shared_with_email}`
                        : `Pending (Code: ${share.share_code})`;

                    let expiryText;
                    if (share.expires_at === null) {
                        expiryText = 'Never expires';
                    } else {
                        const expiryDate = new Date(share.expires_at);
                        expiryText = expiryDate > new Date()
                            ? `Expires: ${expiryDate.toLocaleString()}`
                            : '<span style="color: #ef4444;">Expired</span>';
                    }

                    shareDiv.innerHTML = `
                        <p style="margin: 0 0 0.5rem 0;"><strong>${statusText}</strong></p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">Permission: ${share.permission_level}</p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">${expiryText}</p>
                        ${share.accepted_at ? `
                            <select id="perm-${share.id}" style="margin-top: 0.5rem; margin-right: 0.5rem;">
                                <option value="viewer" ${share.permission_level === 'viewer' ? 'selected' : ''}>View Only</option>
                                <option value="controller" ${share.permission_level === 'controller' ? 'selected' : ''}>Can Control</option>
                            </select>
                            <button onclick="updatePermission(${share.id})" style="font-size: 0.85rem;">Update</button>
                        ` : ''}
                        <button onclick="revokeShare(${share.id})" style="background: #dc2626; font-size: 0.85rem; margin-top: 0.5rem;">Revoke</button>
                    `;
                    sharesDiv.appendChild(shareDiv);
                });
            }
        }

        async function revokeShare(share_id) {
            if (!confirm('Are you sure you want to revoke this share?')) return;

            const response = await fetch(`/user/devices/shares/${share_id}`, { method: 'DELETE' });
            if (response.ok) {
                loadShares(currentShareDeviceId);
                alert('Share revoked successfully');
            } else {
                alert('Failed to revoke share');
            }
        }

        async function updatePermission(share_id) {
            const permission = document.getElementById(`perm-${share_id}`).value;
            const response = await fetch(`/user/devices/shares/${share_id}/permission`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ permission_level: permission })
            });

            if (response.ok) {
                alert('Permission updated successfully');
                loadShares(currentShareDeviceId);
            } else {
                alert('Failed to update permission');
            }
        }

        // Edit Device Functions
        async function openEditModal(device_id) {
            currentEditDeviceId = device_id;

            // Fetch current device data
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const device = devices.find(d => d.device_id === device_id);

                if (device) {
                    document.getElementById('edit-device-name').textContent = `Device: ${device_id}`;
                    document.getElementById('edit-name').value = device.name || '';

                    // Populate locations dropdown
                    const locationsResponse = await fetch('/user/locations');
                    if (locationsResponse.ok) {
                        const locations = await locationsResponse.json();
                        const select = document.getElementById('edit-location');
                        select.innerHTML = '<option value="">Unassigned</option>';

                        const ownedLocations = locations.filter(loc => loc.is_owner);
                        ownedLocations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.id;
                            option.textContent = loc.name;
                            if (device.location_id === loc.id) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                    }

                    document.getElementById('edit-modal').style.display = 'block';
                }
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
            currentEditDeviceId = null;
        }

        // Location Change Functions
        let currentLocationChangeDeviceId = null;

        async function openLocationChangeModal(device_id) {
            currentLocationChangeDeviceId = device_id;

            // Fetch current device data
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const device = devices.find(d => d.device_id === device_id);

                if (device) {
                    document.getElementById('location-change-device-name').textContent = `Device: ${device.name || device_id}`;

                    // Populate locations dropdown
                    const locationsResponse = await fetch('/user/locations');
                    if (locationsResponse.ok) {
                        const locations = await locationsResponse.json();
                        const select = document.getElementById('location-change-select');
                        select.innerHTML = '<option value="">Unassigned</option>';

                        const ownedLocations = locations.filter(loc => loc.is_owner);
                        ownedLocations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc.id;
                            option.textContent = loc.name;
                            if (device.location_id === loc.id) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                    }

                    document.getElementById('location-change-modal').style.display = 'block';
                }
            }
        }

        function closeLocationChangeModal() {
            document.getElementById('location-change-modal').style.display = 'none';
            currentLocationChangeDeviceId = null;
        }

        async function saveLocationChange(event) {
            event.preventDefault();

            const locationId = document.getElementById('location-change-select').value;

            const response = await fetch(`/user/devices/${currentLocationChangeDeviceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    location_id: locationId ? parseInt(locationId) : null
                })
            });

            if (response.ok) {
                closeLocationChangeModal();
                await loadDevices();
            } else {
                alert('Failed to update location');
            }
        }

        // Device Linking Functions
        async function openLinkModal(device_id) {
            currentLinkDeviceId = device_id;
            document.getElementById('link-device-name').textContent = `Feeding System: ${device_id}`;
            document.getElementById('link-modal').style.display = 'block';
            await loadAvailableLinks(device_id);
            await loadCurrentLinks(device_id);
        }

        function closeLinkModal() {
            document.getElementById('link-modal').style.display = 'none';
            currentLinkDeviceId = null;
        }

        async function loadAvailableLinks(device_id) {
            const listDiv = document.getElementById('available-links-list');
            listDiv.innerHTML = '<p style="color: #888;">Loading...</p>';

            try {
                const response = await fetch(`/user/devices/${device_id}/available-links`);
                if (response.ok) {
                    const available = await response.json();

                    if (available.length === 0) {
                        listDiv.innerHTML = '<p style="color: #888;">No devices available to link. Add environmental sensors or valve controllers first.</p>';
                        return;
                    }

                    listDiv.innerHTML = '';
                    available.forEach(device => {
                        const deviceDiv = document.createElement('div');
                        deviceDiv.style.cssText = 'padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(100, 116, 139, 0.2); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;';

                        const typeIcon = device.device_type === 'environmental' ? 'üå°Ô∏è' : 'üöø';
                        const typeName = device.device_type === 'environmental' ? 'Environmental Sensor' : 'Valve Controller';
                        const locationBadge = device.is_same_location
                            ? '<span style="background: #10b98130; color: #10b981; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Same Location</span>'
                            : '';

                        deviceDiv.innerHTML = `
                            <div>
                                <p style="margin: 0; font-weight: 600; color: #fff;">${typeIcon} ${device.name || device.system_name || 'Unnamed Device'}${locationBadge}</p>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #888;">${typeName} ‚Ä¢ ${device.location_name || 'No location'}</p>
                                <p style="margin: 0; font-size: 0.75rem; color: #64748b;">${device.device_id}</p>
                            </div>
                            <button onclick="linkDevice('${device.device_id}', '${device.device_type}')" style="background: #10b981; font-size: 0.85rem;">Link</button>
                        `;
                        listDiv.appendChild(deviceDiv);
                    });
                } else {
                    listDiv.innerHTML = '<p style="color: #ef4444;">Failed to load available devices</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p style="color: #ef4444;">Error loading available devices</p>';
            }
        }

        async function loadCurrentLinks(device_id) {
            const listDiv = document.getElementById('current-links-list');
            listDiv.innerHTML = '<p style="color: #888;">Loading...</p>';

            try {
                const response = await fetch(`/user/devices/${device_id}/links`);
                if (response.ok) {
                    const links = await response.json();

                    if (links.length === 0) {
                        listDiv.innerHTML = '<p style="color: #888;">No devices currently linked.</p>';
                        return;
                    }

                    listDiv.innerHTML = '';
                    links.forEach(link => {
                        const linkDiv = document.createElement('div');
                        linkDiv.style.cssText = 'padding: 0.75rem; margin-bottom: 0.5rem; background: rgba(59, 130, 246, 0.2); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;';

                        const typeIcon = link.child_device_type === 'environmental' ? 'üå°Ô∏è' : 'üöø';
                        const statusDot = link.child_device_is_online
                            ? '<span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; display: inline-block; margin-right: 0.5rem;"></span>'
                            : '<span style="width: 8px; height: 8px; background: #64748b; border-radius: 50%; display: inline-block; margin-right: 0.5rem;"></span>';
                        const inheritedBadge = link.is_location_inherited
                            ? '<span style="background: #f59e0b30; color: #f59e0b; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">Auto (Location)</span>'
                            : '';

                        linkDiv.innerHTML = `
                            <div>
                                <p style="margin: 0; font-weight: 600; color: #fff;">${statusDot}${typeIcon} ${link.child_device_name || link.child_device_system_name || 'Unnamed Device'}${inheritedBadge}</p>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.75rem; color: #64748b;">${link.child_device_id}</p>
                            </div>
                            <button onclick="unlinkDevice(${link.id})" style="background: #dc2626; font-size: 0.85rem;">Unlink</button>
                        `;
                        listDiv.appendChild(linkDiv);
                    });
                } else {
                    listDiv.innerHTML = '<p style="color: #ef4444;">Failed to load linked devices</p>';
                }
            } catch (error) {
                listDiv.innerHTML = '<p style="color: #ef4444;">Error loading linked devices</p>';
            }
        }

        async function linkDevice(childDeviceId, deviceType) {
            const linkType = deviceType === 'environmental' ? 'environmental' : 'valve_controller';

            try {
                const response = await fetch(`/user/devices/${currentLinkDeviceId}/links`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        child_device_id: childDeviceId,
                        link_type: linkType
                    })
                });

                if (response.ok) {
                    // Reload both lists
                    await loadAvailableLinks(currentLinkDeviceId);
                    await loadCurrentLinks(currentLinkDeviceId);
                    // Also refresh the main devices list to update the linked devices display
                    fetchDevices();
                } else {
                    const error = await response.json();
                    alert(`Failed to link device: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Error linking device');
            }
        }

        async function unlinkDevice(linkId) {
            if (!confirm('Are you sure you want to unlink this device?')) return;

            try {
                const response = await fetch(`/user/devices/${currentLinkDeviceId}/links/${linkId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Reload both lists
                    await loadAvailableLinks(currentLinkDeviceId);
                    await loadCurrentLinks(currentLinkDeviceId);
                    // Also refresh the main devices list to update the linked devices display
                    fetchDevices();
                } else {
                    const error = await response.json();
                    alert(`Failed to unlink device: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Error unlinking device');
            }
        }

        // Heartbeat Settings Functions (Admin Only)
        async function openHeartbeatModal(device_id) {
            if (!isAdmin) return;

            currentHeartbeatDeviceId = device_id;
            document.getElementById('heartbeat-device-name').textContent = `Device: ${device_id}`;
            document.getElementById('heartbeat-modal').style.display = 'block';
            document.getElementById('firmware-status').innerHTML = '<p style="margin: 0; color: #888; font-size: 0.9rem;">Loading firmware info...</p>';

            // Load current settings
            try {
                const response = await fetch(`/admin/devices/${device_id}/heartbeat-settings`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('heartbeat-use-fahrenheit').value = data.use_fahrenheit ? 'true' : 'false';
                    document.getElementById('heartbeat-update-interval').value = data.update_interval || 30;
                    document.getElementById('heartbeat-log-interval').value = data.log_interval || 3600;

                    // Update device name display if available
                    if (data.device_name) {
                        document.getElementById('heartbeat-device-name').textContent = `Device: ${data.device_name} (${device_id.substring(0, 8)}...)`;
                    }

                    // Load firmware info
                    loadFirmwareInfo(device_id);
                } else {
                    alert('Failed to load heartbeat settings');
                    closeHeartbeatModal();
                }
            } catch (error) {
                console.error('Error loading heartbeat settings:', error);
                alert('Error loading heartbeat settings');
                closeHeartbeatModal();
            }
        }

        async function loadFirmwareInfo(device_id) {
            const statusDiv = document.getElementById('firmware-status');

            try {
                // Get device's current firmware version from environment/latest
                const envResponse = await fetch(`/api/devices/${device_id}/environment/latest`);
                let currentVersion = 'Unknown';

                if (envResponse.ok) {
                    const envData = await envResponse.json();
                    currentVersion = envData.firmware_version || 'Unknown';
                }

                // Check for firmware updates
                const fwResponse = await fetch(`/api/firmware/check/${device_id}?current_version=${currentVersion}`);

                if (fwResponse.ok) {
                    const fwData = await fwResponse.json();

                    if (fwData.update_available) {
                        statusDiv.innerHTML = `
                            <p style="margin: 0 0 0.5rem 0; color: #fff;">
                                <strong>Current:</strong> v${fwData.current_version || 'Unknown'}
                            </p>
                            <p style="margin: 0 0 0.5rem 0; color: #10b981;">
                                <strong>Available:</strong> v${fwData.latest_version}
                                ${fwData.force_update ? '<span style="background: #f59e0b30; color: #f59e0b; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">FORCE PENDING</span>' : ''}
                            </p>
                            ${fwData.release_notes ? `<p style="margin: 0.5rem 0; color: #888; font-size: 0.85rem; max-height: 100px; overflow-y: auto; background: #0f172a; padding: 0.5rem; border-radius: 4px;">${fwData.release_notes.substring(0, 200)}${fwData.release_notes.length > 200 ? '...' : ''}</p>` : ''}
                            <button onclick="forceDeviceUpdate()" style="margin-top: 0.75rem; background: #3b82f6;">Force Update Now</button>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <p style="margin: 0; color: #10b981;">
                                Device is up to date (v${fwData.current_version || currentVersion})
                            </p>
                        `;
                    }
                } else {
                    statusDiv.innerHTML = `
                        <p style="margin: 0; color: #888;">
                            Current version: v${currentVersion}<br>
                            <span style="font-size: 0.85rem;">No firmware uploaded for this device type yet.</span>
                        </p>
                    `;
                }
            } catch (error) {
                console.error('Error loading firmware info:', error);
                statusDiv.innerHTML = `<p style="margin: 0; color: #ef4444;">Error loading firmware info</p>`;
            }
        }

        async function forceDeviceUpdate() {
            if (!currentHeartbeatDeviceId) return;

            if (!confirm('Force firmware update on next heartbeat? The device will restart during the update.')) {
                return;
            }

            try {
                const response = await fetch(`/admin/devices/${currentHeartbeatDeviceId}/force-firmware-update`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    loadFirmwareInfo(currentHeartbeatDeviceId);
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error forcing update:', error);
                alert('Error forcing update');
            }
        }

        function closeHeartbeatModal() {
            document.getElementById('heartbeat-modal').style.display = 'none';
            currentHeartbeatDeviceId = null;
        }

        async function saveHeartbeatSettings() {
            if (!currentHeartbeatDeviceId) return;

            const useFahrenheit = document.getElementById('heartbeat-use-fahrenheit').value === 'true';
            const updateInterval = parseInt(document.getElementById('heartbeat-update-interval').value);
            const logInterval = parseInt(document.getElementById('heartbeat-log-interval').value);

            // Validate inputs
            if (updateInterval < 5 || updateInterval > 3600) {
                alert('Heartbeat interval must be between 5 and 3600 seconds');
                return;
            }
            if (logInterval < 60 || logInterval > 86400) {
                alert('Logging interval must be between 60 and 86400 seconds');
                return;
            }

            try {
                const params = new URLSearchParams({
                    use_fahrenheit: useFahrenheit,
                    update_interval: updateInterval,
                    log_interval: logInterval
                });

                const response = await fetch(`/admin/devices/${currentHeartbeatDeviceId}/heartbeat-settings?${params}`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('Heartbeat settings saved! Changes will apply on the device\'s next heartbeat.');
                    closeHeartbeatModal();
                } else {
                    const error = await response.json();
                    alert(`Failed to save settings: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error saving heartbeat settings:', error);
                alert('Error saving heartbeat settings');
            }
        }

        async function saveDeviceEdit(event) {
            event.preventDefault();

            const name = document.getElementById('edit-name').value;
            const location_id = document.getElementById('edit-location').value;

            const payload = { name: name };
            if (location_id) {
                payload.location_id = parseInt(location_id);
            } else {
                payload.location_id = null;
            }

            const response = await fetch(`/user/devices/${currentEditDeviceId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                closeEditModal();
                fetchDevices(); // Reload devices list
                alert('Device updated successfully');
            } else {
                const error = await response.json();
                alert(`Failed to update device: ${error.detail || 'Unknown error'}`);
            }
        }

        // Delete device function
        async function deleteDevice(device_id) {
            if (confirm(`Are you sure you want to delete device ${device_id}?`)) {
                const response = await fetch(`/user/devices/${device_id}`, { method: 'DELETE' });
                if (response.ok) {
                    // Close WebSocket connection if exists
                    if (wsMap[device_id]) {
                        wsMap[device_id].close();
                        delete wsMap[device_id];
                    }

                    // Remove the device div from DOM instead of rebuilding entire list
                    const deviceElements = document.querySelectorAll('#devices-list > div');
                    for (let elem of deviceElements) {
                        if (elem.innerHTML.includes(device_id)) {
                            elem.remove();
                            break;
                        }
                    }

                    alert('Device deleted successfully');
                } else {
                    alert('Failed to delete device');
                }
            }
        }

        // Connect to WS for status updates
        function connectToDevice(device_id) {
            if (wsMap[device_id]) {
                console.log(`WebSocket already exists for ${device_id.substring(0,8)}`);
                return;
            }
            const wsUrl = `wss://${window.location.host}/ws/user/devices/${device_id}`;
            console.log(`Creating WebSocket connection to: ${wsUrl}`);
            const ws = new WebSocket(wsUrl);
            ws.onopen = () => {
                console.log(`‚úÖ WebSocket CONNECTED to ${device_id.substring(0,8)}`);
                // Version info is automatically included in full_sync from device
            };
            ws.onerror = (error) => {
                console.error(`‚ùå WebSocket ERROR for ${device_id.substring(0,8)}:`, error);
            };
            ws.onclose = (event) => {
                console.log(`WebSocket CLOSED for ${device_id.substring(0,8)}:`, event.code, event.reason);
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log(`Received from server for ${device_id}:`, data);
                console.log(`Message type: ${data.type}`);
                if (data.type === 'full_sync' || data.type === 'status_update') {
                    console.log(`Has data.data? ${!!data.data}`);
                    console.log(`Has data.data.settings? ${!!(data.data && data.data.settings)}`);
                    console.log(`Version in data: ${data.data?.settings?.current_version}`);
                }

                // Update system name from settings
                if (data.type === 'settings_update' && data.system_name) {
                    document.getElementById(`name-${device_id}`).textContent = data.system_name;
                    // Update in allDevices array for search
                    const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                    if (deviceIndex !== -1) {
                        allDevices[deviceIndex].name = data.system_name;
                    }
                }

                // Update version from full_sync, status_update, or sensors
                const settings = (data.type === 'sensors' && data.settings) ? data.settings :
                                 ((data.type === 'full_sync' || data.type === 'status_update') && data.data && data.data.settings) ? data.data.settings : null;

                // Check for firmware_version at top level (server WebSocket format)
                const version = settings?.current_version || data.firmware_version;

                console.log(`[WS ${device_id.substring(0,8)}] Type: ${data.type}, Version: ${version}`);

                if (version) {
                    console.log(`[WS ${device_id.substring(0,8)}] Setting version to: ${version}`);
                    document.getElementById(`version-${device_id}`).textContent = version;

                    // Update in allDevices array for search
                    const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                    if (deviceIndex !== -1) {
                        allDevices[deviceIndex].version = version;
                    }

                    // Check for firmware updates (for ESP32 devices)
                    const updateBadge = document.getElementById(`update-badge-${device_id}`);
                    if (updateBadge) {
                        checkForFirmwareUpdate(device_id, version, updateBadge);
                    }

                    // Check if this device was updating and clear the status message
                    if (localStorage.getItem(`updating_${device_id}`) === 'true') {
                        const updateBtn = document.getElementById(`update-btn-${device_id}`);
                        showDeviceStatus(device_id, 'Update completed successfully!', '#10b981');
                        setTimeout(() => {
                            showDeviceStatus(device_id, '', '#10b981');
                        }, 5000);
                        if (updateBtn) {
                            updateBtn.disabled = false;
                        }
                        localStorage.removeItem(`updating_${device_id}`);
                    }
                }
                if (settings && settings.system_name) {
                    document.getElementById(`name-${device_id}`).textContent = settings.system_name;
                    // Update in allDevices array for search
                    const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                    if (deviceIndex !== -1) {
                        allDevices[deviceIndex].name = settings.system_name;
                    }
                }

                // Update sensor values in allDevices array (for Sensor Config modal display)
                // Update for ALL message types that contain sensor data
                const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                if (deviceIndex !== -1) {
                    // Store sensor readings from top-level fields
                    if (data.pH !== undefined) allDevices[deviceIndex].pH = data.pH;
                    if (data.ec !== undefined) allDevices[deviceIndex].ec = data.ec;
                    if (data.water_temp !== undefined) allDevices[deviceIndex].water_temp = data.water_temp;
                    if (data.air_temp !== undefined) allDevices[deviceIndex].air_temp = data.air_temp;
                    if (data.water_level !== undefined) allDevices[deviceIndex].water_level = data.water_level;
                    // Store calibration offsets
                    if (data.water_temp_offset !== undefined) allDevices[deviceIndex].water_temp_offset = data.water_temp_offset;
                    if (data.air_temp_offset !== undefined) allDevices[deviceIndex].air_temp_offset = data.air_temp_offset;

                    // Also check in data.data for nested formats (some message types nest sensor data)
                    if (data.data) {
                        if (data.data.pH !== undefined) allDevices[deviceIndex].pH = data.data.pH;
                        if (data.data.ec !== undefined) allDevices[deviceIndex].ec = data.data.ec;
                        if (data.data.water_temp !== undefined) allDevices[deviceIndex].water_temp = data.data.water_temp;
                        if (data.data.air_temp !== undefined) allDevices[deviceIndex].air_temp = data.data.air_temp;
                        if (data.data.water_level !== undefined) allDevices[deviceIndex].water_level = data.data.water_level;
                        if (data.data.water_temp_offset !== undefined) allDevices[deviceIndex].water_temp_offset = data.data.water_temp_offset;
                        if (data.data.air_temp_offset !== undefined) allDevices[deviceIndex].air_temp_offset = data.data.air_temp_offset;
                    }
                }

                // Handle device status changes (online/offline)
                if (data.type === 'device_status') {
                    console.log(`[Status Update] Device ${device_id.substring(0,8)} is now ${data.online ? 'ONLINE' : 'OFFLINE'}`);

                    // Update status text
                    const onlineElem = document.getElementById(`online-${device_id}`);
                    if (onlineElem) {
                        onlineElem.textContent = data.online ? 'Online' : 'Offline';
                    }

                    // Update status dot
                    const dotElem = onlineElem?.parentElement.querySelector('.dot');
                    if (dotElem) {
                        dotElem.className = data.online ? 'dot online' : 'dot offline';
                    }

                    // Update in allDevices array for search
                    const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                    if (deviceIndex !== -1) {
                        allDevices[deviceIndex].is_online = data.online;
                    }
                }

                // Handle device name changes from device
                if (data.type === 'device_name_change') {
                    const nameElem = document.getElementById(`name-${device_id}`);
                    if (nameElem) {
                        nameElem.textContent = data.name;
                    }
                    // Update in allDevices array for search
                    const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                    if (deviceIndex !== -1) {
                        allDevices[deviceIndex].name = data.name;
                    }
                    console.log(`Device ${device_id} name updated to: ${data.name}`);
                }

                // Handle settings response
                if (data.type === 'settings' && data.settings) {
                    displayDeviceSettings(data.settings);
                }

                // Handle setting update confirmation
                if (data.type === 'setting_updated') {
                    if (data.success) {
                        console.log(`Setting ${data.key} updated successfully`);
                        // Optionally show a brief success indicator
                    } else {
                        alert(`Failed to update setting: ${data.message || 'Unknown error'}`);
                    }
                }

                // Valve status updates are handled on the dashboard page, not here
            };
            ws.onclose = () => {
                console.log(`Disconnected from ${device_id}`);
                const onlineElem = document.getElementById(`online-${device_id}`);
                if (onlineElem) {
                    onlineElem.textContent = 'No';
                }
                // Update in allDevices array for search
                const deviceIndex = allDevices.findIndex(d => d.device_id === device_id);
                if (deviceIndex !== -1) {
                    allDevices[deviceIndex].is_online = false;
                }
                delete wsMap[device_id];
            };
            wsMap[device_id] = ws;
        }

        // Update device software
        function updateDevice(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('This will update the software on the device. Continue?')) {
                return;
            }

            const updateBtn = document.getElementById(`update-btn-${device_id}`);

            showDeviceStatus(device_id, 'Sending update command...', '#f59e0b');
            if (updateBtn) updateBtn.disabled = true;

            // Send update command via WebSocket
            ws.send(JSON.stringify({
                command: 'update_software'
            }));

            // Show progress message
            setTimeout(() => {
                showDeviceStatus(device_id, 'Update in progress... The device will restart when complete.', '#f59e0b');
            }, 1000);

            // Re-enable button after 30 seconds
            setTimeout(() => {
                if (updateBtn) updateBtn.disabled = false;
                showDeviceStatus(device_id, 'Update command sent. Please wait for the device to restart.', '#10b981');
            }, 30000);

            // Mark that this device is updating so we can clear status when it reconnects
            localStorage.setItem(`updating_${device_id}`, 'true');
        }

        // Restart service
        function restartService(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('This will restart the garden service on the device. Continue?')) {
                return;
            }

            const restartBtn = document.getElementById(`restart-btn-${device_id}`);

            showDeviceStatus(device_id, 'Restarting service...', '#f59e0b');
            if (restartBtn) restartBtn.disabled = true;

            // Send restart command via WebSocket
            ws.send(JSON.stringify({
                command: 'restart_service'
            }));

            // Re-enable button after 10 seconds
            setTimeout(() => {
                if (restartBtn) restartBtn.disabled = false;
                showDeviceStatus(device_id, 'Service restart command sent.', '#10b981');
                setTimeout(() => {
                    showDeviceStatus(device_id, '', '#10b981');
                }, 3000);
            }, 10000);
        }

        // Reboot system
        function rebootSystem(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('WARNING: This will reboot the entire Raspberry Pi system. Continue?')) {
                return;
            }

            const rebootBtn = document.getElementById(`reboot-btn-${device_id}`);

            showDeviceStatus(device_id, 'Rebooting system...', '#dc2626');
            if (rebootBtn) rebootBtn.disabled = true;

            // Send reboot command via WebSocket
            ws.send(JSON.stringify({
                command: 'reboot_system'
            }));

            // Re-enable button after 60 seconds (system reboot takes longer)
            setTimeout(() => {
                if (rebootBtn) rebootBtn.disabled = false;
                showDeviceStatus(device_id, 'System reboot command sent. Device will be offline briefly.', '#10b981');
                setTimeout(() => {
                    showDeviceStatus(device_id, '', '#10b981');
                }, 5000);
            }, 60000);
        }

        // Update environmental sensor firmware (triggers via heartbeat)
        async function updateEnvironmentalFirmware(device_id) {
            if (!confirm('This will trigger a firmware update on the next heartbeat. The device will restart during the update. Continue?')) {
                return;
            }

            const updateBtn = document.getElementById(`update-btn-${device_id}`);

            showDeviceStatus(device_id, 'Sending update command...', '#f59e0b');
            if (updateBtn) updateBtn.disabled = true;

            try {
                const response = await fetch(`/admin/devices/${device_id}/force-firmware-update`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    showDeviceStatus(device_id, 'Update queued! Device will update on next heartbeat.', '#10b981');
                } else {
                    const error = await response.json();
                    showDeviceStatus(device_id, `Error: ${error.detail || 'Failed to queue update'}`, '#ef4444');
                }
            } catch (error) {
                showDeviceStatus(device_id, 'Error sending update command', '#ef4444');
            }

            // Re-enable button after 5 seconds
            setTimeout(() => {
                if (updateBtn) updateBtn.disabled = false;
            }, 5000);
        }

        // Reboot environmental sensor (triggers via heartbeat)
        async function rebootEnvironmentalDevice(device_id) {
            if (!confirm('This will reboot the environmental sensor on its next heartbeat. Continue?')) {
                return;
            }

            const rebootBtn = document.getElementById(`reboot-btn-${device_id}`);

            showDeviceStatus(device_id, 'Sending reboot command...', '#dc2626');
            if (rebootBtn) rebootBtn.disabled = true;

            try {
                const response = await fetch(`/admin/devices/${device_id}/reboot`, {
                    method: 'PUT'
                });

                if (response.ok) {
                    showDeviceStatus(device_id, 'Reboot queued! Device will restart on next heartbeat.', '#10b981');
                } else {
                    const error = await response.json();
                    showDeviceStatus(device_id, `Error: ${error.detail || 'Failed to queue reboot'}`, '#ef4444');
                }
            } catch (error) {
                showDeviceStatus(device_id, 'Error sending reboot command', '#ef4444');
            }

            // Re-enable button after 5 seconds
            setTimeout(() => {
                if (rebootBtn) rebootBtn.disabled = false;
            }, 5000);
        }

        // Update valve controller firmware via WebSocket command
        function updateValveControllerFirmware(device_id) {
            const ws = wsMap[device_id];
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Device is not connected. Please wait for the device to come online.');
                return;
            }

            if (!confirm('This will trigger a firmware update on the valve controller. The device will restart during the update. Continue?')) {
                return;
            }

            showDeviceStatus(device_id, 'Sending update command...', '#f59e0b');

            // Send firmware update command via WebSocket
            ws.send(JSON.stringify({
                type: 'firmware_update'
            }));

            showDeviceStatus(device_id, 'Update command sent! Device will check for updates and restart if available.', '#10b981');
        }

        // Reboot valve controller via WebSocket command
        function rebootValveController(device_id) {
            const ws = wsMap[device_id];
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Device is not connected. Please wait for the device to come online.');
                return;
            }

            if (!confirm('This will reboot the valve controller. Continue?')) {
                return;
            }

            showDeviceStatus(device_id, 'Sending reboot command...', '#dc2626');

            // Send reboot command via WebSocket
            ws.send(JSON.stringify({
                type: 'reboot'
            }));

            showDeviceStatus(device_id, 'Reboot command sent! Device will restart shortly.', '#10b981');
        }

        // Update hydroponic controller firmware via WebSocket command
        function updateHydroponicControllerFirmware(device_id) {
            const ws = wsMap[device_id];
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Device is not connected. Please wait for the device to come online.');
                return;
            }

            if (!confirm('This will trigger a firmware update on the hydroponic controller. The device will restart during the update. Continue?')) {
                return;
            }

            showDeviceStatus(device_id, 'Sending update command...', '#f59e0b');

            // Send firmware update command via WebSocket
            ws.send(JSON.stringify({
                type: 'firmware_update'
            }));

            showDeviceStatus(device_id, 'Update command sent! Device will check for updates and restart if available.', '#10b981');
        }

        // Reboot hydroponic controller via WebSocket command
        function rebootHydroponicController(device_id) {
            const ws = wsMap[device_id];
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Device is not connected. Please wait for the device to come online.');
                return;
            }

            if (!confirm('This will reboot the hydroponic controller. Continue?')) {
                return;
            }

            showDeviceStatus(device_id, 'Sending reboot command...', '#dc2626');

            // Send reboot command via WebSocket
            ws.send(JSON.stringify({
                type: 'reboot'
            }));

            showDeviceStatus(device_id, 'Reboot command sent! Device will restart shortly.', '#10b981');
        }

        // Accept share code form submit
        document.getElementById('add-device-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const share_code = document.getElementById('share_code').value.trim();
            const resultDiv = document.getElementById('add-result');

            if (!share_code) {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Please enter a share code</p>`;
                return;
            }

            const response = await fetch('/user/devices/accept-share', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ share_code: share_code })
            });

            if (response.ok) {
                const data = await response.json();
                resultDiv.innerHTML = `<p style="color: #10b981;">‚úì Device share accepted successfully! Device ID: ${data.device_id}</p>`;
                document.getElementById('share_code').value = '';
                fetchDevices();  // Reload list
            } else {
                const error = await response.json();
                resultDiv.innerHTML = `<p style="color: #ef4444;">Error: ${error.detail}</p>`;
            }
        });

        // Load devices on page load
        window.onload = function() {
            fetchDevices();
        };

        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('active');
        }
    </script>
    </div>
</body>
</html>