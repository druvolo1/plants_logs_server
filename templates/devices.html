<!-- templates/devices.html - Device management page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Devices</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>Manage Devices for {{ user.email }}</h1>
    <a href="/auth/logout">Logout</a>
    <a href="/dashboard">Back to Dashboard</a>

    <!-- Add Device form -->
    <h2>Add Device</h2>
    <form id="add-device-form">
        <label for="device_id">Device ID (from Pi):</label>
        <input type="text" id="device_id" required>
        <br>
        <label for="name">Device Name (optional):</label>
        <input type="text" id="name">
        <br>
        <button type="submit">Add Device</button>
    </form>
    <div id="add-result"></div>

    <!-- Devices list with Connect buttons -->
    <h2>My Devices</h2>
    <div id="devices-list"></div>

    <script>
        // Fetch and display devices list with Connect and Delete buttons
        async function fetchDevices() {
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const listDiv = document.getElementById('devices-list');
                listDiv.innerHTML = '';
                devices.forEach(device => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.innerHTML = `
                        <p>${device.name || device.device_id} - Online: ${device.is_online ? 'Yes' : 'No'}</p>
                        <button onclick="connectToDevice('${device.device_id}')">Connect</button>
                        <button onclick="deleteDevice('${device.device_id}')">Delete</button>
                        <div id="control-${device.device_id}" style="display:none;">
                            <h3>Controls (Test)</h3>
                            <p>pH: <span id="ph-${device.device_id}">Loading...</span></p>
                            <button onclick="sendDose('${device.device_id}', 'up', 10)">Dose pH Up (10ml)</button>
                            <button onclick="sendDose('${device.device_id}', 'down', 10)">Dose pH Down (10ml)</button>
                        </div>
                    `;
                    listDiv.appendChild(deviceDiv);
                });
            }
        }

        // Delete device function
        async function deleteDevice(device_id) {
            if (confirm(`Are you sure you want to delete device ${device_id}?`)) {
                const response = await fetch(`/user/devices/${device_id}`, { method: 'DELETE' });
                if (response.ok) {
                    alert('Device deleted successfully');
                    fetchDevices();  // Reload list
                } else {
                    alert('Failed to delete device');
                }
            }
        }

        // Connect to WS for a device (for testing on this page)
        let wsMap = {};  // Store WS per device_id
        function connectToDevice(device_id) {
            if (wsMap[device_id]) return;
            const ws = new WebSocket(`wss://${window.location.host}/ws/user/devices/${device_id}`);
            ws.onopen = () => {
                console.log(`Connected to ${device_id}`);
                document.getElementById(`control-${device_id}`).style.display = 'block';
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log(`Received from server for ${device_id}:`, data);
                if (data.type === 'ph_update') {
                    document.getElementById(`ph-${device_id}`).innerHTML = data.ph;
                }
            };
            ws.onclose = () => {
                console.log(`Disconnected from ${device_id}`);
                delete wsMap[device_id];
            };
            wsMap[device_id] = ws;
        }

        // Send dose command
        function sendDose(device_id, dispense_type, amount) {
            const ws = wsMap[device_id];
            if (ws) {
                ws.send(JSON.stringify({
                    command: 'manual_dose',
                    params: { dispense_type: dispense_type, amount: amount }
                }));
            }
        }

        // Add form submit
        document.getElementById('add-device-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const device_id = document.getElementById('device_id').value;
            const name = document.getElementById('name').value;
            const response = await fetch('/user/devices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_id: device_id, name: name })
            });
            const resultDiv = document.getElementById('add-result');
            if (response.ok) {
                const data = await response.json();
                resultDiv.innerHTML = `Device added! API Key: ${data.api_key} (copy to Pi settings.json as "api_key")`;
                fetchDevices();  // Reload list
            } else {
                const error = await response.json();
                resultDiv.innerHTML = `Error: ${error.detail}`;
            }
        });

        // Load devices on page load
        window.onload = fetchDevices;

        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };
    </script>
</body>
</html>