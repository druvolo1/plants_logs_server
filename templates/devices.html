<!-- templates/devices.html - Device management page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Devices</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Modern Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #10b981;
        }
        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
            text-decoration: none;
        }
        .navbar-brand:hover {
            color: #34d399;
        }
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar-link {
            padding: 1rem 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .navbar-link:hover {
            background: rgba(16, 185, 129, 0.1);
            border-bottom-color: #10b981;
        }
        .navbar-link.active {
            background: rgba(16, 185, 129, 0.15);
            border-bottom-color: #10b981;
            color: #10b981;
        }
        .navbar-user {
            padding: 1rem 1.25rem;
            color: rgba(148, 163, 184, 0.9);
            font-size: 0.9rem;
            border-left: 1px solid rgba(148, 163, 184, 0.2);
        }
        .navbar-logout {
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .navbar-logout:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        /* Hamburger menu button (hidden on desktop) */
        .navbar-toggle {
            display: none;
            background: none;
            border: none;
            color: #10b981;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Mobile Navigation */
        @media (max-width: 768px) {
            .navbar-container {
                padding: 0 1rem;
            }

            .navbar-toggle {
                display: block;
            }

            .navbar-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: #0f172a;
                flex-direction: column;
                gap: 0;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            }

            .navbar-menu.active {
                display: flex;
            }

            .navbar-link {
                width: 100%;
                text-align: left;
                border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            }

            .navbar-user {
                width: 100%;
                border-left: none;
                border-bottom: 1px solid rgba(148, 163, 184, 0.2);
            }

            .navbar-logout {
                margin: 0.5rem 1rem;
                width: calc(100% - 2rem);
                text-align: center;
            }
        }

        /* Tablet adjustments */
        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 1rem;
            }

            .navbar-link, .navbar-user {
                font-size: 0.85rem;
                padding: 0.75rem 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard" class="navbar-brand">
                ðŸŒ± Plant Monitor
            </a>
            <button class="navbar-toggle" onclick="toggleMobileMenu()" aria-label="Toggle menu">â˜°</button>
            <div class="navbar-menu" id="navbar-menu">
                <a href="/dashboard" class="navbar-link">Dashboard</a>
                <a href="/devices" class="navbar-link active">Devices</a>
                <a href="/plants" class="navbar-link">Plants</a>
                {% if user.is_superuser %}
                <a href="/admin/users" class="navbar-link">Users</a>
                {% endif %}
                <span class="navbar-user">{{ user.email }}</span>
                <a href="/auth/logout" class="navbar-logout">Logout</a>
            </div>
        </div>
    </nav>

    <div style="padding: 2rem 1.5rem; max-width: 1400px; margin: 0 auto;">
    <h2 style="color: #10b981; margin-bottom: 1.5rem;">Manage Devices</h2>

    <!-- Add Device form -->
    <h3>Add Device</h3>
    <form id="add-device-form">
        <label for="device_id">Device ID (from Pi):</label>
        <input type="text" id="device_id">
        <br>
        <label for="name">Device Name (optional):</label>
        <input type="text" id="name">
        <br>
        <label style="margin-top: 1rem; display: block; font-weight: normal; color: #888;">OR accept shared device:</label>
        <label for="share_code">Share Code:</label>
        <input type="text" id="share_code" placeholder="Enter 10-character code">
        <br>
        <button type="submit">Add Device / Accept Share</button>
    </form>
    <div id="add-result"></div>

    <!-- Devices list -->
    <h3>My Devices</h3>
    <div id="devices-list"></div>

    <!-- Share Management Modal -->
    <div id="share-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000;">
        <div style="position: relative; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h3 style="color: #10b981; margin-top: 0;">Manage Device Sharing</h3>
            <p style="color: #888; font-size: 0.9rem;" id="share-device-name"></p>

            <!-- Create New Share -->
            <div style="margin: 1.5rem 0; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid #10b981;">
                <h4 style="margin-top: 0; color: #10b981;">Create New Share Link</h4>
                <label for="permission-select">Permission Level:</label>
                <select id="permission-select" style="margin-left: 0.5rem; padding: 0.5rem; border-radius: 4px;">
                    <option value="viewer">View Only</option>
                    <option value="controller">Can Control</option>
                </select>
                <button onclick="createShare()" style="margin-left: 1rem;">Generate Share Code</button>
                <div id="share-code-result" style="margin-top: 1rem;"></div>
            </div>

            <!-- Active Shares List -->
            <div style="margin: 1.5rem 0;">
                <h4 style="color: #10b981;">Active Shares</h4>
                <div id="shares-list" style="margin-top: 1rem;"></div>
            </div>

            <button onclick="closeShareModal()" style="background: #64748b; margin-top: 1rem;">Close</button>
        </div>
    </div>

    <script>
        // Store WebSocket connections per device
        let wsMap = {};
        let currentShareDeviceId = null;

        // Fetch and display devices list with Update and Delete buttons
        async function fetchDevices() {
            const response = await fetch('/user/devices');
            if (response.ok) {
                const devices = await response.json();
                const listDiv = document.getElementById('devices-list');
                listDiv.innerHTML = '';

                // Separate devices into In Use and Available
                const inUseDevices = devices.filter(d => d.active_plant_name);
                const availableDevices = devices.filter(d => !d.active_plant_name);

                // Render In Use section
                if (inUseDevices.length > 0) {
                    const inUseHeader = document.createElement('h4');
                    inUseHeader.textContent = 'In Use';
                    inUseHeader.style.color = '#10b981';
                    inUseHeader.style.marginTop = '1.5rem';
                    inUseHeader.style.marginBottom = '1rem';
                    listDiv.appendChild(inUseHeader);

                    inUseDevices.forEach(device => {
                        listDiv.appendChild(createDeviceCard(device));
                    });
                }

                // Render Available section
                if (availableDevices.length > 0) {
                    const availableHeader = document.createElement('h4');
                    availableHeader.textContent = 'Available';
                    availableHeader.style.color = '#64748b';
                    availableHeader.style.marginTop = '2rem';
                    availableHeader.style.marginBottom = '1rem';
                    listDiv.appendChild(availableHeader);

                    availableDevices.forEach(device => {
                        listDiv.appendChild(createDeviceCard(device));
                    });
                }

                if (devices.length === 0) {
                    listDiv.innerHTML = '<p style="color: #888;">No devices found</p>';
                }
            }
        }

        function createDeviceCard(device) {
            const deviceDiv = document.createElement('div');
            deviceDiv.style.marginBottom = '1.5rem';
            deviceDiv.style.padding = '1rem';
            deviceDiv.style.border = device.active_plant_name ? '2px solid #10b981' : '1px solid #ccc';
            deviceDiv.style.borderRadius = '8px';
            deviceDiv.style.background = device.active_plant_name ? 'rgba(16, 185, 129, 0.05)' : 'transparent';

            // Show ownership info
            const ownershipInfo = device.is_owner
                ? '<p style="color: #10b981; font-size: 0.9rem;">âœ“ You own this device</p>'
                : `<p style="color: #f59e0b; font-size: 0.9rem;">ðŸ”— Shared by ${device.shared_by_email} (${device.permission_level})</p>`;

            // Show active plant info if in use
            const plantInfo = device.active_plant_name
                ? `<p style="color: #10b981; font-weight: bold; font-size: 1rem; margin: 0.5rem 0;">ðŸŒ± Monitoring: ${device.active_plant_name} (${device.active_phase})</p>`
                : '';

            // Only owners can share and delete
            const shareButton = device.is_owner
                ? `<button onclick="openShareModal('${device.device_id}')" style="background: #8b5cf6;">Share</button>`
                : '';

            const deleteButton = device.is_owner
                ? `<button onclick="deleteDevice('${device.device_id}')">Delete</button>`
                : '';

            deviceDiv.innerHTML = `
                ${ownershipInfo}
                ${plantInfo}
                <p><strong>System Name:</strong> <span id="name-${device.device_id}">${device.name || 'Loading...'}</span></p>
                <p><strong>Device ID:</strong> ${device.device_id}</p>
                <p><strong>Version:</strong> <span id="version-${device.device_id}">Loading...</span></p>
                <p><strong>Online:</strong> <span id="online-${device.device_id}">${device.is_online ? 'Yes' : 'No'}</span></p>
                <button onclick="updateDevice('${device.device_id}')" id="update-btn-${device.device_id}">Update Software</button>
                <button onclick="restartService('${device.device_id}')" id="restart-btn-${device.device_id}">Restart Service</button>
                <button onclick="rebootSystem('${device.device_id}')" id="reboot-btn-${device.device_id}" style="background: #dc2626;">Reboot System</button>
                ${shareButton}
                ${deleteButton}
                <div id="update-status-${device.device_id}" style="margin-top: 0.5rem; color: #10b981;"></div>
            `;

            // Auto-connect to WebSocket for status updates
            if (device.is_online) {
                connectToDevice(device.device_id);
            }

            return deviceDiv;
        }

        // Share Management Functions
        function openShareModal(device_id) {
            currentShareDeviceId = device_id;
            document.getElementById('share-device-name').textContent = `Device: ${device_id}`;
            document.getElementById('share-modal').style.display = 'block';
            loadShares(device_id);
        }

        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
            document.getElementById('share-code-result').innerHTML = '';
            document.getElementById('shares-list').innerHTML = '';
            currentShareDeviceId = null;
        }

        async function createShare() {
            const permission = document.getElementById('permission-select').value;
            const response = await fetch(`/user/devices/${currentShareDeviceId}/share`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ permission_level: permission })
            });

            const resultDiv = document.getElementById('share-code-result');
            if (response.ok) {
                const data = await response.json();
                resultDiv.innerHTML = `
                    <div style="background: rgba(16, 185, 129, 0.2); padding: 1rem; border-radius: 6px; margin-top: 0.5rem;">
                        <p style="margin: 0; color: #10b981; font-weight: bold;">Share Code Generated!</p>
                        <p style="margin: 0.5rem 0; font-size: 1.2rem; font-family: monospace; color: #fff;">${data.share_code}</p>
                        <p style="margin: 0; font-size: 0.85rem; color: #888;">Expires: ${new Date(data.expires_at).toLocaleString()}</p>
                        <button onclick="navigator.clipboard.writeText('${data.share_code}')" style="margin-top: 0.5rem; font-size: 0.85rem;">Copy Code</button>
                    </div>
                `;
                // Reload shares list
                loadShares(currentShareDeviceId);
            } else {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Failed to create share</p>`;
            }
        }

        async function loadShares(device_id) {
            const response = await fetch(`/user/devices/${device_id}/shares`);
            if (response.ok) {
                const shares = await response.json();
                const sharesDiv = document.getElementById('shares-list');

                if (shares.length === 0) {
                    sharesDiv.innerHTML = '<p style="color: #888;">No active shares</p>';
                    return;
                }

                sharesDiv.innerHTML = '';
                shares.forEach(share => {
                    const shareDiv = document.createElement('div');
                    shareDiv.style.padding = '1rem';
                    shareDiv.style.marginBottom = '0.5rem';
                    shareDiv.style.background = 'rgba(100, 116, 139, 0.2)';
                    shareDiv.style.borderRadius = '6px';

                    const statusText = share.accepted_at
                        ? `Accepted by ${share.shared_with_email}`
                        : `Pending (Code: ${share.share_code})`;

                    const expiryText = new Date(share.expires_at) > new Date()
                        ? `Expires: ${new Date(share.expires_at).toLocaleString()}`
                        : '<span style="color: #ef4444;">Expired</span>';

                    shareDiv.innerHTML = `
                        <p style="margin: 0 0 0.5rem 0;"><strong>${statusText}</strong></p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">Permission: ${share.permission_level}</p>
                        <p style="margin: 0; font-size: 0.9rem; color: #888;">${expiryText}</p>
                        ${share.accepted_at ? `
                            <select id="perm-${share.id}" style="margin-top: 0.5rem; margin-right: 0.5rem;">
                                <option value="viewer" ${share.permission_level === 'viewer' ? 'selected' : ''}>View Only</option>
                                <option value="controller" ${share.permission_level === 'controller' ? 'selected' : ''}>Can Control</option>
                            </select>
                            <button onclick="updatePermission(${share.id})" style="font-size: 0.85rem;">Update</button>
                        ` : ''}
                        <button onclick="revokeShare(${share.id})" style="background: #dc2626; font-size: 0.85rem; margin-top: 0.5rem;">Revoke</button>
                    `;
                    sharesDiv.appendChild(shareDiv);
                });
            }
        }

        async function revokeShare(share_id) {
            if (!confirm('Are you sure you want to revoke this share?')) return;

            const response = await fetch(`/user/devices/shares/${share_id}`, { method: 'DELETE' });
            if (response.ok) {
                loadShares(currentShareDeviceId);
                alert('Share revoked successfully');
            } else {
                alert('Failed to revoke share');
            }
        }

        async function updatePermission(share_id) {
            const permission = document.getElementById(`perm-${share_id}`).value;
            const response = await fetch(`/user/devices/shares/${share_id}/permission`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ permission_level: permission })
            });

            if (response.ok) {
                alert('Permission updated successfully');
                loadShares(currentShareDeviceId);
            } else {
                alert('Failed to update permission');
            }
        }

        // Delete device function
        async function deleteDevice(device_id) {
            if (confirm(`Are you sure you want to delete device ${device_id}?`)) {
                const response = await fetch(`/user/devices/${device_id}`, { method: 'DELETE' });
                if (response.ok) {
                    // Close WebSocket connection if exists
                    if (wsMap[device_id]) {
                        wsMap[device_id].close();
                        delete wsMap[device_id];
                    }

                    // Remove the device div from DOM instead of rebuilding entire list
                    const deviceElements = document.querySelectorAll('#devices-list > div');
                    for (let elem of deviceElements) {
                        if (elem.innerHTML.includes(device_id)) {
                            elem.remove();
                            break;
                        }
                    }

                    alert('Device deleted successfully');
                } else {
                    alert('Failed to delete device');
                }
            }
        }

        // Connect to WS for status updates
        function connectToDevice(device_id) {
            if (wsMap[device_id]) return;
            const ws = new WebSocket(`wss://${window.location.host}/ws/user/devices/${device_id}`);
            ws.onopen = () => {
                console.log(`Connected to ${device_id}`);
                // Version info is automatically included in full_sync from device
            };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log(`Received from server for ${device_id}:`, data);
                console.log(`Message type: ${data.type}`);
                if (data.type === 'full_sync' || data.type === 'status_update') {
                    console.log(`Has data.data? ${!!data.data}`);
                    console.log(`Has data.data.settings? ${!!(data.data && data.data.settings)}`);
                    console.log(`Version in data: ${data.data?.settings?.current_version}`);
                }

                // Update system name from settings
                if (data.type === 'settings_update' && data.system_name) {
                    document.getElementById(`name-${device_id}`).textContent = data.system_name;
                }

                // Update version from full_sync or status_update
                if ((data.type === 'full_sync' || data.type === 'status_update') && data.data && data.data.settings) {
                    if (data.data.settings.current_version) {
                        document.getElementById(`version-${device_id}`).textContent = data.data.settings.current_version;

                        // Check if this device was updating and clear the status message
                        if (localStorage.getItem(`updating_${device_id}`) === 'true') {
                            const statusDiv = document.getElementById(`update-status-${device_id}`);
                            const updateBtn = document.getElementById(`update-btn-${device_id}`);
                            if (statusDiv) {
                                statusDiv.textContent = 'Update completed successfully!';
                                statusDiv.style.color = '#10b981';
                                setTimeout(() => {
                                    statusDiv.textContent = '';
                                }, 5000);
                            }
                            if (updateBtn) {
                                updateBtn.disabled = false;
                            }
                            localStorage.removeItem(`updating_${device_id}`);
                        }
                    }
                    if (data.data.settings.system_name) {
                        document.getElementById(`name-${device_id}`).textContent = data.data.settings.system_name;
                    }
                }

                // Handle device status changes (online/offline)
                if (data.type === 'device_status') {
                    const onlineElem = document.getElementById(`online-${device_id}`);
                    if (onlineElem) {
                        onlineElem.textContent = data.online ? 'Yes' : 'No';
                    }
                }
            };
            ws.onclose = () => {
                console.log(`Disconnected from ${device_id}`);
                const onlineElem = document.getElementById(`online-${device_id}`);
                if (onlineElem) {
                    onlineElem.textContent = 'No';
                }
                delete wsMap[device_id];
            };
            wsMap[device_id] = ws;
        }

        // Update device software
        function updateDevice(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('This will update the software on the device. Continue?')) {
                return;
            }

            const statusDiv = document.getElementById(`update-status-${device_id}`);
            const updateBtn = document.getElementById(`update-btn-${device_id}`);

            statusDiv.textContent = 'Sending update command...';
            updateBtn.disabled = true;

            // Send update command via WebSocket
            ws.send(JSON.stringify({
                command: 'update_software'
            }));

            // Show progress message
            setTimeout(() => {
                statusDiv.textContent = 'Update in progress... The device will restart when complete.';
            }, 1000);

            // Re-enable button after 30 seconds
            setTimeout(() => {
                updateBtn.disabled = false;
                statusDiv.textContent = 'Update command sent. Please wait for the device to restart.';
            }, 30000);

            // Mark that this device is updating so we can clear status when it reconnects
            localStorage.setItem(`updating_${device_id}`, 'true');
        }

        // Restart service
        function restartService(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('This will restart the garden service on the device. Continue?')) {
                return;
            }

            const statusDiv = document.getElementById(`update-status-${device_id}`);
            const restartBtn = document.getElementById(`restart-btn-${device_id}`);

            statusDiv.textContent = 'Restarting service...';
            statusDiv.style.color = '#f59e0b';
            restartBtn.disabled = true;

            // Send restart command via WebSocket
            ws.send(JSON.stringify({
                command: 'restart_service'
            }));

            // Re-enable button after 10 seconds
            setTimeout(() => {
                restartBtn.disabled = false;
                statusDiv.textContent = 'Service restart command sent.';
                statusDiv.style.color = '#10b981';
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 3000);
            }, 10000);
        }

        // Reboot system
        function rebootSystem(device_id) {
            const ws = wsMap[device_id];
            if (!ws) {
                alert('Device is not connected');
                return;
            }

            if (!confirm('WARNING: This will reboot the entire Raspberry Pi system. Continue?')) {
                return;
            }

            const statusDiv = document.getElementById(`update-status-${device_id}`);
            const rebootBtn = document.getElementById(`reboot-btn-${device_id}`);

            statusDiv.textContent = 'Rebooting system...';
            statusDiv.style.color = '#dc2626';
            rebootBtn.disabled = true;

            // Send reboot command via WebSocket
            ws.send(JSON.stringify({
                command: 'reboot_system'
            }));

            // Re-enable button after 60 seconds (system reboot takes longer)
            setTimeout(() => {
                rebootBtn.disabled = false;
                statusDiv.textContent = 'System reboot command sent. Device will be offline briefly.';
                statusDiv.style.color = '#10b981';
                setTimeout(() => {
                    statusDiv.textContent = '';
                }, 5000);
            }, 60000);
        }

        // Add form submit - handle both device adding and share code acceptance
        document.getElementById('add-device-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const device_id = document.getElementById('device_id').value.trim();
            const name = document.getElementById('name').value.trim();
            const share_code = document.getElementById('share_code').value.trim();
            const resultDiv = document.getElementById('add-result');

            // If share code is provided, accept share
            if (share_code) {
                const response = await fetch('/user/devices/accept-share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ share_code: share_code })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<p style="color: #10b981;">âœ“ Device share accepted successfully! Device ID: ${data.device_id}</p>`;
                    document.getElementById('share_code').value = '';
                    fetchDevices();  // Reload list
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<p style="color: #ef4444;">Error: ${error.detail}</p>`;
                }
            }
            // Otherwise, add new device
            else if (device_id) {
                const response = await fetch('/user/devices', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: device_id, name: name })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<p style="color: #10b981;">Device added! API Key: <strong>${data.api_key}</strong> (copy to Pi settings.json as "api_key")</p>`;
                    document.getElementById('device_id').value = '';
                    document.getElementById('name').value = '';
                    fetchDevices();  // Reload list
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<p style="color: #ef4444;">Error: ${error.detail}</p>`;
                }
            } else {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Please enter either a Device ID or a Share Code</p>`;
            }
        });

        // Load devices on page load
        window.onload = fetchDevices;

        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('navbar-menu');
            menu.classList.toggle('active');
        }
    </script>
    </div>
</body>
</html>