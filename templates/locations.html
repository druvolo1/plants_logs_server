<!-- templates/locations.html - Location management page with tree view -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locations</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Modern Navigation Bar */
        .navbar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #10b981;
        }
        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
        }
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
            text-decoration: none;
        }
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        .navbar-link {
            padding: 1rem 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .navbar-link:hover {
            background: rgba(16, 185, 129, 0.1);
            border-bottom-color: #10b981;
        }
        .navbar-link.active {
            background: rgba(16, 185, 129, 0.15);
            border-bottom-color: #10b981;
            color: #10b981;
        }
        .navbar-user {
            padding: 1rem 1.25rem;
            color: rgba(148, 163, 184, 0.9);
            font-size: 0.9rem;
            border-left: 1px solid rgba(148, 163, 184, 0.2);
        }
        .navbar-logout {
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .navbar-logout:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            background: #0f172a;
        }

        /* Tree Sidebar */
        .tree-sidebar {
            width: 320px;
            min-width: 280px;
            background: #1e293b;
            border-right: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: #334155;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 1.1rem;
        }

        .icon-btn:hover {
            background: #10b981;
            color: white;
        }

        .tree-container {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        /* Tree Node Styles */
        .tree-node {
            user-select: none;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            margin: 1px 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            color: #cbd5e1;
            gap: 0.5rem;
        }

        .tree-node-content:hover {
            background: #334155;
        }

        .tree-node-content.selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .tree-node-content.shared {
            border-left: 3px solid #f59e0b;
            margin-left: calc(0.5rem - 3px);
        }

        .tree-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #64748b;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .tree-toggle.expanded {
            transform: rotate(90deg);
        }

        .tree-toggle.empty {
            visibility: hidden;
        }

        .tree-icon {
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .tree-label {
            flex: 1;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tree-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: #334155;
            color: #94a3b8;
        }

        .tree-node-content.selected .tree-badge {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .tree-children {
            margin-left: 1.25rem;
            border-left: 1px dashed #334155;
            margin-left: 1.5rem;
        }

        /* Detail Panel */
        .detail-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .detail-header {
            padding: 1.5rem 2rem;
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }

        .detail-header h1 {
            margin: 0 0 0.25rem 0;
            font-size: 1.5rem;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .detail-header .breadcrumb {
            font-size: 0.85rem;
            color: #64748b;
        }

        .detail-header .breadcrumb span {
            color: #94a3b8;
        }

        .detail-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem 2rem;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
            text-align: center;
            padding: 2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h2 {
            margin: 0 0 0.5rem 0;
            color: #94a3b8;
            font-size: 1.25rem;
        }

        .empty-state p {
            margin: 0 0 1.5rem 0;
            max-width: 300px;
        }

        /* Section Boxes */
        .section-box {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .section-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-body {
            padding: 1rem 1.25rem;
        }

        /* Device Grid */
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .device-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .device-card:hover {
            border-color: #10b981;
            transform: translateY(-2px);
        }

        .device-card.device-online {
            border-left: 3px solid #10b981;
        }

        .device-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .device-name {
            font-weight: 600;
            color: #f1f5f9;
            font-size: 1.05rem;
        }

        .device-status {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.8rem;
        }

        .device-status.online {
            color: #10b981;
        }

        .device-status.offline {
            color: #64748b;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .device-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .device-info-item {
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .device-info-label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .device-info-value {
            font-size: 0.85rem;
            color: #cbd5e1;
        }

        .device-id {
            font-family: monospace;
            background: #334155;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            word-break: break-all;
        }

        .device-plants {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            padding-top: 0.5rem;
            border-top: 1px solid #334155;
        }

        .plant-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .plant-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.5rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #cbd5e1;
        }

        .phase-badge {
            font-size: 0.65rem;
            padding: 1px 4px;
            background: #10b98130;
            color: #10b981;
            border-radius: 3px;
            text-transform: capitalize;
        }

        .device-shared-badge {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #f59e0b15;
            border: 1px solid #f59e0b40;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #f59e0b;
        }

        .permission-badge {
            padding: 2px 6px;
            background: #f59e0b30;
            border-radius: 3px;
            font-size: 0.7rem;
            text-transform: capitalize;
        }

        .device-card-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 0.5rem;
        }

        .device-meta {
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Child Locations */
        .child-locations {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .child-location-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
        }

        .child-location-chip:hover {
            border-color: #10b981;
            color: #10b981;
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .info-item {
            padding: 0.75rem;
            background: #0f172a;
            border-radius: 6px;
        }

        .info-label {
            font-size: 0.75rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 1rem;
            color: #e2e8f0;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex !important;
        }

        #location-modal .modal {
            background: #1e293b !important;
            border: 2px solid #10b981 !important;
            border-radius: 12px;
            width: 90%;
            max-width: 480px;
            min-height: 200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(16, 185, 129, 0.3);
            position: relative;
            z-index: 2001;
            animation: modalFadeIn 0.2s ease-out;
            margin: auto;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.15rem;
            color: #f1f5f9;
        }

        .modal-close {
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #ef4444;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #334155;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #334155;
            border-radius: 6px;
            font-size: 0.95rem;
            background-color: #0f172a;
            color: #f1f5f9;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Slide Panel for Sharing */
        .slide-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 400px;
            height: 100%;
            background: #1e293b;
            border-left: 1px solid #334155;
            z-index: 1500;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.3);
        }

        .slide-panel.active {
            right: 0;
        }

        .slide-panel-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slide-panel-header h2 {
            margin: 0;
            font-size: 1.1rem;
            color: #f1f5f9;
        }

        .slide-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .slide-panel-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1400;
        }

        .slide-panel-backdrop.active {
            display: block;
        }

        /* Share Code Display */
        .share-code-box {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }

        .share-code {
            font-size: 1.5rem;
            font-family: monospace;
            font-weight: 700;
            color: #10b981;
            letter-spacing: 2px;
            margin: 0.5rem 0;
        }

        /* Share List Item */
        .share-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .share-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .share-item-status {
            font-weight: 600;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .share-item-meta {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.75rem;
        }

        .share-item-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-pending {
            background: #f59e0b20;
            color: #f59e0b;
        }

        .badge-accepted {
            background: #10b98120;
            color: #10b981;
        }

        /* Accept Share Section */
        .accept-share-section {
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .accept-share-section h4 {
            margin: 0 0 0.75rem 0;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .accept-share-row {
            display: flex;
            gap: 0.5rem;
        }

        .accept-share-row input {
            flex: 1;
            padding: 0.6rem 0.75rem;
            border: 1px solid #334155;
            border-radius: 6px;
            background: #1e293b;
            color: #f1f5f9;
            font-size: 0.9rem;
        }

        .accept-share-row input:focus {
            outline: none;
            border-color: #10b981;
        }

        .accept-result {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .accept-result.success {
            background: #10b98120;
            color: #10b981;
        }

        .accept-result.error {
            background: #ef444420;
            color: #ef4444;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .tree-sidebar {
                width: 100%;
                height: 250px;
                min-width: unset;
                border-right: none;
                border-bottom: 1px solid #334155;
            }
            .slide-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard" class="navbar-brand">Plant Monitor</a>
            <div class="navbar-menu">
                <a href="/dashboard" class="navbar-link">Dashboard</a>
                <a href="/devices" class="navbar-link">Devices</a>
                <a href="/plants" class="navbar-link">Plants</a>
                <a href="/locations" class="navbar-link active">Locations</a>
                <a href="/templates" class="navbar-link">Templates</a>
                {% if user.is_superuser %}
                <a href="/admin/overview" class="navbar-link">Admin Overview</a>
                <a href="/admin/users" class="navbar-link">Users</a>
                {% endif %}
                <span class="navbar-user">{{ user.email }}</span>
                <a href="/auth/logout" class="navbar-logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <!-- Tree Sidebar -->
        <aside class="tree-sidebar">
            <div class="sidebar-header">
                <h2>Locations</h2>
                <div class="sidebar-actions">
                    <button class="icon-btn" onclick="openAddModal()" title="Add Location">+</button>
                </div>
            </div>
            <div class="accept-share-section">
                <h4>Accept Share Code</h4>
                <div class="accept-share-row">
                    <input type="text" id="share-code-input" placeholder="Enter code...">
                    <button class="btn btn-primary" onclick="acceptShareCode()">Accept</button>
                </div>
                <div id="accept-result"></div>
            </div>
            <div class="tree-container" id="tree-container">
                <!-- Tree nodes rendered here -->
            </div>
        </aside>

        <!-- Detail Panel -->
        <main class="detail-panel">
            <div id="detail-content">
                <!-- Empty state shown by default -->
                <div class="empty-state">
                    <div class="empty-state-icon">üìç</div>
                    <h2>Select a Location</h2>
                    <p>Choose a location from the sidebar to view its details and devices</p>
                    <button class="btn btn-primary" onclick="openAddModal()">+ Add Location</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Location Modal -->
    <div class="modal-overlay" id="location-modal" onclick="if(event.target === this) closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modal-title">Add Location</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="location-form" onsubmit="saveLocation(event)">
                    <input type="hidden" id="location-id">
                    <div class="form-group">
                        <label for="location-name">Name *</label>
                        <input type="text" id="location-name" required placeholder="e.g., Grow Room 1">
                    </div>
                    <div class="form-group">
                        <label for="location-description">Description</label>
                        <textarea id="location-description" placeholder="Optional description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="location-parent">Parent Location</label>
                        <select id="location-parent">
                            <option value="">None (Top Level)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" type="button" onclick="document.getElementById('location-form').requestSubmit()">Save</button>
            </div>
        </div>
    </div>

    <!-- Share Slide Panel -->
    <div class="slide-panel-backdrop" id="share-backdrop" onclick="closeSharePanel()"></div>
    <div class="slide-panel" id="share-panel">
        <div class="slide-panel-header">
            <h2 id="share-panel-title">Share Location</h2>
            <button class="modal-close" onclick="closeSharePanel()">&times;</button>
        </div>
        <div class="slide-panel-body">
            <!-- Create Share -->
            <div class="section-box">
                <div class="section-header">
                    <h3>Create Share Link</h3>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label for="share-permission">Permission Level</label>
                        <select id="share-permission">
                            <option value="viewer">Viewer (Read Only)</option>
                            <option value="controller">Controller (Full Control)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="share-expires-type">Expiration</label>
                        <select id="share-expires-type" onchange="toggleExpiresInput()">
                            <option value="days">Expires in days</option>
                            <option value="never">Never expires</option>
                        </select>
                    </div>
                    <div class="form-group" id="expires-days-group">
                        <label for="share-expires">Days until expiry</label>
                        <input type="number" id="share-expires" value="7" min="1" max="365">
                    </div>
                    <button class="btn btn-primary" onclick="createShare()" style="width: 100%;">Generate Share Code</button>
                    <div id="share-code-display"></div>
                </div>
            </div>

            <!-- Active Shares -->
            <div class="section-box">
                <div class="section-header">
                    <h3>Active Shares</h3>
                </div>
                <div class="section-body" id="shares-list">
                    <p style="color: #64748b; text-align: center;">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let locations = [];
        let devices = [];
        let selectedLocationId = null;
        let expandedNodes = new Set();
        let currentShareLocationId = null;

        // Helper function to format device type
        function formatDeviceType(type) {
            const types = {
                'feeding_system': 'üíß Feeding System',
                'environmental': 'üå°Ô∏è Environmental',
                'valve_controller': 'üöø Valve Controller',
                'other': 'üì¶ Other'
            };
            return types[type] || types['other'];
        }

        // Helper function to format relative time
        function formatRelativeTime(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Unknown';

            const now = new Date();
            const diffMs = now - date;
            const diffSecs = Math.floor(diffMs / 1000);
            const diffMins = Math.floor(diffSecs / 60);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffSecs < 60) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // Fetch data
        async function fetchData() {
            const [locationsRes, devicesRes] = await Promise.all([
                fetch('/user/locations'),
                fetch('/user/devices')
            ]);

            if (locationsRes.ok) locations = await locationsRes.json();
            if (devicesRes.ok) devices = await devicesRes.json();

            renderTree();
            if (selectedLocationId) {
                renderDetail(selectedLocationId);
            }
        }

        // Build hierarchy
        function buildHierarchy(locs) {
            const map = {};
            const roots = [];

            locs.forEach(loc => map[loc.id] = { ...loc, children: [] });
            locs.forEach(loc => {
                if (loc.parent_id && map[loc.parent_id]) {
                    map[loc.parent_id].children.push(map[loc.id]);
                } else {
                    roots.push(map[loc.id]);
                }
            });

            return roots;
        }

        // Render tree
        function renderTree() {
            const container = document.getElementById('tree-container');
            const hierarchy = buildHierarchy(locations);

            if (hierarchy.length === 0) {
                container.innerHTML = `
                    <div style="padding: 1.5rem; text-align: center; color: #64748b;">
                        <p>No locations yet</p>
                        <button class="btn btn-primary" onclick="openAddModal()" style="margin-top: 0.5rem;">+ Add Location</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = hierarchy.map(loc => renderTreeNode(loc)).join('');
        }

        function renderTreeNode(location, level = 0) {
            const hasChildren = location.children && location.children.length > 0;
            const isExpanded = expandedNodes.has(location.id);
            const isSelected = selectedLocationId === location.id;
            const deviceCount = devices.filter(d => d.location_id === location.id).length;

            let html = `
                <div class="tree-node" data-id="${location.id}">
                    <div class="tree-node-content ${isSelected ? 'selected' : ''} ${!location.is_owner ? 'shared' : ''}"
                         onclick="selectLocation(${location.id})">
                        <span class="tree-toggle ${hasChildren ? (isExpanded ? 'expanded' : '') : 'empty'}"
                              onclick="event.stopPropagation(); toggleNode(${location.id})">
                            ${hasChildren ? '‚ñ∂' : ''}
                        </span>
                        <span class="tree-icon">${hasChildren ? 'üìÅ' : 'üìç'}</span>
                        <span class="tree-label">${location.name}</span>
                        ${deviceCount > 0 ? `<span class="tree-badge">${deviceCount}</span>` : ''}
                    </div>
            `;

            if (hasChildren && isExpanded) {
                html += `<div class="tree-children">`;
                location.children.forEach(child => {
                    html += renderTreeNode(child, level + 1);
                });
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function toggleNode(id) {
            if (expandedNodes.has(id)) {
                expandedNodes.delete(id);
            } else {
                expandedNodes.add(id);
            }
            renderTree();
        }

        function selectLocation(id) {
            selectedLocationId = id;
            renderTree();
            renderDetail(id);
        }

        // Render detail panel
        function renderDetail(id) {
            const location = locations.find(l => l.id === id);
            if (!location) return;

            const locationDevices = devices.filter(d => d.location_id === id);
            const childLocations = locations.filter(l => l.parent_id === id);
            const parentLocation = location.parent_id ? locations.find(l => l.id === location.parent_id) : null;

            // Build breadcrumb
            let breadcrumb = [];
            let current = location;
            while (current) {
                breadcrumb.unshift(current.name);
                current = current.parent_id ? locations.find(l => l.id === current.parent_id) : null;
            }

            const container = document.getElementById('detail-content');
            container.innerHTML = `
                <div class="detail-header">
                    <div class="breadcrumb">${breadcrumb.map((b, i) => i < breadcrumb.length - 1 ? `${b} <span>/</span> ` : '').join('')}</div>
                    <h1>
                        <span>${location.name}</span>
                        ${!location.is_owner ? `<span class="badge badge-pending" style="font-size: 0.75rem;">Shared by ${location.shared_by_email}</span>` : ''}
                    </h1>
                    ${location.description ? `<p style="color: #94a3b8; margin: 0.5rem 0 0 0;">${location.description}</p>` : ''}
                    <div class="detail-actions">
                        ${location.is_owner ? `
                            <button class="btn btn-secondary" onclick="openEditModal(${location.id})">Edit</button>
                            <button class="btn btn-secondary" onclick="openSharePanel(${location.id})">Share</button>
                            <button class="btn btn-primary" onclick="openAddModal(${location.id})">+ Add Sub-Location</button>
                            <button class="btn btn-danger" onclick="deleteLocation(${location.id})">Delete</button>
                        ` : `
                            <span style="color: #64748b; font-size: 0.9rem;">Permission: ${location.permission_level}</span>
                        `}
                    </div>
                </div>
                <div class="detail-content">
                    <!-- Info Section -->
                    <div class="section-box">
                        <div class="section-header">
                            <h3>üìä Overview</h3>
                        </div>
                        <div class="section-body">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Devices</div>
                                    <div class="info-value">${locationDevices.length}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Sub-Locations</div>
                                    <div class="info-value">${childLocations.length}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Parent</div>
                                    <div class="info-value">${parentLocation ? parentLocation.name : 'None (Top Level)'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Ownership</div>
                                    <div class="info-value">${location.is_owner ? 'You own this' : `Shared (${location.permission_level})`}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Child Locations -->
                    ${childLocations.length > 0 ? `
                        <div class="section-box">
                            <div class="section-header">
                                <h3>üìÅ Sub-Locations (${childLocations.length})</h3>
                            </div>
                            <div class="section-body">
                                <div class="child-locations">
                                    ${childLocations.map(child => `
                                        <div class="child-location-chip" onclick="selectLocation(${child.id}); expandedNodes.add(${location.id}); renderTree();">
                                            <span>üìç</span>
                                            <span>${child.name}</span>
                                            <span style="color: #64748b; font-size: 0.8rem;">${devices.filter(d => d.location_id === child.id).length} devices</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Devices Section -->
                    <div class="section-box">
                        <div class="section-header">
                            <h3>üì° Devices (${locationDevices.length})</h3>
                        </div>
                        <div class="section-body">
                            ${locationDevices.length > 0 ? `
                                <div class="device-grid">
                                    ${locationDevices.map(device => `
                                        <div class="device-card ${device.is_online ? 'device-online' : ''}">
                                            <div class="device-card-header">
                                                <div class="device-name">${device.name || device.system_name || 'Unnamed Device'}</div>
                                                <div class="device-status ${device.is_online ? 'online' : 'offline'}">
                                                    <span class="status-dot"></span>
                                                    ${device.is_online ? 'Online' : 'Offline'}
                                                </div>
                                            </div>

                                            <div class="device-info-grid">
                                                <div class="device-info-item">
                                                    <span class="device-info-label">Type</span>
                                                    <span class="device-info-value">${formatDeviceType(device.device_type)}</span>
                                                </div>
                                                <div class="device-info-item">
                                                    <span class="device-info-label">Scope</span>
                                                    <span class="device-info-value">${device.scope === 'room' ? 'üè† Room' : 'üå± Plant'}</span>
                                                </div>
                                                <div class="device-info-item">
                                                    <span class="device-info-label">Device ID</span>
                                                    <span class="device-info-value device-id">${device.device_id}</span>
                                                </div>
                                                <div class="device-info-item">
                                                    <span class="device-info-label">Last Seen</span>
                                                    <span class="device-info-value">${device.last_seen ? formatRelativeTime(device.last_seen) : 'Never'}</span>
                                                </div>
                                            </div>

                                            ${device.assigned_plants && device.assigned_plants.length > 0 ? `
                                                <div class="device-plants">
                                                    <span class="device-info-label">Assigned Plants</span>
                                                    <div class="plant-chips">
                                                        ${device.assigned_plants.map(plant => `
                                                            <span class="plant-chip">
                                                                üå± ${plant.name}
                                                                ${plant.current_phase ? `<span class="phase-badge">${plant.current_phase}</span>` : ''}
                                                            </span>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            ` : device.assigned_plant_count > 0 ? `
                                                <div class="device-plants">
                                                    <span class="device-info-label">Plants</span>
                                                    <span class="device-info-value">${device.assigned_plant_count} assigned</span>
                                                </div>
                                            ` : ''}

                                            ${!device.is_owner ? `
                                                <div class="device-shared-badge">
                                                    <span>üì§ Shared by ${device.shared_by_email || 'another user'}</span>
                                                    <span class="permission-badge">${device.permission_level}</span>
                                                </div>
                                            ` : ''}

                                            <div class="device-card-actions">
                                                <a href="/dashboard?device=${device.device_id}" class="btn btn-primary" style="flex: 1;">
                                                    ${device.is_online ? 'üéõÔ∏è Control' : 'üìä View'}
                                                </a>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 2rem; color: #64748b;">
                                    <p>No devices in this location</p>
                                    <a href="/devices" class="btn btn-secondary" style="margin-top: 0.5rem;">Manage Devices</a>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal functions
        function openAddModal(parentId = null) {
            document.getElementById('modal-title').textContent = 'Add Location';
            document.getElementById('location-id').value = '';
            document.getElementById('location-name').value = '';
            document.getElementById('location-description').value = '';
            updateParentDropdown();
            document.getElementById('location-parent').value = parentId || '';
            document.getElementById('location-modal').classList.add('active');
        }

        function openEditModal(id) {
            const location = locations.find(l => l.id === id);
            if (!location) return;

            document.getElementById('modal-title').textContent = 'Edit Location';
            document.getElementById('location-id').value = location.id;
            document.getElementById('location-name').value = location.name;
            document.getElementById('location-description').value = location.description || '';
            updateParentDropdown(id);
            document.getElementById('location-parent').value = location.parent_id || '';
            document.getElementById('location-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('location-modal').classList.remove('active');
        }

        function updateParentDropdown(excludeId = null) {
            const select = document.getElementById('location-parent');
            select.innerHTML = '<option value="">None (Top Level)</option>';

            const ownedLocations = locations.filter(loc => loc.is_owner && loc.id !== excludeId);
            ownedLocations.forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.id;
                option.textContent = loc.name;
                select.appendChild(option);
            });
        }

        async function saveLocation(event) {
            event.preventDefault();

            const id = document.getElementById('location-id').value;
            const data = {
                name: document.getElementById('location-name').value,
                description: document.getElementById('location-description').value || null,
                parent_id: document.getElementById('location-parent').value || null
            };

            if (data.parent_id) data.parent_id = parseInt(data.parent_id);

            try {
                const response = await fetch(id ? `/user/locations/${id}` : '/user/locations', {
                    method: id ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeModal();
                    const result = await response.json();
                    if (!id) {
                        selectedLocationId = result.id;
                        expandedNodes.add(data.parent_id);
                    }
                    await fetchData();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Failed to save'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function deleteLocation(id) {
            if (!confirm('Delete this location? Devices will be unassigned.')) return;

            try {
                const response = await fetch(`/user/locations/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    if (selectedLocationId === id) selectedLocationId = null;
                    await fetchData();
                    document.getElementById('detail-content').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìç</div>
                            <h2>Location Deleted</h2>
                            <p>Select another location from the sidebar</p>
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Failed to delete'}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        // Share panel functions
        function openSharePanel(id) {
            currentShareLocationId = id;
            const location = locations.find(l => l.id === id);
            document.getElementById('share-panel-title').textContent = `Share: ${location?.name || 'Location'}`;
            document.getElementById('share-code-display').innerHTML = '';
            document.getElementById('share-panel').classList.add('active');
            document.getElementById('share-backdrop').classList.add('active');
            loadShares(id);
        }

        function closeSharePanel() {
            document.getElementById('share-panel').classList.remove('active');
            document.getElementById('share-backdrop').classList.remove('active');
            currentShareLocationId = null;
        }

        function toggleExpiresInput() {
            const type = document.getElementById('share-expires-type').value;
            document.getElementById('expires-days-group').style.display = type === 'never' ? 'none' : 'block';
        }

        async function createShare() {
            const permission = document.getElementById('share-permission').value;
            const expiresType = document.getElementById('share-expires-type').value;
            const expiresInDays = expiresType === 'never' ? null : parseInt(document.getElementById('share-expires').value);

            try {
                const response = await fetch(`/user/locations/${currentShareLocationId}/share`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ permission_level: permission, expires_in_days: expiresInDays })
                });

                const display = document.getElementById('share-code-display');
                if (response.ok) {
                    const data = await response.json();
                    const expiryText = data.expires_at ? `Expires: ${new Date(data.expires_at).toLocaleString()}` : 'Never expires';
                    display.innerHTML = `
                        <div class="share-code-box">
                            <p style="margin: 0; color: #10b981; font-weight: 600;">Share Code Generated!</p>
                            <p class="share-code">${data.share_code}</p>
                            <p style="margin: 0; font-size: 0.85rem; color: #64748b;">${expiryText}</p>
                            <button class="btn btn-secondary" onclick="navigator.clipboard.writeText('${data.share_code}')" style="margin-top: 0.75rem;">Copy Code</button>
                        </div>
                    `;
                    loadShares(currentShareLocationId);
                } else {
                    const error = await response.json();
                    display.innerHTML = `<p style="color: #ef4444; margin-top: 1rem;">Error: ${error.detail}</p>`;
                }
            } catch (error) {
                document.getElementById('share-code-display').innerHTML = `<p style="color: #ef4444; margin-top: 1rem;">Error: ${error.message}</p>`;
            }
        }

        async function loadShares(locationId) {
            try {
                const response = await fetch(`/user/locations/${locationId}/shares`);
                const sharesList = document.getElementById('shares-list');

                if (response.ok) {
                    const shares = await response.json();

                    if (shares.length === 0) {
                        sharesList.innerHTML = '<p style="color: #64748b; text-align: center;">No active shares</p>';
                        return;
                    }

                    sharesList.innerHTML = shares.map(share => {
                        const statusText = share.accepted_at
                            ? `Accepted by ${share.shared_with_email}`
                            : `Pending`;
                        const expiryText = share.expires_at === null
                            ? 'Never expires'
                            : new Date(share.expires_at) > new Date()
                                ? `Expires: ${new Date(share.expires_at).toLocaleDateString()}`
                                : 'Expired';

                        return `
                            <div class="share-item">
                                <div class="share-item-header">
                                    <span class="share-item-status">${statusText}</span>
                                    <span class="badge ${share.accepted_at ? 'badge-accepted' : 'badge-pending'}">
                                        ${share.accepted_at ? 'Active' : 'Pending'}
                                    </span>
                                </div>
                                <div class="share-item-meta">
                                    ${!share.accepted_at ? `Code: <code>${share.share_code}</code><br>` : ''}
                                    Permission: ${share.permission_level}<br>
                                    ${expiryText}
                                </div>
                                <div class="share-item-actions">
                                    ${share.accepted_at ? `
                                        <select id="perm-${share.id}" style="padding: 0.35rem; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #e2e8f0; font-size: 0.8rem;">
                                            <option value="viewer" ${share.permission_level === 'viewer' ? 'selected' : ''}>Viewer</option>
                                            <option value="controller" ${share.permission_level === 'controller' ? 'selected' : ''}>Controller</option>
                                        </select>
                                        <button class="btn btn-secondary" onclick="updatePermission(${locationId}, ${share.id})" style="font-size: 0.8rem; padding: 0.35rem 0.75rem;">Update</button>
                                    ` : ''}
                                    <button class="btn btn-danger" onclick="revokeShare(${locationId}, ${share.id})" style="font-size: 0.8rem; padding: 0.35rem 0.75rem;">Revoke</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                document.getElementById('shares-list').innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
            }
        }

        async function revokeShare(locationId, shareId) {
            if (!confirm('Revoke this share?')) return;

            try {
                const response = await fetch(`/user/locations/${locationId}/shares/${shareId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadShares(locationId);
                } else {
                    alert('Failed to revoke share');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function updatePermission(locationId, shareId) {
            const permission = document.getElementById(`perm-${shareId}`).value;

            try {
                const response = await fetch(`/user/locations/${locationId}/shares/${shareId}/permission`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ permission_level: permission })
                });

                if (response.ok) {
                    loadShares(locationId);
                } else {
                    alert('Failed to update permission');
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function acceptShareCode() {
            const code = document.getElementById('share-code-input').value.trim();
            const resultDiv = document.getElementById('accept-result');

            if (!code) {
                resultDiv.innerHTML = '<div class="accept-result error">Please enter a code</div>';
                return;
            }

            try {
                const response = await fetch('/user/locations/accept-share', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ share_code: code })
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = '<div class="accept-result success">Location added successfully!</div>';
                    document.getElementById('share-code-input').value = '';
                    await fetchData();
                    selectLocation(data.location_id);
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<div class="accept-result error">Error: ${error.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="accept-result error">Error: ${error.message}</div>`;
            }
        }

        // Close modal on outside click
        document.getElementById('location-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Initialize
        fetchData();
    </script>
</body>
</html>
