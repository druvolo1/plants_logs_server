<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plants - Plant Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #10b981;
        }

        .navbar-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
            text-decoration: none;
        }

        .navbar-brand:hover {
            color: #34d399;
        }

        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .navbar-link {
            padding: 1rem 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .navbar-link:hover {
            background: rgba(16, 185, 129, 0.1);
            border-bottom-color: #10b981;
        }

        .navbar-link.active {
            background: rgba(16, 185, 129, 0.15);
            border-bottom-color: #10b981;
            color: #10b981;
        }

        .navbar-user {
            padding: 1rem 1.25rem;
            color: rgba(148, 163, 184, 0.9);
            font-size: 0.9rem;
            border-left: 1px solid rgba(148, 163, 184, 0.2);
        }

        .navbar-logout {
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .navbar-logout:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .nav {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: #e2e8f0;
            text-decoration: none;
            border-radius: 8px;
            border: 1px solid #475569;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn:hover {
            background: linear-gradient(135deg, #334155 0%, #475569 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .plants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .plant-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .plant-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
        }

        .plant-card.finished {
            border-color: #64748b;
            opacity: 0.8;
        }

        .plant-card.dragging {
            opacity: 0.5;
        }

        .plant-drag-handle {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            color: #6b7280;
            font-size: 1.25rem;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
            transition: all 0.2s;
        }

        .plant-drag-handle:hover {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .plant-drag-handle:active {
            cursor: grabbing;
        }

        .plant-card-content {
            margin-left: 2rem;
        }

        .plant-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .plant-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #10b981;
        }

        .plant-status {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .plant-status.active {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .plant-status.finished {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        .plant-info {
            margin-top: 1rem;
        }

        .plant-info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #334155;
        }

        .plant-info-row:last-child {
            border-bottom: none;
        }

        .plant-info-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .plant-info-value {
            color: #e2e8f0;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 12px;
            max-width: 1200px;
            border: 2px solid #10b981;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #334155;
        }

        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #94a3b8;
        }

        .close:hover {
            color: #e2e8f0;
        }

        .chart-container {
            background: #0f172a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #334155;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-group label {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem 1rem;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: #e2e8f0;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #334155;
            border-radius: 12px;
        }

        .empty-state h2 {
            color: #94a3b8;
            margin-bottom: 1rem;
        }

        canvas {
            max-height: 400px;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }

        .menu-container {
            position: relative;
            display: inline-block;
        }

        .menu-button {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.2s;
        }

        .menu-button:hover {
            color: #e2e8f0;
        }

        .menu-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 180px;
            z-index: 1000;
            margin-top: 0.5rem;
        }

        .menu-dropdown.show {
            display: block;
        }

        .menu-item {
            padding: 0.75rem 1rem;
            color: #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .menu-item:hover {
            background: #334155;
        }

        .menu-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 6px 6px;
        }

        .menu-item.danger {
            color: #ef4444;
        }

        .menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .menu-divider {
            height: 1px;
            background: #334155;
            margin: 0.25rem 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard" class="navbar-brand">
                üå± Plant Monitor
            </a>
            <div class="navbar-menu" id="navbar-menu">
                <a href="/dashboard" class="navbar-link">Dashboard</a>
                <a href="/devices" class="navbar-link">Devices</a>
                <a href="/plants" class="navbar-link active">Plants</a>
                <span class="navbar-user" id="userEmail">Loading...</span>
                <a href="/auth/logout" class="navbar-logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="filters">
            <div class="filter-group">
                <label>Filter by Status</label>
                <select id="statusFilter">
                    <option value="all">All Plants</option>
                    <option value="active" selected>Active Only</option>
                    <option value="finished">Finished Only</option>
                </select>
            </div>
        </div>

        <div id="plantsContainer" class="plants-grid">
            <div class="loading">Loading plants...</div>
        </div>
    </div>

    <!-- Plant Details Modal -->
    <div id="plantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="menu-container">
                        <button class="menu-button" onclick="togglePlantMenu(event)">‚ò∞</button>
                        <div class="menu-dropdown" id="plantMenu">
                            <button class="menu-item" onclick="exportToHTML()">üìÑ Export HTML</button>
                            <button class="menu-item" onclick="exportToPDF()">üìë Export PDF</button>
                            <div class="menu-divider" id="menuDivider" style="display: none;"></div>
                            <button class="menu-item danger" id="deleteMenuItem" onclick="deletePlant()" style="display: none;">üóëÔ∏è Delete Plant</button>
                        </div>
                    </div>
                    <h2 id="modalPlantName"></h2>
                </div>
                <span class="close" onclick="closePlantModal()">&times;</span>
            </div>

            <div class="stats-grid" id="plantStats"></div>

            <div class="filters">
                <div class="filter-group">
                    <label>Time Range</label>
                    <select id="timeRangeFilter" onchange="updateCharts()">
                        <option value="7">Last 7 Days</option>
                        <option value="30" selected>Last 30 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="phChart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="dosingChart"></canvas>
            </div>

            <div style="margin-top: 1rem; padding: 1rem; text-align: center; color: #64748b; font-size: 0.875rem;">
                Plant ID: <span id="modalPlantId" style="font-family: monospace; color: #94a3b8;"></span>
            </div>
        </div>
    </div>

    <script>
        let plants = [];
        let currentPlant = null;
        let currentLogs = [];
        let phChart = null;
        let dosingChart = null;
        let isAdmin = false;
        let currentUserId = null;

        // Check if current user is admin and set up navigation
        async function checkUserRole() {
            try {
                const response = await fetch('/api/user/me');
                if (response.ok) {
                    const user = await response.json();
                    isAdmin = user.is_superuser || false;
                    currentUserId = user.id;

                    // Update user email in nav
                    document.getElementById('userEmail').textContent = user.email;

                    // Add Users link for admins
                    if (isAdmin) {
                        const plantsLink = document.querySelector('.navbar-link.active');
                        const userEmailSpan = document.getElementById('userEmail');

                        // Create Users link
                        const usersLink = document.createElement('a');
                        usersLink.href = '/admin/users';
                        usersLink.className = 'navbar-link';
                        usersLink.textContent = 'Users';

                        // Insert after Plants link and before user email
                        plantsLink.parentNode.insertBefore(usersLink, userEmailSpan);
                    }
                }
            } catch (error) {
                console.error('Error checking user role:', error);
            }
        }

        // Fetch plants on load
        async function loadPlants() {
            try {
                const statusFilter = document.getElementById('statusFilter').value;
                const url = statusFilter === 'active' ? '/user/plants?active_only=true' : '/user/plants';

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load plants');

                plants = await response.json();

                if (statusFilter === 'finished') {
                    plants = plants.filter(p => !p.is_active);
                }

                renderPlants();
            } catch (error) {
                console.error('Error loading plants:', error);
                document.getElementById('plantsContainer').innerHTML = `
                    <div class="empty-state">
                        <h2>Error loading plants</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function renderPlants() {
            const container = document.getElementById('plantsContainer');

            if (plants.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>No Plants Found</h2>
                        <p>Start a new plant from your pH dosing system device.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = plants.map(plant => `
                <div class="plant-card ${plant.is_active ? '' : 'finished'}" data-plant-id="${plant.plant_id}" draggable="true">
                    <div class="plant-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</div>
                    <div class="plant-card-content" onclick="viewPlantDetails('${plant.plant_id}')">
                        <div class="plant-header">
                            <div class="plant-name">${escapeHtml(plant.name)}</div>
                            <div class="plant-status ${plant.is_active ? 'active' : 'finished'}">
                                ${plant.is_active ? 'Active' : 'Finished'}
                            </div>
                        </div>
                        <div class="plant-info">
                            <div class="plant-info-row">
                                <span class="plant-info-label">System</span>
                                <span class="plant-info-value">${escapeHtml(plant.system_id || 'N/A')}</span>
                            </div>
                            <div class="plant-info-row">
                                <span class="plant-info-label">Started</span>
                                <span class="plant-info-value">${formatDate(plant.start_date)}</span>
                            </div>
                            ${!plant.is_active ? `
                                <div class="plant-info-row">
                                    <span class="plant-info-label">Finished</span>
                                    <span class="plant-info-value">${formatDate(plant.end_date)}</span>
                                </div>
                            ` : ''}
                            ${plant.yield_grams ? `
                                <div class="plant-info-row">
                                    <span class="plant-info-label">Yield</span>
                                    <span class="plant-info-value">${plant.yield_grams}g</span>
                                </div>
                            ` : ''}
                            <div class="plant-info-row">
                                <span class="plant-info-label">Age</span>
                                <span class="plant-info-value">${calculateAge(plant.start_date, plant.end_date)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Initialize drag and drop after rendering
            initializePlantDragAndDrop();
        }

        async function viewPlantDetails(plantId) {
            currentPlant = plants.find(p => p.plant_id === plantId);
            if (!currentPlant) return;

            document.getElementById('modalPlantName').textContent = currentPlant.name;
            document.getElementById('modalPlantId').textContent = currentPlant.plant_id;
            document.getElementById('plantModal').style.display = 'block';

            // Show delete menu item for admins or plant owners
            const deleteMenuItem = document.getElementById('deleteMenuItem');
            const menuDivider = document.getElementById('menuDivider');
            if (isAdmin || currentPlant.user_id === currentUserId) {
                deleteMenuItem.style.display = 'flex';
                menuDivider.style.display = 'block';
            } else {
                deleteMenuItem.style.display = 'none';
                menuDivider.style.display = 'none';
            }

            await loadPlantLogs(plantId);
        }

        function togglePlantMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('plantMenu');
            menu.classList.toggle('show');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('plantMenu');
            const menuContainer = event.target.closest('.menu-container');
            if (!menuContainer && menu) {
                menu.classList.remove('show');
            }
        });

        async function deletePlant() {
            if (!currentPlant) return;

            // Close the menu
            const menu = document.getElementById('plantMenu');
            menu.classList.remove('show');

            // First confirmation
            const firstConfirm = confirm(`Are you sure?`);
            if (!firstConfirm) return;

            // Second confirmation
            const secondConfirm = confirm(`Are you absolutely sure? This can't be undone and your plant data will be deleted from our database.`);
            if (!secondConfirm) return;

            try {
                const response = await fetch(`/user/plants/${currentPlant.plant_id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`Failed to delete plant: ${response.status}`);
                }

                const data = await response.json();
                alert(data.message || 'Plant deleted successfully');

                closePlantModal();
                await loadPlants(); // Reload the plant list
            } catch (error) {
                console.error('Error deleting plant:', error);
                alert(`Failed to delete plant: ${error.message}`);
            }
        }

        // Add touch support for mobile dragging
        function addPlantTouchSupport(element, container, onDragEnd) {
            let touchStartY = 0;
            let touchStartX = 0;
            let isDragging = false;
            let dragTimer = null;

            element.addEventListener('touchstart', (e) => {
                // Only start drag from drag handle
                const isDragHandle = e.target.closest('.plant-drag-handle');
                if (!isDragHandle) return;

                const touch = e.touches[0];
                touchStartY = touch.clientY;
                touchStartX = touch.clientX;

                // Add immediate visual feedback
                element.style.transition = 'opacity 0.15s ease';

                dragTimer = setTimeout(() => {
                    isDragging = true;
                    element.classList.add('dragging');
                    element.style.opacity = '0.8';

                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }, 150);
            });

            element.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                const currentY = touch.clientY;
                const currentX = touch.clientX;

                // Check if moved enough to be a drag
                const deltaY = Math.abs(currentY - touchStartY);
                const deltaX = Math.abs(currentX - touchStartX);

                // If user is scrolling (vertical movement dominates), cancel drag
                if (!isDragging && deltaY > 15 && deltaY > deltaX * 1.5) {
                    clearTimeout(dragTimer);
                    isDragging = false;
                    element.style.transition = '';
                    return; // Allow normal scrolling
                }

                if (!isDragging && deltaY > 15) {
                    clearTimeout(dragTimer);
                    isDragging = true;
                    element.classList.add('dragging');
                    element.style.opacity = '0.8';

                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                }

                // Only prevent scrolling if we're actively dragging
                if (!isDragging) return;

                // Prevent scrolling while dragging
                e.preventDefault();

                // Hide the element temporarily to get element underneath
                element.style.visibility = 'hidden';
                const elementsAtPoint = document.elementsFromPoint(touch.clientX, currentY);
                element.style.visibility = 'visible';

                const targetCard = elementsAtPoint.find(el =>
                    el !== element &&
                    el.classList &&
                    el.classList.contains('plant-card')
                );

                if (targetCard && container) {
                    const rect = targetCard.getBoundingClientRect();
                    const midpoint = rect.top + rect.height / 2;

                    if (currentY < midpoint) {
                        container.insertBefore(element, targetCard);
                    } else {
                        container.insertBefore(element, targetCard.nextSibling);
                    }
                }
            });

            element.addEventListener('touchend', (e) => {
                clearTimeout(dragTimer);

                if (!isDragging) return;

                isDragging = false;
                element.classList.remove('dragging');
                element.style.opacity = '';
                element.style.transition = '';

                if (onDragEnd) {
                    onDragEnd();
                }
            });

            element.addEventListener('touchcancel', (e) => {
                clearTimeout(dragTimer);
                isDragging = false;
                element.classList.remove('dragging');
                element.style.opacity = '';
                element.style.transition = '';
            });
        }

        function initializePlantDragAndDrop() {
            const plantCards = document.querySelectorAll('.plant-card');
            const container = document.querySelector('.plants-grid');
            let draggedElement = null;

            plantCards.forEach(card => {
                // Add touch support for mobile
                addPlantTouchSupport(card, container, savePlantOrder);

                // Prevent card click from firing when clicking drag handle
                const dragHandle = card.querySelector('.plant-drag-handle');
                if (dragHandle) {
                    dragHandle.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                }

                card.addEventListener('dragstart', (e) => {
                    draggedElement = card;
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', (e) => {
                    card.classList.remove('dragging');
                });

                card.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(e.clientY);
                    const container = document.querySelector('.plants-grid');
                    if (afterElement == null) {
                        container.appendChild(draggedElement);
                    } else {
                        container.insertBefore(draggedElement, afterElement);
                    }
                });

                card.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    await savePlantOrder();
                });
            });

            function getDragAfterElement(y) {
                const draggableElements = [...document.querySelectorAll('.plant-card:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;

                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
        }

        async function savePlantOrder() {
            const plantCards = document.querySelectorAll('.plant-card');
            const plantOrder = Array.from(plantCards).map(card => card.getAttribute('data-plant-id'));

            try {
                const response = await fetch('/user/plants/reorder', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(plantOrder)
                });

                if (!response.ok) {
                    throw new Error('Failed to save plant order');
                }

                console.log('Plant order saved successfully');
            } catch (error) {
                console.error('Error saving plant order:', error);
                alert('Failed to save plant order. Please try again.');
                await loadPlants(); // Reload to reset order
            }
        }

        async function loadPlantLogs(plantId) {
            try {
                const timeRange = document.getElementById('timeRangeFilter').value;
                let url = `/user/plants/${plantId}/logs?limit=10000`;

                if (timeRange !== 'all') {
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - parseInt(timeRange));
                    url += `&start_date=${startDate.toISOString()}`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load logs');

                const logs = await response.json();

                // Reverse to show oldest first for charts
                logs.reverse();

                // Store logs globally for export
                currentLogs = logs;

                renderStats(logs);
                renderCharts(logs);
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        function renderStats(logs) {
            const sensorLogs = logs.filter(l => l.event_type === 'sensor');
            const dosingLogs = logs.filter(l => l.event_type === 'dosing');

            const phValues = sensorLogs.map(l => l.value);
            const avgPh = phValues.length > 0 ? (phValues.reduce((a, b) => a + b, 0) / phValues.length).toFixed(2) : 'N/A';
            const minPh = phValues.length > 0 ? Math.min(...phValues).toFixed(2) : 'N/A';
            const maxPh = phValues.length > 0 ? Math.max(...phValues).toFixed(2) : 'N/A';

            const totalDoses = dosingLogs.length;
            const upDoses = dosingLogs.filter(l => l.dose_type === 'up').length;
            const downDoses = dosingLogs.filter(l => l.dose_type === 'down').length;

            document.getElementById('plantStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${avgPh}</div>
                    <div class="stat-label">Average pH</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${minPh} - ${maxPh}</div>
                    <div class="stat-label">pH Range</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalDoses}</div>
                    <div class="stat-label">Total Doses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${upDoses} / ${downDoses}</div>
                    <div class="stat-label">Up / Down Doses</div>
                </div>
            `;
        }

        function renderCharts(logs) {
            const sensorLogs = logs.filter(l => l.event_type === 'sensor');
            const dosingLogs = logs.filter(l => l.event_type === 'dosing');

            // pH Chart
            const phCtx = document.getElementById('phChart').getContext('2d');

            if (phChart) phChart.destroy();

            phChart = new Chart(phCtx, {
                type: 'line',
                data: {
                    labels: sensorLogs.map(l => formatDateTime(l.timestamp)),
                    datasets: [{
                        label: 'pH Level',
                        data: sensorLogs.map(l => l.value),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        },
                        title: {
                            display: true,
                            text: 'pH History',
                            color: '#e2e8f0',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#e2e8f0' },
                            grid: { color: '#334155' },
                            title: {
                                display: true,
                                text: 'pH',
                                color: '#e2e8f0'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e2e8f0',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });

            // Dosing Chart - Daily aggregated bar chart
            const dosingCtx = document.getElementById('dosingChart').getContext('2d');

            if (dosingChart) dosingChart.destroy();

            // Aggregate dosing events by day with timestamps and amounts
            const dosingByDay = {};
            dosingLogs.forEach(log => {
                const dateKey = formatDate(log.timestamp);
                if (!dosingByDay[dateKey]) {
                    dosingByDay[dateKey] = { up: 0, down: 0, upDoses: [], downDoses: [] };
                }
                if (log.dose_type === 'up') {
                    dosingByDay[dateKey].up++;
                    dosingByDay[dateKey].upDoses.push({ time: log.timestamp, amount: log.dose_amount_ml });
                } else if (log.dose_type === 'down') {
                    dosingByDay[dateKey].down++;
                    dosingByDay[dateKey].downDoses.push({ time: log.timestamp, amount: log.dose_amount_ml });
                }
            });

            // Sort dates chronologically
            const sortedDates = Object.keys(dosingByDay).sort((a, b) => new Date(a) - new Date(b));
            const upCounts = sortedDates.map(date => dosingByDay[date].up);
            const downCounts = sortedDates.map(date => dosingByDay[date].down);

            dosingChart = new Chart(dosingCtx, {
                type: 'bar',
                data: {
                    labels: sortedDates,
                    datasets: [
                        {
                            label: 'pH Up Doses',
                            data: upCounts,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: '#3b82f6',
                            borderWidth: 1,
                            barPercentage: 0.9,
                            categoryPercentage: 0.3
                        },
                        {
                            label: 'pH Down Doses',
                            data: downCounts,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            barPercentage: 0.9,
                            categoryPercentage: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        },
                        title: {
                            display: true,
                            text: 'Daily Dosing Events',
                            color: '#e2e8f0',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const date = sortedDates[context.dataIndex];
                                    const isUpDose = context.datasetIndex === 0;
                                    const doses = isUpDose ? dosingByDay[date].upDoses : dosingByDay[date].downDoses;

                                    if (doses.length === 0) return '';

                                    const doseStrings = doses.map(dose => {
                                        const d = new Date(dose.time);
                                        const timeStr = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                        return `${timeStr} - ${dose.amount.toFixed(2)} ml`;
                                    });

                                    return '\nDoses:\n' + doseStrings.join('\n');
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#e2e8f0',
                                stepSize: 1
                            },
                            grid: { color: '#334155' },
                            title: {
                                display: true,
                                text: 'Number of Doses',
                                color: '#e2e8f0'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#e2e8f0',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
        }

        function closePlantModal() {
            document.getElementById('plantModal').style.display = 'none';
            if (phChart) phChart.destroy();
            if (dosingChart) dosingChart.destroy();
        }

        async function updateCharts() {
            if (currentPlant) {
                await loadPlantLogs(currentPlant.plant_id);
            }
        }

        function exportToHTML() {
            if (!currentPlant || !currentLogs) {
                alert('No plant data to export');
                return;
            }

            // Close the menu
            const menu = document.getElementById('plantMenu');
            menu.classList.remove('show');

            const sensorLogs = currentLogs.filter(l => l.event_type === 'sensor');
            const dosingLogs = currentLogs.filter(l => l.event_type === 'dosing');

            const plantName = escapeHtml(currentPlant.name);
            const plantId = escapeHtml(currentPlant.plant_id);
            const exportTime = new Date().toLocaleString();

            // Create HTML parts
            const htmlContent = '<!DOCTYPE html>' + '\n' +
'<html lang="en">' + '\n' +
'<head>' + '\n' +
'    <meta charset="UTF-8">' + '\n' +
'    <meta name="viewport" content="width=device-width, initial-scale=1.0">' + '\n' +
'    <title>' + plantName + ' - Plant Report</title>' + '\n' +
'    <script src="https://cdn.jsdelivr.net/npm/chart.js"><' + '/script>' + '\n' +
'    <style>' + '\n' +
'        body {' + '\n' +
'            font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif;' + '\n' +
'            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);' + '\n' +
'            color: #e2e8f0;' + '\n' +
'            padding: 2rem;' + '\n' +
'            margin: 0;' + '\n' +
'        }' + '\n' +
'        .container {' + '\n' +
'            max-width: 1200px;' + '\n' +
'            margin: 0 auto;' + '\n' +
'        }' + '\n' +
'        h1 {' + '\n' +
'            color: #10b981;' + '\n' +
'            margin-bottom: 2rem;' + '\n' +
'        }' + '\n' +
'        .stats-grid {' + '\n' +
'            display: grid;' + '\n' +
'            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));' + '\n' +
'            gap: 1rem;' + '\n' +
'            margin-bottom: 2rem;' + '\n' +
'        }' + '\n' +
'        .stat-card {' + '\n' +
'            background: #1e293b;' + '\n' +
'            border: 1px solid #334155;' + '\n' +
'            border-radius: 8px;' + '\n' +
'            padding: 1.5rem;' + '\n' +
'            text-align: center;' + '\n' +
'        }' + '\n' +
'        .stat-value {' + '\n' +
'            font-size: 2rem;' + '\n' +
'            font-weight: bold;' + '\n' +
'            color: #10b981;' + '\n' +
'            margin-bottom: 0.5rem;' + '\n' +
'        }' + '\n' +
'        .stat-label {' + '\n' +
'            color: #94a3b8;' + '\n' +
'            font-size: 0.875rem;' + '\n' +
'        }' + '\n' +
'        .chart-container {' + '\n' +
'            background: #0f172a;' + '\n' +
'            border-radius: 8px;' + '\n' +
'            padding: 1.5rem;' + '\n' +
'            margin-bottom: 1.5rem;' + '\n' +
'            border: 1px solid #334155;' + '\n' +
'        }' + '\n' +
'        canvas {' + '\n' +
'            max-height: 400px;' + '\n' +
'        }' + '\n' +
'        .info {' + '\n' +
'            color: #64748b;' + '\n' +
'            font-size: 0.875rem;' + '\n' +
'            text-align: center;' + '\n' +
'            margin-top: 2rem;' + '\n' +
'            padding: 1rem;' + '\n' +
'        }' + '\n' +
'    </style>' + '\n' +
'</head>' + '\n' +
'<body>' + '\n' +
'    <div class="container">' + '\n' +
'        <h1>' + plantName + '</h1>' + '\n' +
'        <div class="stats-grid" id="stats"></div>' + '\n' +
'        <div class="chart-container">' + '\n' +
'            <canvas id="phChart"></canvas>' + '\n' +
'        </div>' + '\n' +
'        <div class="chart-container">' + '\n' +
'            <canvas id="dosingChart"></canvas>' + '\n' +
'        </div>' + '\n' +
'        <div class="info">' + '\n' +
'            <div>Plant ID: ' + plantId + '</div>' + '\n' +
'            <div>Exported: ' + exportTime + '</div>' + '\n' +
'        </div>' + '\n' +
'    </div>' + '\n' +
'    <script>' + '\n' +
'        var sensorLogs = ' + JSON.stringify(sensorLogs) + ';' + '\n' +
'        var dosingLogs = ' + JSON.stringify(dosingLogs) + ';' + '\n' +
'' + '\n' +
'        // Render stats' + '\n' +
'        var phValues = sensorLogs.map(function(l) { return l.value; });' + '\n' +
'        var avgPh = phValues.length > 0 ? (phValues.reduce(function(a, b) { return a + b; }, 0) / phValues.length).toFixed(2) : "N/A";' + '\n' +
'        var minPh = phValues.length > 0 ? Math.min.apply(Math, phValues).toFixed(2) : "N/A";' + '\n' +
'        var maxPh = phValues.length > 0 ? Math.max.apply(Math, phValues).toFixed(2) : "N/A";' + '\n' +
'        var totalDoses = dosingLogs.length;' + '\n' +
'        var upDoses = dosingLogs.filter(function(l) { return l.dose_type === "up"; }).length;' + '\n' +
'        var downDoses = dosingLogs.filter(function(l) { return l.dose_type === "down"; }).length;' + '\n' +
'' + '\n' +
'        document.getElementById("stats").innerHTML = ' + '\n' +
'            "<div class=\\"stat-card\\"><div class=\\"stat-value\\">" + avgPh + "</div><div class=\\"stat-label\\">Average pH</div></div>" +' + '\n' +
'            "<div class=\\"stat-card\\"><div class=\\"stat-value\\">" + minPh + " - " + maxPh + "</div><div class=\\"stat-label\\">pH Range</div></div>" +' + '\n' +
'            "<div class=\\"stat-card\\"><div class=\\"stat-value\\">" + totalDoses + "</div><div class=\\"stat-label\\">Total Doses</div></div>" +' + '\n' +
'            "<div class=\\"stat-card\\"><div class=\\"stat-value\\">" + upDoses + " / " + downDoses + "</div><div class=\\"stat-label\\">Up / Down Doses</div></div>";' + '\n' +
'' + '\n' +
'        // pH Chart' + '\n' +
'        var phCtx = document.getElementById("phChart").getContext("2d");' + '\n' +
'        new Chart(phCtx, {' + '\n' +
'            type: "line",' + '\n' +
'            data: {' + '\n' +
'                labels: sensorLogs.map(function(l) { return new Date(l.timestamp).toLocaleDateString("en-US", { month: "short", day: "numeric" }); }),' + '\n' +
'                datasets: [{' + '\n' +
'                    label: "pH Level",' + '\n' +
'                    data: sensorLogs.map(function(l) { return l.value; }),' + '\n' +
'                    borderColor: "#10b981",' + '\n' +
'                    backgroundColor: "rgba(16, 185, 129, 0.1)",' + '\n' +
'                    tension: 0.4,' + '\n' +
'                    pointRadius: 2,' + '\n' +
'                    pointHoverRadius: 6' + '\n' +
'                }]' + '\n' +
'            },' + '\n' +
'            options: {' + '\n' +
'                responsive: true,' + '\n' +
'                maintainAspectRatio: true,' + '\n' +
'                plugins: {' + '\n' +
'                    legend: { labels: { color: "#e2e8f0" } },' + '\n' +
'                    title: { display: true, text: "pH History", color: "#e2e8f0", font: { size: 16 } }' + '\n' +
'                },' + '\n' +
'                scales: {' + '\n' +
'                    y: {' + '\n' +
'                        ticks: { color: "#e2e8f0" },' + '\n' +
'                        grid: { color: "#334155" },' + '\n' +
'                        title: { display: true, text: "pH", color: "#e2e8f0" }' + '\n' +
'                    },' + '\n' +
'                    x: {' + '\n' +
'                        ticks: { color: "#e2e8f0", maxRotation: 45, minRotation: 45 },' + '\n' +
'                        grid: { color: "#334155" }' + '\n' +
'                    }' + '\n' +
'                }' + '\n' +
'            }' + '\n' +
'        });' + '\n' +
'' + '\n' +
'        // Dosing Chart' + '\n' +
'        var dosingByDay = {};' + '\n' +
'        dosingLogs.forEach(function(log) {' + '\n' +
'            var dateKey = new Date(log.timestamp).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });' + '\n' +
'            if (!dosingByDay[dateKey]) {' + '\n' +
'                dosingByDay[dateKey] = { up: 0, down: 0, upDoses: [], downDoses: [] };' + '\n' +
'            }' + '\n' +
'            if (log.dose_type === "up") {' + '\n' +
'                dosingByDay[dateKey].up++;' + '\n' +
'                dosingByDay[dateKey].upDoses.push({ time: log.timestamp, amount: log.dose_amount_ml });' + '\n' +
'            } else if (log.dose_type === "down") {' + '\n' +
'                dosingByDay[dateKey].down++;' + '\n' +
'                dosingByDay[dateKey].downDoses.push({ time: log.timestamp, amount: log.dose_amount_ml });' + '\n' +
'            }' + '\n' +
'        });' + '\n' +
'' + '\n' +
'        var sortedDates = Object.keys(dosingByDay).sort(function(a, b) { return new Date(a) - new Date(b); });' + '\n' +
'        var upCounts = sortedDates.map(function(date) { return dosingByDay[date].up; });' + '\n' +
'        var downCounts = sortedDates.map(function(date) { return dosingByDay[date].down; });' + '\n' +
'' + '\n' +
'        var dosingCtx = document.getElementById("dosingChart").getContext("2d");' + '\n' +
'        new Chart(dosingCtx, {' + '\n' +
'            type: "bar",' + '\n' +
'            data: {' + '\n' +
'                labels: sortedDates,' + '\n' +
'                datasets: [' + '\n' +
'                    {' + '\n' +
'                        label: "pH Up Doses",' + '\n' +
'                        data: upCounts,' + '\n' +
'                        backgroundColor: "rgba(59, 130, 246, 0.7)",' + '\n' +
'                        borderColor: "#3b82f6",' + '\n' +
'                        borderWidth: 1,' + '\n' +
'                        barPercentage: 0.9,' + '\n' +
'                        categoryPercentage: 0.3' + '\n' +
'                    },' + '\n' +
'                    {' + '\n' +
'                        label: "pH Down Doses",' + '\n' +
'                        data: downCounts,' + '\n' +
'                        backgroundColor: "rgba(239, 68, 68, 0.7)",' + '\n' +
'                        borderColor: "#ef4444",' + '\n' +
'                        borderWidth: 1,' + '\n' +
'                        barPercentage: 0.9,' + '\n' +
'                        categoryPercentage: 0.3' + '\n' +
'                    }' + '\n' +
'                ]' + '\n' +
'            },' + '\n' +
'            options: {' + '\n' +
'                responsive: true,' + '\n' +
'                maintainAspectRatio: true,' + '\n' +
'                plugins: {' + '\n' +
'                    legend: { labels: { color: "#e2e8f0" } },' + '\n' +
'                    title: { display: true, text: "Daily Dosing Events", color: "#e2e8f0", font: { size: 16 } },' + '\n' +
'                    tooltip: {' + '\n' +
'                        callbacks: {' + '\n' +
'                            afterLabel: function(context) {' + '\n' +
'                                var date = sortedDates[context.dataIndex];' + '\n' +
'                                var isUpDose = context.datasetIndex === 0;' + '\n' +
'                                var doses = isUpDose ? dosingByDay[date].upDoses : dosingByDay[date].downDoses;' + '\n' +
'                                if (doses.length === 0) return "";' + '\n' +
'                                var doseStrings = doses.map(function(dose) {' + '\n' +
'                                    var d = new Date(dose.time);' + '\n' +
'                                    var timeStr = d.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" });' + '\n' +
'                                    return timeStr + " - " + dose.amount.toFixed(2) + " ml";' + '\n' +
'                                });' + '\n' +
'                                return "\\nDoses:\\n" + doseStrings.join("\\n");' + '\n' +
'                            }' + '\n' +
'                        }' + '\n' +
'                    }' + '\n' +
'                },' + '\n' +
'                scales: {' + '\n' +
'                    y: {' + '\n' +
'                        beginAtZero: true,' + '\n' +
'                        ticks: { color: "#e2e8f0", stepSize: 1 },' + '\n' +
'                        grid: { color: "#334155" },' + '\n' +
'                        title: { display: true, text: "Number of Doses", color: "#e2e8f0" }' + '\n' +
'                    },' + '\n' +
'                    x: {' + '\n' +
'                        ticks: { color: "#e2e8f0", maxRotation: 45, minRotation: 45 },' + '\n' +
'                        grid: { color: "#334155" }' + '\n' +
'                    }' + '\n' +
'                }' + '\n' +
'            }' + '\n' +
'        });' + '\n' +
'    <' + '/script>' + '\n' +
'</body>' + '\n' +
'</html>';

            // Download the HTML file
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentPlant.name.replace(/[^a-z0-9]/gi, '_')}_report.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function exportToPDF() {
            if (!currentPlant || !currentLogs) {
                alert('No plant data to export');
                return;
            }

            // Close the menu
            const menu = document.getElementById('plantMenu');
            menu.classList.remove('show');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            const sensorLogs = currentLogs.filter(l => l.event_type === 'sensor');
            const dosingLogs = currentLogs.filter(l => l.event_type === 'dosing');

            // Title
            doc.setFontSize(20);
            doc.setTextColor(16, 185, 129);
            doc.text(currentPlant.name, 14, 20);

            // Plant info
            doc.setFontSize(10);
            doc.setTextColor(100, 116, 139);
            doc.text(`Plant ID: ${currentPlant.plant_id}`, 14, 28);
            doc.text(`Exported: ${new Date().toLocaleString()}`, 14, 33);

            // Stats summary
            const phValues = sensorLogs.map(l => l.value);
            const avgPh = phValues.length > 0 ? (phValues.reduce((a, b) => a + b, 0) / phValues.length).toFixed(2) : 'N/A';
            const minPh = phValues.length > 0 ? Math.min(...phValues).toFixed(2) : 'N/A';
            const maxPh = phValues.length > 0 ? Math.max(...phValues).toFixed(2) : 'N/A';
            const totalDoses = dosingLogs.length;
            const upDoses = dosingLogs.filter(l => l.dose_type === 'up').length;
            const downDoses = dosingLogs.filter(l => l.dose_type === 'down').length;

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('Summary Statistics', 14, 42);
            doc.setFontSize(10);
            doc.text(`Average pH: ${avgPh}`, 14, 48);
            doc.text(`pH Range: ${minPh} - ${maxPh}`, 14, 53);
            doc.text(`Total Doses: ${totalDoses} (Up: ${upDoses}, Down: ${downDoses})`, 14, 58);

            // Create temporary canvas for PDF-optimized charts (white background, black text)
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 800;
            tempCanvas.height = 400;
            const tempCtx = tempCanvas.getContext('2d');

            // pH Chart with PDF-friendly colors
            let yPos = 68;
            if (sensorLogs.length > 0) {
                const tempPhChart = new Chart(tempCtx, {
                    type: 'line',
                    data: {
                        labels: sensorLogs.map(l => formatDateTime(l.timestamp)),
                        datasets: [{
                            label: 'pH Level',
                            data: sensorLogs.map(l => l.value),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            pointRadius: 2
                        }]
                    },
                    options: {
                        responsive: false,
                        animation: false,
                        plugins: {
                            legend: { labels: { color: '#000000', font: { size: 14 } } },
                            title: { display: true, text: 'pH History', color: '#000000', font: { size: 18, weight: 'bold' } }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#000000', font: { size: 12 } },
                                grid: { color: '#cccccc' },
                                title: { display: true, text: 'pH', color: '#000000', font: { size: 14 } }
                            },
                            x: {
                                ticks: { color: '#000000', maxRotation: 45, minRotation: 45, font: { size: 10 } },
                                grid: { color: '#cccccc' }
                            }
                        }
                    }
                });

                const phChartImg = tempCanvas.toDataURL('image/png');
                doc.addImage(phChartImg, 'PNG', 14, yPos, 180, 80);
                tempPhChart.destroy();
                yPos += 85;
            }

            // Add new page if needed
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            }

            // Dosing Chart with PDF-friendly colors
            if (dosingLogs.length > 0) {
                const dosingByDay = {};
                dosingLogs.forEach(log => {
                    const dateKey = formatDate(log.timestamp);
                    if (!dosingByDay[dateKey]) {
                        dosingByDay[dateKey] = { up: 0, down: 0 };
                    }
                    if (log.dose_type === 'up') {
                        dosingByDay[dateKey].up++;
                    } else if (log.dose_type === 'down') {
                        dosingByDay[dateKey].down++;
                    }
                });

                const sortedDates = Object.keys(dosingByDay).sort((a, b) => new Date(a) - new Date(b));
                const upCounts = sortedDates.map(date => dosingByDay[date].up);
                const downCounts = sortedDates.map(date => dosingByDay[date].down);

                const tempDosingChart = new Chart(tempCtx, {
                    type: 'bar',
                    data: {
                        labels: sortedDates,
                        datasets: [
                            {
                                label: 'pH Up Doses',
                                data: upCounts,
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: '#3b82f6',
                                borderWidth: 1,
                                barPercentage: 0.9,
                                categoryPercentage: 0.3
                            },
                            {
                                label: 'pH Down Doses',
                                data: downCounts,
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: '#ef4444',
                                borderWidth: 1,
                                barPercentage: 0.9,
                                categoryPercentage: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: false,
                        animation: false,
                        plugins: {
                            legend: { labels: { color: '#000000', font: { size: 14 } } },
                            title: { display: true, text: 'Daily Dosing Events', color: '#000000', font: { size: 18, weight: 'bold' } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#000000', stepSize: 1, font: { size: 12 } },
                                grid: { color: '#cccccc' },
                                title: { display: true, text: 'Number of Doses', color: '#000000', font: { size: 14 } }
                            },
                            x: {
                                ticks: { color: '#000000', maxRotation: 45, minRotation: 45, font: { size: 10 } },
                                grid: { color: '#cccccc' }
                            }
                        }
                    }
                });

                const dosingChartImg = tempCanvas.toDataURL('image/png');
                doc.addImage(dosingChartImg, 'PNG', 14, yPos, 180, 80);
                tempDosingChart.destroy();
                yPos += 85;
            }

            // Add new page for data tables
            doc.addPage();
            yPos = 20;

            // pH Readings Table
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('pH Readings', 14, yPos);
            yPos += 5;

            const phTableData = sensorLogs.map(log => [
                new Date(log.timestamp).toLocaleString(),
                log.value.toFixed(2)
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['Timestamp', 'pH Value']],
                body: phTableData,
                theme: 'grid',
                headStyles: { fillColor: [16, 185, 129] },
                styles: { fontSize: 8 },
                margin: { left: 14 }
            });

            yPos = doc.lastAutoTable.finalY + 10;

            // Dosing Events Table
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(12);
            doc.text('Dosing Events', 14, yPos);
            yPos += 5;

            const dosingTableData = dosingLogs.map(log => [
                new Date(log.timestamp).toLocaleString(),
                log.dose_type === 'up' ? 'pH Up' : 'pH Down',
                log.dose_amount_ml.toFixed(2) + ' ml',
                log.value ? log.value.toFixed(2) : 'N/A'
            ]);

            doc.autoTable({
                startY: yPos,
                head: [['Timestamp', 'Type', 'Amount', 'pH at Dose']],
                body: dosingTableData,
                theme: 'grid',
                headStyles: { fillColor: [16, 185, 129] },
                styles: { fontSize: 8 },
                margin: { left: 14 }
            });

            // Save the PDF
            doc.save(`${currentPlant.name.replace(/[^a-z0-9]/gi, '_')}_report.pdf`);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function calculateAge(startDate, endDate) {
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date();
            const days = Math.floor((end - start) / (1000 * 60 * 60 * 24));
            return `${days} days`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', loadPlants);

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('plantModal');
            if (event.target === modal) {
                closePlantModal();
            }
        }

        // Load plants and check user role on page load
        checkUserRole();
        loadPlants();
    </script>
</body>
</html>
