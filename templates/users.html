<!-- templates/users.html - Users management page -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Users</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>Users</h1>
    <a href="/auth/logout">Logout</a>
    <h2>Add New User</h2>
    <form id="add-user-form">
        <label for="email">Email:</label>
        <input type="email" id="email" required>
        <br>
        <label for="password">Password:</label>
        <input type="password" id="password" required>
        <br>
        <label for="is_admin">Is Admin:</label>
        <input type="checkbox" id="is_admin">
        <br>
        <button type="submit">Add User</button>
    </form>
    <h2>All Users</h2>
    <table>
        <thead>
            <tr>
                <th>Email</th>
                <th>Admin</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
                <tr>
                    <td>{{ user.email }}</td>
                    <td>{{ user.is_superuser }}</td>
                    <td>{{ user.is_active }}</td>
                    <td>
                        <button onclick="deleteUser('{{ user.id }}')">Delete</button>
                        <button onclick="resetPassword('{{ user.id }}')">Reset Password</button>
                        {% if user.is_active %}
                            <button onclick="suspendUser('{{ user.id }}')">Suspend</button>
                        {% else %}
                            <button onclick="unsuspendUser('{{ user.id }}')">Unsuspend</button>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        document.getElementById('add-user-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const is_admin = document.getElementById('is_admin').checked;
            const response = await fetch('/admin/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    password: password,
                    is_superuser: is_admin
                }),
            });
            if (response.ok) {
                alert('User added successfully');
                location.reload();  // Reload to update the list
            } else {
                alert('Failed to add user');
            }
        });

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                const response = await fetch('/admin/users/' + userId, {
                    method: 'DELETE',
                });
                if (response.ok) {
                    alert('User deleted successfully');
                    location.reload();
                } else {
                    alert('Failed to delete user');
                }
            }
        }

        async function resetPassword(userId) {
            const newPassword = prompt('Enter new password:');
            if (newPassword) {
                const response = await fetch('/admin/users/' + userId + '/reset-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ password: newPassword }),
                });
                if (response.ok) {
                    alert('Password reset successfully');
                } else {
                    alert('Failed to reset password');
                }
            }
        }

        async function suspendUser(userId) {
            if (confirm('Are you sure you want to suspend this user?')) {
                const response = await fetch('/admin/users/' + userId + '/suspend', {
                    method: 'POST',
                });
                if (response.ok) {
                    alert('User suspended successfully');
                    location.reload();
                } else {
                    alert('Failed to suspend user');
                }
            }
        }

        async function unsuspendUser(userId) {
            if (confirm('Are you sure you want to unsuspend this user?')) {
                const response = await fetch('/admin/users/' + userId + '/unsuspend', {
                    method: 'POST',
                });
                if (response.ok) {
                    alert('User unsuspended successfully');
                    location.reload();
                } else {
                    alert('Failed to unsuspend user');
                }
            }
        }

        window.onpageshow = function(evt) {
            if (evt.persisted) {
                window.location.reload();
            }
        };
    </script>
</body>
</html>